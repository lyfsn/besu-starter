<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CodeV0.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.evm.code</a> &gt; <span class="el_source">CodeV0.java</span></div><h1>CodeV0.java</h1><pre class="source lang-java linenums">/*
 * Copyright contributors to Hyperledger Besu
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 */

package org.hyperledger.besu.evm.code;

import org.hyperledger.besu.datatypes.Hash;
import org.hyperledger.besu.evm.Code;
import org.hyperledger.besu.evm.operation.JumpDestOperation;

import java.util.function.Supplier;

import com.google.common.base.MoreObjects;
import com.google.common.base.Suppliers;
import org.apache.tuweni.bytes.Bytes;

/** The CodeV0. */
public class CodeV0 implements Code {

  /** The constant EMPTY_CODE. */
<span class="fc" id="L33">  public static final CodeV0 EMPTY_CODE = new CodeV0(Bytes.EMPTY);</span>

  /** The bytes representing the code. */
  private final Bytes bytes;

  /** The hash of the code, needed for accessing metadata about the bytecode */
  private final Supplier&lt;Hash&gt; codeHash;

  /** Used to cache valid jump destinations. */
  private long[] validJumpDestinations;

  /** Code section info for the legacy code */
  private final CodeSection codeSectionZero;

  /**
   * Public constructor.
   *
   * @param bytes The byte representation of the code.
   */
<span class="fc" id="L52">  CodeV0(final Bytes bytes) {</span>
<span class="fc" id="L53">    this.bytes = bytes;</span>
<span class="fc" id="L54">    this.codeHash = Suppliers.memoize(() -&gt; Hash.hash(bytes));</span>
<span class="fc" id="L55">    this.codeSectionZero = new CodeSection(bytes.size(), 0, -1, -1, 0);</span>
<span class="fc" id="L56">  }</span>

  /**
   * Returns true if the object is equal to this; otherwise false.
   *
   * @param other The object to compare this with.
   * @return True if the object is equal to this; otherwise false.
   */
  @Override
  public boolean equals(final Object other) {
<span class="nc bnc" id="L66" title="All 2 branches missed.">    if (other == null) return false;</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">    if (other == this) return true;</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">    if (!(other instanceof CodeV0)) return false;</span>

<span class="nc" id="L70">    final CodeV0 that = (CodeV0) other;</span>
<span class="nc" id="L71">    return this.bytes.equals(that.bytes);</span>
  }

  @Override
  public int hashCode() {
<span class="nc" id="L76">    return bytes.hashCode();</span>
  }

  /**
   * Size of the Code, in bytes
   *
   * @return The number of bytes in the code.
   */
  @Override
  public int getSize() {
<span class="fc" id="L86">    return bytes.size();</span>
  }

  @Override
  public Bytes getBytes() {
<span class="fc" id="L91">    return bytes;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L96">    return MoreObjects.toStringHelper(this).add(&quot;bytes&quot;, bytes).toString();</span>
  }

  @Override
  public Hash getCodeHash() {
<span class="fc" id="L101">    return codeHash.get();</span>
  }

  @Override
  public boolean isJumpDestInvalid(final int jumpDestination) {
<span class="fc bfc" id="L106" title="All 4 branches covered.">    if (jumpDestination &lt; 0 || jumpDestination &gt;= getSize()) {</span>
<span class="fc" id="L107">      return true;</span>
    }
<span class="pc bpc" id="L109" title="1 of 4 branches missed.">    if (validJumpDestinations == null || validJumpDestinations.length == 0) {</span>
<span class="fc" id="L110">      validJumpDestinations = calculateJumpDests();</span>
    }

<span class="fc" id="L113">    final long targetLong = validJumpDestinations[jumpDestination &gt;&gt;&gt; 6];</span>
<span class="fc" id="L114">    final long targetBit = 1L &lt;&lt; (jumpDestination &amp; 0x3F);</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">    return (targetLong &amp; targetBit) == 0L;</span>
  }

  @Override
  public boolean isValid() {
<span class="fc" id="L120">    return true;</span>
  }

  @Override
  public CodeSection getCodeSection(final int section) {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">    if (section == 0) {</span>
<span class="fc" id="L126">      return codeSectionZero;</span>
    } else {
<span class="nc" id="L128">      return null;</span>
    }
  }

  @Override
  public int getCodeSectionCount() {
<span class="nc" id="L134">    return 1;</span>
  }

  @Override
  public int getEofVersion() {
<span class="fc" id="L139">    return 0;</span>
  }

  /**
   * Calculate jump destination.
   *
   * @return the long [ ]
   */
  long[] calculateJumpDests() {
<span class="fc" id="L148">    final int size = getSize();</span>
<span class="fc" id="L149">    final long[] bitmap = new long[(size &gt;&gt; 6) + 1];</span>
<span class="fc" id="L150">    final byte[] rawCode = bytes.toArrayUnsafe();</span>
<span class="fc" id="L151">    final int length = rawCode.length;</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">    for (int i = 0; i &lt; length; ) {</span>
<span class="fc" id="L153">      long thisEntry = 0L;</span>
<span class="fc" id="L154">      final int entryPos = i &gt;&gt; 6;</span>
<span class="fc" id="L155">      final int max = Math.min(64, length - (entryPos &lt;&lt; 6));</span>
<span class="fc" id="L156">      int j = i &amp; 0x3F;</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">      for (; j &lt; max; i++, j++) {</span>
<span class="fc" id="L158">        final byte operationNum = rawCode[i];</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        if (operationNum &gt;= JumpDestOperation.OPCODE) {</span>
<span class="fc bfc" id="L160" title="All 34 branches covered.">          switch (operationNum) {</span>
            case JumpDestOperation.OPCODE:
<span class="fc" id="L162">              thisEntry |= 1L &lt;&lt; j;</span>
<span class="fc" id="L163">              break;</span>
            case 0x60:
<span class="fc" id="L165">              i += 1;</span>
<span class="fc" id="L166">              j += 1;</span>
<span class="fc" id="L167">              break;</span>
            case 0x61:
<span class="fc" id="L169">              i += 2;</span>
<span class="fc" id="L170">              j += 2;</span>
<span class="fc" id="L171">              break;</span>
            case 0x62:
<span class="fc" id="L173">              i += 3;</span>
<span class="fc" id="L174">              j += 3;</span>
<span class="fc" id="L175">              break;</span>
            case 0x63:
<span class="fc" id="L177">              i += 4;</span>
<span class="fc" id="L178">              j += 4;</span>
<span class="fc" id="L179">              break;</span>
            case 0x64:
<span class="fc" id="L181">              i += 5;</span>
<span class="fc" id="L182">              j += 5;</span>
<span class="fc" id="L183">              break;</span>
            case 0x65:
<span class="fc" id="L185">              i += 6;</span>
<span class="fc" id="L186">              j += 6;</span>
<span class="fc" id="L187">              break;</span>
            case 0x66:
<span class="fc" id="L189">              i += 7;</span>
<span class="fc" id="L190">              j += 7;</span>
<span class="fc" id="L191">              break;</span>
            case 0x67:
<span class="fc" id="L193">              i += 8;</span>
<span class="fc" id="L194">              j += 8;</span>
<span class="fc" id="L195">              break;</span>
            case 0x68:
<span class="fc" id="L197">              i += 9;</span>
<span class="fc" id="L198">              j += 9;</span>
<span class="fc" id="L199">              break;</span>
            case 0x69:
<span class="fc" id="L201">              i += 10;</span>
<span class="fc" id="L202">              j += 10;</span>
<span class="fc" id="L203">              break;</span>
            case 0x6a:
<span class="fc" id="L205">              i += 11;</span>
<span class="fc" id="L206">              j += 11;</span>
<span class="fc" id="L207">              break;</span>
            case 0x6b:
<span class="fc" id="L209">              i += 12;</span>
<span class="fc" id="L210">              j += 12;</span>
<span class="fc" id="L211">              break;</span>
            case 0x6c:
<span class="fc" id="L213">              i += 13;</span>
<span class="fc" id="L214">              j += 13;</span>
<span class="fc" id="L215">              break;</span>
            case 0x6d:
<span class="fc" id="L217">              i += 14;</span>
<span class="fc" id="L218">              j += 14;</span>
<span class="fc" id="L219">              break;</span>
            case 0x6e:
<span class="fc" id="L221">              i += 15;</span>
<span class="fc" id="L222">              j += 15;</span>
<span class="fc" id="L223">              break;</span>
            case 0x6f:
<span class="fc" id="L225">              i += 16;</span>
<span class="fc" id="L226">              j += 16;</span>
<span class="fc" id="L227">              break;</span>
            case 0x70:
<span class="fc" id="L229">              i += 17;</span>
<span class="fc" id="L230">              j += 17;</span>
<span class="fc" id="L231">              break;</span>
            case 0x71:
<span class="fc" id="L233">              i += 18;</span>
<span class="fc" id="L234">              j += 18;</span>
<span class="fc" id="L235">              break;</span>
            case 0x72:
<span class="fc" id="L237">              i += 19;</span>
<span class="fc" id="L238">              j += 19;</span>
<span class="fc" id="L239">              break;</span>
            case 0x73:
<span class="fc" id="L241">              i += 20;</span>
<span class="fc" id="L242">              j += 20;</span>
<span class="fc" id="L243">              break;</span>
            case 0x74:
<span class="fc" id="L245">              i += 21;</span>
<span class="fc" id="L246">              j += 21;</span>
<span class="fc" id="L247">              break;</span>
            case 0x75:
<span class="fc" id="L249">              i += 22;</span>
<span class="fc" id="L250">              j += 22;</span>
<span class="fc" id="L251">              break;</span>
            case 0x76:
<span class="fc" id="L253">              i += 23;</span>
<span class="fc" id="L254">              j += 23;</span>
<span class="fc" id="L255">              break;</span>
            case 0x77:
<span class="fc" id="L257">              i += 24;</span>
<span class="fc" id="L258">              j += 24;</span>
<span class="fc" id="L259">              break;</span>
            case 0x78:
<span class="fc" id="L261">              i += 25;</span>
<span class="fc" id="L262">              j += 25;</span>
<span class="fc" id="L263">              break;</span>
            case 0x79:
<span class="fc" id="L265">              i += 26;</span>
<span class="fc" id="L266">              j += 26;</span>
<span class="fc" id="L267">              break;</span>
            case 0x7a:
<span class="fc" id="L269">              i += 27;</span>
<span class="fc" id="L270">              j += 27;</span>
<span class="fc" id="L271">              break;</span>
            case 0x7b:
<span class="fc" id="L273">              i += 28;</span>
<span class="fc" id="L274">              j += 28;</span>
<span class="fc" id="L275">              break;</span>
            case 0x7c:
<span class="fc" id="L277">              i += 29;</span>
<span class="fc" id="L278">              j += 29;</span>
<span class="fc" id="L279">              break;</span>
            case 0x7d:
<span class="fc" id="L281">              i += 30;</span>
<span class="fc" id="L282">              j += 30;</span>
<span class="fc" id="L283">              break;</span>
            case 0x7e:
<span class="fc" id="L285">              i += 31;</span>
<span class="fc" id="L286">              j += 31;</span>
<span class="fc" id="L287">              break;</span>
            case 0x7f:
<span class="fc" id="L289">              i += 32;</span>
<span class="fc" id="L290">              j += 32;</span>
<span class="fc" id="L291">              break;</span>
            default:
          }
        }
      }
<span class="fc" id="L296">      bitmap[entryPos] = thisEntry;</span>
<span class="fc" id="L297">    }</span>
<span class="fc" id="L298">    return bitmap;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>