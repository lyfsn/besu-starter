<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SynchronizerConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.eth.sync</a> &gt; <span class="el_source">SynchronizerConfiguration.java</span></div><h1>SynchronizerConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.eth.sync;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;

import org.hyperledger.besu.ethereum.eth.sync.snapsync.SnapSyncConfiguration;
import org.hyperledger.besu.services.tasks.CachingTaskCollection;

import java.util.concurrent.TimeUnit;

import com.google.common.collect.Range;
import org.apache.tuweni.units.bigints.UInt256;

public class SynchronizerConfiguration {

  public static final int DEFAULT_PIVOT_DISTANCE_FROM_HEAD = 50;
  public static final float DEFAULT_FULL_VALIDATION_RATE = .1f;
  public static final int DEFAULT_FAST_SYNC_MINIMUM_PEERS = 5;
  public static final int DEFAULT_WORLD_STATE_HASH_COUNT_PER_REQUEST = 384;
  public static final int DEFAULT_WORLD_STATE_REQUEST_PARALLELISM = 10;
  public static final int DEFAULT_WORLD_STATE_MAX_REQUESTS_WITHOUT_PROGRESS = 1000;
<span class="fc" id="L36">  public static final long DEFAULT_WORLD_STATE_MIN_MILLIS_BEFORE_STALLING =</span>
<span class="fc" id="L37">      TimeUnit.MINUTES.toMillis(5);</span>
<span class="fc" id="L38">  public static final Range&lt;Long&gt; DEFAULT_BLOCK_PROPAGATION_RANGE = Range.closed(-10L, 30L);</span>
  public static final long DEFAULT_DOWNLOADER_CHANGE_TARGET_THRESHOLD_BY_HEIGHT = 200L;
<span class="fc" id="L40">  public static final UInt256 DEFAULT_DOWNLOADER_CHANGE_TARGET_THRESHOLD_BY_TD =</span>
<span class="fc" id="L41">      UInt256.valueOf(1_000_000_000_000_000_000L);</span>
  public static final int DEFAULT_DOWNLOADER_HEADER_REQUEST_SIZE = 200;
  public static final int DEFAULT_DOWNLOADER_CHECKPOINT_TIMEOUTS_PERMITTED = 5;
  public static final int DEFAULT_DOWNLOADER_CHAIN_SEGMENT_SIZE = 200;
  public static final int DEFAULT_DOWNLOADER_PARALLELISM = 4;
  public static final int DEFAULT_TRANSACTIONS_PARALLELISM = 4;
  public static final int DEFAULT_COMPUTATION_PARALLELISM = 2;
  public static final int DEFAULT_WORLD_STATE_TASK_CACHE_SIZE =
      CachingTaskCollection.DEFAULT_CACHE_SIZE;
<span class="fc" id="L50">  public static final long DEFAULT_PROPAGATION_MANAGER_GET_BLOCK_TIMEOUT_MILLIS =</span>
<span class="fc" id="L51">      TimeUnit.SECONDS.toMillis(60);</span>

  public static final boolean DEFAULT_CHECKPOINT_POST_MERGE_ENABLED = false;

  // Fast sync config
  private final int fastSyncPivotDistance;
  private final float fastSyncFullValidationRate;
  private final int fastSyncMinimumPeerCount;
  private final int worldStateHashCountPerRequest;
  private final int worldStateRequestParallelism;
  private final int worldStateMaxRequestsWithoutProgress;
  private final int worldStateTaskCacheSize;

  // Snapsync
  private final SnapSyncConfiguration snapSyncConfiguration;

  // Block propagation config
  private final Range&lt;Long&gt; blockPropagationRange;

  // General config
  private final SyncMode syncMode;

  // Near head Checkpoint sync
  private final boolean checkpointPostMergeEnabled;

  // Downloader config
  private final long downloaderChangeTargetThresholdByHeight;
  private final UInt256 downloaderChangeTargetThresholdByTd;
  private final int downloaderHeaderRequestSize;
  private final int downloaderCheckpointTimeoutsPermitted;
  private final int downloaderChainSegmentSize;
  private final int downloaderParallelism;
  private final int transactionsParallelism;
  private final int computationParallelism;
  private final int maxTrailingPeers;
  private final long worldStateMinMillisBeforeStalling;
  private final long propagationManagerGetBlockTimeoutMillis;

  private SynchronizerConfiguration(
      final int fastSyncPivotDistance,
      final float fastSyncFullValidationRate,
      final int fastSyncMinimumPeerCount,
      final int worldStateHashCountPerRequest,
      final int worldStateRequestParallelism,
      final int worldStateMaxRequestsWithoutProgress,
      final long worldStateMinMillisBeforeStalling,
      final int worldStateTaskCacheSize,
      final SnapSyncConfiguration snapSyncConfiguration,
      final Range&lt;Long&gt; blockPropagationRange,
      final SyncMode syncMode,
      final long downloaderChangeTargetThresholdByHeight,
      final UInt256 downloaderChangeTargetThresholdByTd,
      final int downloaderHeaderRequestSize,
      final int downloaderCheckpointTimeoutsPermitted,
      final int downloaderChainSegmentSize,
      final int downloaderParallelism,
      final int transactionsParallelism,
      final int computationParallelism,
      final int maxTrailingPeers,
      final long propagationManagerGetBlockTimeoutMillis,
<span class="fc" id="L111">      final boolean checkpointPostMergeEnabled) {</span>
<span class="fc" id="L112">    this.fastSyncPivotDistance = fastSyncPivotDistance;</span>
<span class="fc" id="L113">    this.fastSyncFullValidationRate = fastSyncFullValidationRate;</span>
<span class="fc" id="L114">    this.fastSyncMinimumPeerCount = fastSyncMinimumPeerCount;</span>
<span class="fc" id="L115">    this.worldStateHashCountPerRequest = worldStateHashCountPerRequest;</span>
<span class="fc" id="L116">    this.worldStateRequestParallelism = worldStateRequestParallelism;</span>
<span class="fc" id="L117">    this.worldStateMaxRequestsWithoutProgress = worldStateMaxRequestsWithoutProgress;</span>
<span class="fc" id="L118">    this.worldStateMinMillisBeforeStalling = worldStateMinMillisBeforeStalling;</span>
<span class="fc" id="L119">    this.worldStateTaskCacheSize = worldStateTaskCacheSize;</span>
<span class="fc" id="L120">    this.snapSyncConfiguration = snapSyncConfiguration;</span>
<span class="fc" id="L121">    this.blockPropagationRange = blockPropagationRange;</span>
<span class="fc" id="L122">    this.syncMode = syncMode;</span>
<span class="fc" id="L123">    this.downloaderChangeTargetThresholdByHeight = downloaderChangeTargetThresholdByHeight;</span>
<span class="fc" id="L124">    this.downloaderChangeTargetThresholdByTd = downloaderChangeTargetThresholdByTd;</span>
<span class="fc" id="L125">    this.downloaderHeaderRequestSize = downloaderHeaderRequestSize;</span>
<span class="fc" id="L126">    this.downloaderCheckpointTimeoutsPermitted = downloaderCheckpointTimeoutsPermitted;</span>
<span class="fc" id="L127">    this.downloaderChainSegmentSize = downloaderChainSegmentSize;</span>
<span class="fc" id="L128">    this.downloaderParallelism = downloaderParallelism;</span>
<span class="fc" id="L129">    this.transactionsParallelism = transactionsParallelism;</span>
<span class="fc" id="L130">    this.computationParallelism = computationParallelism;</span>
<span class="fc" id="L131">    this.maxTrailingPeers = maxTrailingPeers;</span>
<span class="fc" id="L132">    this.propagationManagerGetBlockTimeoutMillis = propagationManagerGetBlockTimeoutMillis;</span>
<span class="fc" id="L133">    this.checkpointPostMergeEnabled = checkpointPostMergeEnabled;</span>
<span class="fc" id="L134">  }</span>

  public static Builder builder() {
<span class="fc" id="L137">    return new Builder();</span>
  }

  /**
   * The actual sync mode to be used.
   *
   * @return the sync mode
   */
  public SyncMode getSyncMode() {
<span class="fc" id="L146">    return syncMode;</span>
  }

  public boolean isCheckpointPostMergeEnabled() {
<span class="fc" id="L150">    return checkpointPostMergeEnabled;</span>
  }

  /**
   * All the configuration related to snapsync
   *
   * @return snapsync configuration
   */
  public SnapSyncConfiguration getSnapSyncConfiguration() {
<span class="fc" id="L159">    return snapSyncConfiguration;</span>
  }

  /**
   * The range of block numbers (relative to the current chain head and the best network block) that
   * are considered appropriate to import as new blocks are announced on the network.
   *
   * @return the range of blocks considered valid to import from the network, relative to the
   *     current chain head.
   */
  public Range&lt;Long&gt; getBlockPropagationRange() {
<span class="fc" id="L170">    return blockPropagationRange;</span>
  }

  /**
   * The distance from the chain head at which we should switch from fast sync to full sync.
   *
   * @return distance from the chain head at which we should switch from fast sync to full sync.
   */
  public int getFastSyncPivotDistance() {
<span class="fc" id="L179">    return fastSyncPivotDistance;</span>
  }

  public long getDownloaderChangeTargetThresholdByHeight() {
<span class="fc" id="L183">    return downloaderChangeTargetThresholdByHeight;</span>
  }

  public UInt256 getDownloaderChangeTargetThresholdByTd() {
<span class="fc" id="L187">    return downloaderChangeTargetThresholdByTd;</span>
  }

  public int getDownloaderHeaderRequestSize() {
<span class="fc" id="L191">    return downloaderHeaderRequestSize;</span>
  }

  public int getDownloaderCheckpointTimeoutsPermitted() {
<span class="fc" id="L195">    return downloaderCheckpointTimeoutsPermitted;</span>
  }

  public int getDownloaderChainSegmentSize() {
<span class="fc" id="L199">    return downloaderChainSegmentSize;</span>
  }

  public int getDownloaderParallelism() {
<span class="fc" id="L203">    return downloaderParallelism;</span>
  }

  public int getTransactionsParallelism() {
<span class="fc" id="L207">    return transactionsParallelism;</span>
  }

  public int getComputationParallelism() {
<span class="fc" id="L211">    return computationParallelism;</span>
  }

  /**
   * The rate at which blocks should be fully validated during fast sync. At a rate of 1f, all
   * blocks are fully validated. At rates less than 1f, a subset of blocks will undergo light-weight
   * validation.
   *
   * @return rate at which blocks should be fully validated during fast sync.
   */
  public float getFastSyncFullValidationRate() {
<span class="fc" id="L222">    return fastSyncFullValidationRate;</span>
  }

  public int getFastSyncMinimumPeerCount() {
<span class="fc" id="L226">    return fastSyncMinimumPeerCount;</span>
  }

  public int getWorldStateHashCountPerRequest() {
<span class="fc" id="L230">    return worldStateHashCountPerRequest;</span>
  }

  public int getWorldStateRequestParallelism() {
<span class="fc" id="L234">    return worldStateRequestParallelism;</span>
  }

  public int getWorldStateMaxRequestsWithoutProgress() {
<span class="fc" id="L238">    return worldStateMaxRequestsWithoutProgress;</span>
  }

  public long getWorldStateMinMillisBeforeStalling() {
<span class="fc" id="L242">    return worldStateMinMillisBeforeStalling;</span>
  }

  public int getWorldStateTaskCacheSize() {
<span class="fc" id="L246">    return worldStateTaskCacheSize;</span>
  }

  public int getMaxTrailingPeers() {
<span class="fc" id="L250">    return maxTrailingPeers;</span>
  }

  public long getPropagationManagerGetBlockTimeoutMillis() {
<span class="fc" id="L254">    return propagationManagerGetBlockTimeoutMillis;</span>
  }

<span class="fc" id="L257">  public static class Builder {</span>
<span class="fc" id="L258">    private SyncMode syncMode = SyncMode.FULL;</span>
<span class="fc" id="L259">    private int fastSyncMinimumPeerCount = DEFAULT_FAST_SYNC_MINIMUM_PEERS;</span>
<span class="fc" id="L260">    private int maxTrailingPeers = Integer.MAX_VALUE;</span>
<span class="fc" id="L261">    private Range&lt;Long&gt; blockPropagationRange = DEFAULT_BLOCK_PROPAGATION_RANGE;</span>
<span class="fc" id="L262">    private long downloaderChangeTargetThresholdByHeight =</span>
        DEFAULT_DOWNLOADER_CHANGE_TARGET_THRESHOLD_BY_HEIGHT;
<span class="fc" id="L264">    private UInt256 downloaderChangeTargetThresholdByTd =</span>
        DEFAULT_DOWNLOADER_CHANGE_TARGET_THRESHOLD_BY_TD;
<span class="fc" id="L266">    private int downloaderHeaderRequestSize = DEFAULT_DOWNLOADER_HEADER_REQUEST_SIZE;</span>
<span class="fc" id="L267">    private int downloaderCheckpointTimeoutsPermitted =</span>
        DEFAULT_DOWNLOADER_CHECKPOINT_TIMEOUTS_PERMITTED;
<span class="fc" id="L269">    private SnapSyncConfiguration snapSyncConfiguration = SnapSyncConfiguration.getDefault();</span>
<span class="fc" id="L270">    private int downloaderChainSegmentSize = DEFAULT_DOWNLOADER_CHAIN_SEGMENT_SIZE;</span>
<span class="fc" id="L271">    private int downloaderParallelism = DEFAULT_DOWNLOADER_PARALLELISM;</span>
<span class="fc" id="L272">    private int transactionsParallelism = DEFAULT_TRANSACTIONS_PARALLELISM;</span>
<span class="fc" id="L273">    private int computationParallelism = DEFAULT_COMPUTATION_PARALLELISM;</span>
<span class="fc" id="L274">    private int fastSyncPivotDistance = DEFAULT_PIVOT_DISTANCE_FROM_HEAD;</span>
<span class="fc" id="L275">    private float fastSyncFullValidationRate = DEFAULT_FULL_VALIDATION_RATE;</span>
<span class="fc" id="L276">    private int worldStateHashCountPerRequest = DEFAULT_WORLD_STATE_HASH_COUNT_PER_REQUEST;</span>
<span class="fc" id="L277">    private int worldStateRequestParallelism = DEFAULT_WORLD_STATE_REQUEST_PARALLELISM;</span>
<span class="fc" id="L278">    private int worldStateMaxRequestsWithoutProgress =</span>
        DEFAULT_WORLD_STATE_MAX_REQUESTS_WITHOUT_PROGRESS;
<span class="fc" id="L280">    private long worldStateMinMillisBeforeStalling = DEFAULT_WORLD_STATE_MIN_MILLIS_BEFORE_STALLING;</span>
<span class="fc" id="L281">    private int worldStateTaskCacheSize = DEFAULT_WORLD_STATE_TASK_CACHE_SIZE;</span>

<span class="fc" id="L283">    private long propagationManagerGetBlockTimeoutMillis =</span>
        DEFAULT_PROPAGATION_MANAGER_GET_BLOCK_TIMEOUT_MILLIS;
<span class="fc" id="L285">    private boolean checkpointPostMergeEnabled = DEFAULT_CHECKPOINT_POST_MERGE_ENABLED;</span>

    public Builder fastSyncPivotDistance(final int distance) {
<span class="fc" id="L288">      fastSyncPivotDistance = distance;</span>
<span class="fc" id="L289">      return this;</span>
    }

    public Builder fastSyncFullValidationRate(final float rate) {
<span class="fc" id="L293">      this.fastSyncFullValidationRate = rate;</span>
<span class="fc" id="L294">      return this;</span>
    }

    public Builder snapSyncConfiguration(final SnapSyncConfiguration snapSyncConfiguration) {
<span class="fc" id="L298">      this.snapSyncConfiguration = snapSyncConfiguration;</span>
<span class="fc" id="L299">      return this;</span>
    }

    public Builder syncMode(final SyncMode mode) {
<span class="fc" id="L303">      this.syncMode = mode;</span>
<span class="fc" id="L304">      return this;</span>
    }

    public Builder blockPropagationRange(final Range&lt;Long&gt; blockPropagationRange) {
<span class="fc" id="L308">      checkNotNull(blockPropagationRange);</span>
<span class="fc" id="L309">      this.blockPropagationRange = blockPropagationRange;</span>
<span class="fc" id="L310">      return this;</span>
    }

    public Builder downloaderChangeTargetThresholdByHeight(
        final long downloaderChangeTargetThresholdByHeight) {
<span class="fc" id="L315">      this.downloaderChangeTargetThresholdByHeight = downloaderChangeTargetThresholdByHeight;</span>
<span class="fc" id="L316">      return this;</span>
    }

    public Builder downloaderChangeTargetThresholdByTd(
        final UInt256 downloaderChangeTargetThresholdByTd) {
<span class="fc" id="L321">      this.downloaderChangeTargetThresholdByTd = downloaderChangeTargetThresholdByTd;</span>
<span class="fc" id="L322">      return this;</span>
    }

    public Builder downloaderHeadersRequestSize(final int downloaderHeaderRequestSize) {
<span class="fc" id="L326">      this.downloaderHeaderRequestSize = downloaderHeaderRequestSize;</span>
<span class="fc" id="L327">      return this;</span>
    }

    public Builder downloaderCheckpointTimeoutsPermitted(
        final int downloaderCheckpointTimeoutsPermitted) {
<span class="fc" id="L332">      this.downloaderCheckpointTimeoutsPermitted = downloaderCheckpointTimeoutsPermitted;</span>
<span class="fc" id="L333">      return this;</span>
    }

    public Builder downloaderChainSegmentSize(final int downloaderChainSegmentSize) {
<span class="fc" id="L337">      this.downloaderChainSegmentSize = downloaderChainSegmentSize;</span>
<span class="fc" id="L338">      return this;</span>
    }

    public Builder blockPropagationRange(final long min, final long max) {
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">      checkArgument(min &lt; max, &quot;Invalid range: min must be less than max.&quot;);</span>
<span class="fc" id="L343">      blockPropagationRange = Range.closed(min, max);</span>
<span class="fc" id="L344">      return this;</span>
    }

    public Builder downloaderParallelism(final int downloaderParallelism) {
<span class="fc" id="L348">      this.downloaderParallelism = downloaderParallelism;</span>
<span class="fc" id="L349">      return this;</span>
    }

    public Builder transactionsParallelism(final int transactionsParallelism) {
<span class="fc" id="L353">      this.transactionsParallelism = transactionsParallelism;</span>
<span class="fc" id="L354">      return this;</span>
    }

    public Builder computationParallelism(final int computationParallelism) {
<span class="fc" id="L358">      this.computationParallelism = computationParallelism;</span>
<span class="fc" id="L359">      return this;</span>
    }

    public Builder fastSyncMinimumPeerCount(final int fastSyncMinimumPeerCount) {
<span class="fc" id="L363">      this.fastSyncMinimumPeerCount = fastSyncMinimumPeerCount;</span>
<span class="fc" id="L364">      return this;</span>
    }

    public Builder worldStateHashCountPerRequest(final int worldStateHashCountPerRequest) {
<span class="fc" id="L368">      this.worldStateHashCountPerRequest = worldStateHashCountPerRequest;</span>
<span class="fc" id="L369">      return this;</span>
    }

    public Builder worldStateRequestParallelism(final int worldStateRequestParallelism) {
<span class="fc" id="L373">      this.worldStateRequestParallelism = worldStateRequestParallelism;</span>
<span class="fc" id="L374">      return this;</span>
    }

    public Builder worldStateMaxRequestsWithoutProgress(
        final int worldStateMaxRequestsWithoutProgress) {
<span class="fc" id="L379">      this.worldStateMaxRequestsWithoutProgress = worldStateMaxRequestsWithoutProgress;</span>
<span class="fc" id="L380">      return this;</span>
    }

    public Builder worldStateMinMillisBeforeStalling(final long worldStateMinMillisBeforeStalling) {
<span class="fc" id="L384">      this.worldStateMinMillisBeforeStalling = worldStateMinMillisBeforeStalling;</span>
<span class="fc" id="L385">      return this;</span>
    }

    public Builder worldStateTaskCacheSize(final int worldStateTaskCacheSize) {
<span class="fc" id="L389">      this.worldStateTaskCacheSize = worldStateTaskCacheSize;</span>
<span class="fc" id="L390">      return this;</span>
    }

    public Builder maxTrailingPeers(final int maxTailingPeers) {
<span class="fc" id="L394">      this.maxTrailingPeers = maxTailingPeers;</span>
<span class="fc" id="L395">      return this;</span>
    }

    public Builder propagationManagerGetBlockTimeoutMillis(
        final long propagationManagerGetBlockTimeoutMillis) {
<span class="nc" id="L400">      this.propagationManagerGetBlockTimeoutMillis = propagationManagerGetBlockTimeoutMillis;</span>
<span class="nc" id="L401">      return this;</span>
    }

    public Builder checkpointPostMergeEnabled(final boolean checkpointPostMergeEnabled) {
<span class="fc" id="L405">      this.checkpointPostMergeEnabled = checkpointPostMergeEnabled;</span>
<span class="fc" id="L406">      return this;</span>
    }

    public SynchronizerConfiguration build() {
<span class="fc" id="L410">      return new SynchronizerConfiguration(</span>
          fastSyncPivotDistance,
          fastSyncFullValidationRate,
          fastSyncMinimumPeerCount,
          worldStateHashCountPerRequest,
          worldStateRequestParallelism,
          worldStateMaxRequestsWithoutProgress,
          worldStateMinMillisBeforeStalling,
          worldStateTaskCacheSize,
          snapSyncConfiguration,
          blockPropagationRange,
          syncMode,
          downloaderChangeTargetThresholdByHeight,
          downloaderChangeTargetThresholdByTd,
          downloaderHeaderRequestSize,
          downloaderCheckpointTimeoutsPermitted,
          downloaderChainSegmentSize,
          downloaderParallelism,
          transactionsParallelism,
          computationParallelism,
          maxTrailingPeers,
          propagationManagerGetBlockTimeoutMillis,
          checkpointPostMergeEnabled);
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>