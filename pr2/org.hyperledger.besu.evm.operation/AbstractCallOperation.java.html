<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractCallOperation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.evm.operation</a> &gt; <span class="el_source">AbstractCallOperation.java</span></div><h1>AbstractCallOperation.java</h1><pre class="source lang-java linenums">/*
 * Copyright contributors to Hyperledger Besu
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.evm.operation;

import static org.hyperledger.besu.evm.internal.Words.clampedToLong;

import org.hyperledger.besu.datatypes.Address;
import org.hyperledger.besu.datatypes.Wei;
import org.hyperledger.besu.evm.Code;
import org.hyperledger.besu.evm.EVM;
import org.hyperledger.besu.evm.account.Account;
import org.hyperledger.besu.evm.code.CodeV0;
import org.hyperledger.besu.evm.frame.ExceptionalHaltReason;
import org.hyperledger.besu.evm.frame.MessageFrame;
import org.hyperledger.besu.evm.gascalculator.GasCalculator;

import org.apache.tuweni.bytes.Bytes;

/**
 * A skeleton class for implementing call operations.
 *
 * &lt;p&gt;A call operation creates a child message call from the current message context, allows it to
 * execute, and then updates the current message context based on its execution.
 */
public abstract class AbstractCallOperation extends AbstractOperation {

  /** The constant UNDERFLOW_RESPONSE. */
<span class="fc" id="L40">  protected static final OperationResult UNDERFLOW_RESPONSE =</span>
      new OperationResult(0L, ExceptionalHaltReason.INSUFFICIENT_STACK_ITEMS);

  /**
   * Instantiates a new Abstract call operation.
   *
   * @param opcode the opcode
   * @param name the name
   * @param stackItemsConsumed the stack items consumed
   * @param stackItemsProduced the stack items produced
   * @param gasCalculator the gas calculator
   */
  AbstractCallOperation(
      final int opcode,
      final String name,
      final int stackItemsConsumed,
      final int stackItemsProduced,
      final GasCalculator gasCalculator) {
<span class="fc" id="L58">    super(opcode, name, stackItemsConsumed, stackItemsProduced, gasCalculator);</span>
<span class="fc" id="L59">  }</span>

  /**
   * Returns the additional gas to provide the call operation.
   *
   * @param frame The current message frame
   * @return the additional gas to provide the call operation
   */
  protected long gas(final MessageFrame frame) {
<span class="fc" id="L68">    return clampedToLong(frame.getStackItem(0));</span>
  }

  /**
   * Returns the account the call is being made to.
   *
   * @param frame The current message frame
   * @return the account the call is being made to
   */
  protected abstract Address to(MessageFrame frame);

  /**
   * Returns the value being transferred in the call
   *
   * @param frame The current message frame
   * @return the value being transferred in the call
   */
  protected abstract Wei value(MessageFrame frame);

  /**
   * Returns the apparent value being transferred in the call
   *
   * @param frame The current message frame
   * @return the apparent value being transferred in the call
   */
  protected abstract Wei apparentValue(MessageFrame frame);

  /**
   * Returns the memory offset the input data starts at.
   *
   * @param frame The current message frame
   * @return the memory offset the input data starts at
   */
  protected abstract long inputDataOffset(MessageFrame frame);

  /**
   * Returns the length of the input data to read from memory.
   *
   * @param frame The current message frame
   * @return the length of the input data to read from memory.
   */
  protected abstract long inputDataLength(MessageFrame frame);

  /**
   * Returns the memory offset the offset data starts at.
   *
   * @param frame The current message frame
   * @return the memory offset the offset data starts at
   */
  protected abstract long outputDataOffset(MessageFrame frame);

  /**
   * Returns the length of the output data to read from memory.
   *
   * @param frame The current message frame
   * @return the length of the output data to read from memory.
   */
  protected abstract long outputDataLength(MessageFrame frame);

  /**
   * Returns the account address the call operation is being performed on
   *
   * @param frame The current message frame
   * @return the account address the call operation is being performed on
   */
  protected abstract Address address(MessageFrame frame);

  /**
   * Returns the account address the call operation is being sent from
   *
   * @param frame The current message frame
   * @return the account address the call operation is being sent from
   */
  protected abstract Address sender(MessageFrame frame);

  /**
   * Returns the gas available to execute the child message call.
   *
   * @param frame The current message frame
   * @return the gas available to execute the child message call
   */
  public abstract long gasAvailableForChildCall(MessageFrame frame);

  /**
   * Returns whether the child message call should be static.
   *
   * @param frame The current message frame
   * @return {@code true} if the child message call should be static; otherwise {@code false}
   */
  protected boolean isStatic(final MessageFrame frame) {
<span class="fc" id="L158">    return frame.isStatic();</span>
  }

  @Override
  public OperationResult execute(final MessageFrame frame, final EVM evm) {
    // manual check because some reads won't come until the &quot;complete&quot; step.
<span class="fc bfc" id="L164" title="All 2 branches covered.">    if (frame.stackSize() &lt; getStackItemsConsumed()) {</span>
<span class="fc" id="L165">      return UNDERFLOW_RESPONSE;</span>
    }

<span class="fc" id="L168">    final Address to = to(frame);</span>
<span class="fc bfc" id="L169" title="All 4 branches covered.">    final boolean accountIsWarm = frame.warmUpAddress(to) || gasCalculator().isPrecompile(to);</span>
<span class="fc" id="L170">    final long cost = cost(frame, accountIsWarm);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">    if (frame.getRemainingGas() &lt; cost) {</span>
<span class="fc" id="L172">      return new OperationResult(cost, ExceptionalHaltReason.INSUFFICIENT_GAS);</span>
    }
<span class="fc" id="L174">    frame.decrementRemainingGas(cost);</span>

<span class="fc" id="L176">    frame.clearReturnData();</span>

<span class="fc" id="L178">    final Account contract = frame.getWorldUpdater().get(to);</span>

<span class="fc" id="L180">    final Account account = frame.getWorldUpdater().get(frame.getRecipientAddress());</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">    final Wei balance = account == null ? Wei.ZERO : account.getBalance();</span>
    // If the call is sending more value than the account has or the message frame is to deep
    // return a failed call
<span class="fc bfc" id="L184" title="All 4 branches covered.">    if (value(frame).compareTo(balance) &gt; 0 || frame.getDepth() &gt;= 1024) {</span>
<span class="fc" id="L185">      frame.expandMemory(inputDataOffset(frame), inputDataLength(frame));</span>
<span class="fc" id="L186">      frame.expandMemory(outputDataOffset(frame), outputDataLength(frame));</span>
<span class="fc" id="L187">      frame.incrementRemainingGas(gasAvailableForChildCall(frame) + cost);</span>
<span class="fc" id="L188">      frame.popStackItems(getStackItemsConsumed());</span>
<span class="fc" id="L189">      frame.pushStackItem(FAILURE_STACK_ITEM);</span>
<span class="fc" id="L190">      return new OperationResult(cost, null);</span>
    }

<span class="fc" id="L193">    final Bytes inputData = frame.readMutableMemory(inputDataOffset(frame), inputDataLength(frame));</span>

    final Code code =
<span class="fc bfc" id="L196" title="All 2 branches covered.">        contract == null</span>
<span class="fc" id="L197">            ? CodeV0.EMPTY_CODE</span>
<span class="fc" id="L198">            : evm.getCode(contract.getCodeHash(), contract.getCode());</span>

<span class="pc bpc" id="L200" title="1 of 2 branches missed.">    if (code.isValid()) {</span>
      // frame addition is automatically handled by parent messageFrameStack
<span class="fc" id="L202">      MessageFrame.builder()</span>
<span class="fc" id="L203">          .parentMessageFrame(frame)</span>
<span class="fc" id="L204">          .type(MessageFrame.Type.MESSAGE_CALL)</span>
<span class="fc" id="L205">          .initialGas(gasAvailableForChildCall(frame))</span>
<span class="fc" id="L206">          .address(address(frame))</span>
<span class="fc" id="L207">          .contract(to)</span>
<span class="fc" id="L208">          .inputData(inputData)</span>
<span class="fc" id="L209">          .sender(sender(frame))</span>
<span class="fc" id="L210">          .value(value(frame))</span>
<span class="fc" id="L211">          .apparentValue(apparentValue(frame))</span>
<span class="fc" id="L212">          .code(code)</span>
<span class="fc" id="L213">          .isStatic(isStatic(frame))</span>
<span class="fc" id="L214">          .completer(child -&gt; complete(frame, child))</span>
<span class="fc" id="L215">          .build();</span>
<span class="fc" id="L216">      frame.incrementRemainingGas(cost);</span>

<span class="fc" id="L218">      frame.setState(MessageFrame.State.CODE_SUSPENDED);</span>
<span class="fc" id="L219">      return new OperationResult(cost, null, 0);</span>
    } else {
<span class="nc" id="L221">      return new OperationResult(cost, ExceptionalHaltReason.INVALID_CODE, 0);</span>
    }
  }

  /**
   * Calculates Cost.
   *
   * @param frame the frame
   * @return the long
   * @deprecated use the form with the `accountIsWarm` boolean
   */
  @Deprecated(since = &quot;24.2.0&quot;, forRemoval = true)
  @SuppressWarnings(&quot;InlineMeSuggester&quot;) // downstream users override, so @InlineMe is inappropriate
  public long cost(final MessageFrame frame) {
<span class="nc" id="L235">    return cost(frame, true);</span>
  }

  /**
   * Calculates Cost.
   *
   * @param frame the frame
   * @param accountIsWarm whether the contract being called is &quot;warm&quot; as per EIP-2929.
   * @return the long
   */
  public long cost(final MessageFrame frame, final boolean accountIsWarm) {
<span class="fc" id="L246">    final long stipend = gas(frame);</span>
<span class="fc" id="L247">    final long inputDataOffset = inputDataOffset(frame);</span>
<span class="fc" id="L248">    final long inputDataLength = inputDataLength(frame);</span>
<span class="fc" id="L249">    final long outputDataOffset = outputDataOffset(frame);</span>
<span class="fc" id="L250">    final long outputDataLength = outputDataLength(frame);</span>
<span class="fc" id="L251">    final Account recipient = frame.getWorldUpdater().get(address(frame));</span>
<span class="fc" id="L252">    final Address to = to(frame);</span>
<span class="fc" id="L253">    GasCalculator gasCalculator = gasCalculator();</span>

<span class="fc" id="L255">    return gasCalculator.callOperationGasCost(</span>
        frame,
        stipend,
        inputDataOffset,
        inputDataLength,
        outputDataOffset,
        outputDataLength,
<span class="fc" id="L262">        value(frame),</span>
        recipient,
        to,
        accountIsWarm);
  }

  /**
   * Complete.
   *
   * @param frame the frame
   * @param childFrame the child frame
   */
  public void complete(final MessageFrame frame, final MessageFrame childFrame) {
<span class="fc" id="L275">    frame.setState(MessageFrame.State.CODE_EXECUTING);</span>

<span class="fc" id="L277">    final long outputOffset = outputDataOffset(frame);</span>
<span class="fc" id="L278">    final long outputSize = outputDataLength(frame);</span>
<span class="fc" id="L279">    final Bytes outputData = childFrame.getOutputData();</span>

<span class="fc bfc" id="L281" title="All 2 branches covered.">    if (outputSize &gt; outputData.size()) {</span>
<span class="fc" id="L282">      frame.expandMemory(outputOffset, outputSize);</span>
<span class="fc" id="L283">      frame.writeMemory(outputOffset, outputData.size(), outputData, true);</span>
    } else {
<span class="fc" id="L285">      frame.writeMemory(outputOffset, outputSize, outputData, true);</span>
    }

<span class="fc" id="L288">    frame.setReturnData(outputData);</span>
<span class="fc" id="L289">    frame.addLogs(childFrame.getLogs());</span>
<span class="fc" id="L290">    frame.addSelfDestructs(childFrame.getSelfDestructs());</span>
<span class="fc" id="L291">    frame.addCreates(childFrame.getCreates());</span>
<span class="fc" id="L292">    frame.incrementGasRefund(childFrame.getGasRefund());</span>

<span class="fc" id="L294">    final long gasRemaining = childFrame.getRemainingGas();</span>
<span class="fc" id="L295">    frame.incrementRemainingGas(gasRemaining);</span>

<span class="fc" id="L297">    frame.popStackItems(getStackItemsConsumed());</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">    if (childFrame.getState() == MessageFrame.State.COMPLETED_SUCCESS) {</span>
<span class="fc" id="L299">      frame.pushStackItem(SUCCESS_STACK_ITEM);</span>
    } else {
<span class="fc" id="L301">      frame.pushStackItem(FAILURE_STACK_ITEM);</span>
    }

<span class="fc" id="L304">    final int currentPC = frame.getPC();</span>
<span class="fc" id="L305">    frame.setPC(currentPC + 1);</span>
<span class="fc" id="L306">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>