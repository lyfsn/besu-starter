<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetricsConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.metrics.prometheus</a> &gt; <span class="el_source">MetricsConfiguration.java</span></div><h1>MetricsConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright Hyperledger Besu Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.metrics.prometheus;

import static org.hyperledger.besu.metrics.BesuMetricCategory.DEFAULT_METRIC_CATEGORIES;

import org.hyperledger.besu.metrics.MetricsProtocol;
import org.hyperledger.besu.plugin.services.metrics.MetricCategory;

import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Objects;
import java.util.Set;

import com.google.common.base.MoreObjects;

/** The Metrics configuration. */
public class MetricsConfiguration {
  private static final String DEFAULT_METRICS_HOST = &quot;127.0.0.1&quot;;

  /** The constant DEFAULT_METRICS_PORT. */
  public static final int DEFAULT_METRICS_PORT = 9545;

<span class="fc" id="L38">  private static final MetricsProtocol DEFAULT_METRICS_PROTOCOL = MetricsProtocol.PROMETHEUS;</span>
  private static final String DEFAULT_METRICS_PUSH_HOST = &quot;127.0.0.1&quot;;

  /** The constant DEFAULT_METRICS_PUSH_PORT. */
  public static final int DEFAULT_METRICS_PUSH_PORT = 9001;

  /** The constant DEFAULT_METRICS_TIMERS_ENABLED. */
<span class="fc" id="L45">  public static final Boolean DEFAULT_METRICS_TIMERS_ENABLED = true;</span>

  /** The constant DEFAULT_METRICS_IDLE_TIMEOUT_SECONDS. */
  public static final int DEFAULT_METRICS_IDLE_TIMEOUT_SECONDS = 60;

  private final boolean enabled;
  private final MetricsProtocol protocol;
  private final int port;
  private int actualPort;
  private final String host;
  private final Set&lt;MetricCategory&gt; metricCategories;
  private final boolean pushEnabled;
  private final int pushPort;
  private final String pushHost;
  private final int pushInterval;
  private final String prometheusJob;
  private final List&lt;String&gt; hostsAllowlist;
  private final boolean timersEnabled;
  private final int idleTimeout;

  /**
   * Builder.
   *
   * @return the builder
   */
  public static Builder builder() {
<span class="fc" id="L71">    return new Builder();</span>
  }

  private MetricsConfiguration(
      final boolean enabled,
      final int port,
      final MetricsProtocol protocol,
      final String host,
      final Set&lt;MetricCategory&gt; metricCategories,
      final boolean pushEnabled,
      final int pushPort,
      final String pushHost,
      final int pushInterval,
      final String prometheusJob,
      final List&lt;String&gt; hostsAllowlist,
      final boolean timersEnabled,
<span class="fc" id="L87">      final int idleTimeout) {</span>
<span class="fc" id="L88">    this.enabled = enabled;</span>
<span class="fc" id="L89">    this.port = port;</span>
<span class="fc" id="L90">    this.protocol = protocol;</span>
<span class="fc" id="L91">    this.host = host;</span>
<span class="fc" id="L92">    this.metricCategories = metricCategories;</span>
<span class="fc" id="L93">    this.pushEnabled = pushEnabled;</span>
<span class="fc" id="L94">    this.pushPort = pushPort;</span>
<span class="fc" id="L95">    this.pushHost = pushHost;</span>
<span class="fc" id="L96">    this.pushInterval = pushInterval;</span>
<span class="fc" id="L97">    this.prometheusJob = prometheusJob;</span>
<span class="fc" id="L98">    this.hostsAllowlist = hostsAllowlist;</span>
<span class="fc" id="L99">    this.timersEnabled = timersEnabled;</span>
<span class="fc" id="L100">    this.idleTimeout = idleTimeout;</span>
<span class="fc" id="L101">  }</span>

  /**
   * Is enabled.
   *
   * @return the boolean
   */
  public boolean isEnabled() {
<span class="fc" id="L109">    return enabled;</span>
  }

  /**
   * Gets protocol.
   *
   * @return the protocol
   */
  public MetricsProtocol getProtocol() {
<span class="fc" id="L118">    return protocol;</span>
  }

  /**
   * Gets host.
   *
   * @return the host
   */
  public String getHost() {
<span class="fc" id="L127">    return host;</span>
  }

  /**
   * Gets port.
   *
   * @return the port
   */
  public int getPort() {
<span class="fc" id="L136">    return port;</span>
  }

  /**
   * Gets actual port.
   *
   * @return the actual port
   */
  public int getActualPort() {
<span class="fc" id="L145">    return actualPort;</span>
  }

  /**
   * Sets actual port.
   *
   * @param actualPort the actual port
   */
  void setActualPort(final int actualPort) {
<span class="fc" id="L154">    this.actualPort = actualPort;</span>
<span class="fc" id="L155">  }</span>

  /**
   * Gets metric categories.
   *
   * @return the metric categories
   */
  public Set&lt;MetricCategory&gt; getMetricCategories() {
<span class="fc" id="L163">    return metricCategories;</span>
  }

  /**
   * Gets push port.
   *
   * @return the push port
   */
  public int getPushPort() {
<span class="fc" id="L172">    return pushPort;</span>
  }

  /**
   * Gets push host.
   *
   * @return the push host
   */
  public String getPushHost() {
<span class="fc" id="L181">    return pushHost;</span>
  }

  /**
   * Is push enabled boolean.
   *
   * @return the boolean
   */
  public boolean isPushEnabled() {
<span class="fc" id="L190">    return pushEnabled;</span>
  }

  /**
   * Gets push interval.
   *
   * @return the push interval
   */
  public int getPushInterval() {
<span class="fc" id="L199">    return pushInterval;</span>
  }

  /**
   * Gets prometheus job.
   *
   * @return the prometheus job
   */
  public String getPrometheusJob() {
<span class="fc" id="L208">    return prometheusJob;</span>
  }

  /**
   * Gets hosts whitelist.
   *
   * @return the hosts whitelist
   */
  // use getHostsAllowlist instead
  @Deprecated
  Collection&lt;String&gt; getHostsWhitelist() {
<span class="nc" id="L219">    return Collections.unmodifiableCollection(this.hostsAllowlist);</span>
  }

  /**
   * Gets hosts allowlist.
   *
   * @return the hosts allowlist
   */
  Collection&lt;String&gt; getHostsAllowlist() {
<span class="fc" id="L228">    return Collections.unmodifiableCollection(this.hostsAllowlist);</span>
  }

  /**
   * Is timers enabled.
   *
   * @return the boolean
   */
  public boolean isTimersEnabled() {
<span class="fc" id="L237">    return timersEnabled;</span>
  }

  /**
   * Gets idle timeout.
   *
   * @return the idle timeout
   */
  public int getIdleTimeout() {
<span class="fc" id="L246">    return idleTimeout;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L251">    return MoreObjects.toStringHelper(this)</span>
<span class="nc" id="L252">        .add(&quot;enabled&quot;, enabled)</span>
<span class="nc" id="L253">        .add(&quot;protocol&quot;, protocol)</span>
<span class="nc" id="L254">        .add(&quot;port&quot;, port)</span>
<span class="nc" id="L255">        .add(&quot;host&quot;, host)</span>
<span class="nc" id="L256">        .add(&quot;metricCategories&quot;, metricCategories)</span>
<span class="nc" id="L257">        .add(&quot;pushEnabled&quot;, pushEnabled)</span>
<span class="nc" id="L258">        .add(&quot;pushPort&quot;, pushPort)</span>
<span class="nc" id="L259">        .add(&quot;pushHost&quot;, pushHost)</span>
<span class="nc" id="L260">        .add(&quot;pushInterval&quot;, pushInterval)</span>
<span class="nc" id="L261">        .add(&quot;prometheusJob&quot;, prometheusJob)</span>
<span class="nc" id="L262">        .add(&quot;hostsAllowlist&quot;, hostsAllowlist)</span>
<span class="nc" id="L263">        .add(&quot;timersEnabled&quot;, timersEnabled)</span>
<span class="nc" id="L264">        .add(&quot;idleTimeout&quot;, idleTimeout)</span>
<span class="nc" id="L265">        .toString();</span>
  }

  @Override
  public boolean equals(final Object o) {
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">    if (this == o) {</span>
<span class="nc" id="L271">      return true;</span>
    }
<span class="pc bpc" id="L273" title="2 of 4 branches missed.">    if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L274">      return false;</span>
    }
<span class="fc" id="L276">    final MetricsConfiguration that = (MetricsConfiguration) o;</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">    return enabled == that.enabled</span>
<span class="pc bpc" id="L278" title="5 of 10 branches missed.">        &amp;&amp; Objects.equals(protocol, that.protocol)</span>
        &amp;&amp; port == that.port
        &amp;&amp; pushEnabled == that.pushEnabled
        &amp;&amp; pushPort == that.pushPort
        &amp;&amp; pushInterval == that.pushInterval
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">        &amp;&amp; Objects.equals(host, that.host)</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">        &amp;&amp; Objects.equals(metricCategories, that.metricCategories)</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        &amp;&amp; Objects.equals(pushHost, that.pushHost)</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">        &amp;&amp; Objects.equals(prometheusJob, that.prometheusJob)</span>
<span class="pc bpc" id="L287" title="3 of 6 branches missed.">        &amp;&amp; Objects.equals(hostsAllowlist, that.hostsAllowlist)</span>
        &amp;&amp; timersEnabled == that.timersEnabled
        &amp;&amp; idleTimeout == that.idleTimeout;
  }

  @Override
  public int hashCode() {
<span class="nc" id="L294">    return Objects.hash(</span>
<span class="nc" id="L295">        enabled,</span>
        protocol,
<span class="nc" id="L297">        port,</span>
        host,
        metricCategories,
<span class="nc" id="L300">        pushEnabled,</span>
<span class="nc" id="L301">        pushPort,</span>
        pushHost,
<span class="nc" id="L303">        pushInterval,</span>
        prometheusJob,
        hostsAllowlist,
<span class="nc" id="L306">        timersEnabled,</span>
<span class="nc" id="L307">        idleTimeout);</span>
  }

  /** The type Builder. */
  public static class Builder {
<span class="fc" id="L312">    private boolean enabled = false;</span>
<span class="fc" id="L313">    private MetricsProtocol protocol = DEFAULT_METRICS_PROTOCOL;</span>
<span class="fc" id="L314">    private int port = DEFAULT_METRICS_PORT;</span>
<span class="fc" id="L315">    private String host = DEFAULT_METRICS_HOST;</span>
<span class="fc" id="L316">    private Set&lt;MetricCategory&gt; metricCategories = DEFAULT_METRIC_CATEGORIES;</span>
<span class="fc" id="L317">    private boolean pushEnabled = false;</span>
<span class="fc" id="L318">    private int pushPort = DEFAULT_METRICS_PUSH_PORT;</span>
<span class="fc" id="L319">    private String pushHost = DEFAULT_METRICS_PUSH_HOST;</span>
<span class="fc" id="L320">    private int pushInterval = 15;</span>
<span class="fc" id="L321">    private String prometheusJob = &quot;besu-client&quot;;</span>
<span class="fc" id="L322">    private List&lt;String&gt; hostsAllowlist = Arrays.asList(&quot;localhost&quot;, &quot;127.0.0.1&quot;);</span>
<span class="fc" id="L323">    private boolean timersEnabled = DEFAULT_METRICS_TIMERS_ENABLED;</span>
<span class="fc" id="L324">    private int idleTimeout = DEFAULT_METRICS_IDLE_TIMEOUT_SECONDS;</span>

<span class="fc" id="L326">    private Builder() {}</span>

    /**
     * Enabled.
     *
     * @param enabled the enabled
     * @return the builder
     */
    public Builder enabled(final boolean enabled) {
<span class="fc" id="L335">      this.enabled = enabled;</span>
<span class="fc" id="L336">      return this;</span>
    }

    /**
     * Protocol.
     *
     * @param protocol the protocol
     * @return the builder
     */
    public Builder protocol(final MetricsProtocol protocol) {
<span class="fc" id="L346">      this.protocol = protocol;</span>
<span class="fc" id="L347">      return this;</span>
    }

    /**
     * Port.
     *
     * @param port the port
     * @return the builder
     */
    public Builder port(final int port) {
<span class="fc" id="L357">      this.port = port;</span>
<span class="fc" id="L358">      return this;</span>
    }

    /**
     * Host.
     *
     * @param host the host
     * @return the builder
     */
    public Builder host(final String host) {
<span class="fc" id="L368">      this.host = host;</span>
<span class="fc" id="L369">      return this;</span>
    }

    /**
     * Metric categories.
     *
     * @param metricCategories the metric categories
     * @return the builder
     */
    public Builder metricCategories(final Set&lt;MetricCategory&gt; metricCategories) {
<span class="fc" id="L379">      this.metricCategories = metricCategories;</span>
<span class="fc" id="L380">      return this;</span>
    }

    /**
     * Push enabled.
     *
     * @param pushEnabled the push enabled
     * @return the builder
     */
    public Builder pushEnabled(final boolean pushEnabled) {
<span class="fc" id="L390">      this.pushEnabled = pushEnabled;</span>
<span class="fc" id="L391">      return this;</span>
    }

    /**
     * Push port.
     *
     * @param pushPort the push port
     * @return the builder
     */
    public Builder pushPort(final int pushPort) {
<span class="fc" id="L401">      this.pushPort = pushPort;</span>
<span class="fc" id="L402">      return this;</span>
    }

    /**
     * Push host.
     *
     * @param pushHost the push host
     * @return the builder
     */
    public Builder pushHost(final String pushHost) {
<span class="fc" id="L412">      this.pushHost = pushHost;</span>
<span class="fc" id="L413">      return this;</span>
    }

    /**
     * Push interval.
     *
     * @param pushInterval the push interval
     * @return the builder
     */
    public Builder pushInterval(final int pushInterval) {
<span class="fc" id="L423">      this.pushInterval = pushInterval;</span>
<span class="fc" id="L424">      return this;</span>
    }

    /**
     * Prometheus job.
     *
     * @param prometheusJob the prometheus job
     * @return the builder
     */
    public Builder prometheusJob(final String prometheusJob) {
<span class="fc" id="L434">      this.prometheusJob = prometheusJob;</span>
<span class="fc" id="L435">      return this;</span>
    }

    /**
     * Hosts whitelist.
     *
     * @param hostsAllowlist the hosts allowlist
     * @return the builder
     */
    // use hostsAllowlist instead
    @Deprecated
    public Builder hostsWhitelist(final List&lt;String&gt; hostsAllowlist) {
<span class="nc" id="L447">      this.hostsAllowlist = hostsAllowlist;</span>
<span class="nc" id="L448">      return this;</span>
    }

    /**
     * Hosts allowlist.
     *
     * @param hostsAllowlist the hosts allowlist
     * @return the builder
     */
    public Builder hostsAllowlist(final List&lt;String&gt; hostsAllowlist) {
<span class="fc" id="L458">      this.hostsAllowlist = hostsAllowlist;</span>
<span class="fc" id="L459">      return this;</span>
    }

    /**
     * Timers enabled.
     *
     * @param timersEnabled the timers enabled
     * @return the builder
     */
    public Builder timersEnabled(final boolean timersEnabled) {
<span class="fc" id="L469">      this.timersEnabled = timersEnabled;</span>
<span class="fc" id="L470">      return this;</span>
    }

    /**
     * Idle timeout.
     *
     * @param idleTimeout the idle timeout
     * @return the builder
     */
    public Builder idleTimeout(final int idleTimeout) {
<span class="fc" id="L480">      this.idleTimeout = idleTimeout;</span>
<span class="fc" id="L481">      return this;</span>
    }

    /**
     * Build metrics configuration.
     *
     * @return the metrics configuration
     */
    public MetricsConfiguration build() {
<span class="fc" id="L490">      return new MetricsConfiguration(</span>
          enabled,
          port,
          protocol,
          host,
          metricCategories,
          pushEnabled,
          pushPort,
          pushHost,
          pushInterval,
          prometheusJob,
          hostsAllowlist,
          timersEnabled,
          idleTimeout);
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>