<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Scalars.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.api.graphql.internal</a> &gt; <span class="el_source">Scalars.java</span></div><h1>Scalars.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.api.graphql.internal;

import org.hyperledger.besu.datatypes.Address;
import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.Quantity;

import java.math.BigInteger;
import java.util.Locale;

import graphql.GraphQLContext;
import graphql.execution.CoercedVariables;
import graphql.language.IntValue;
import graphql.language.StringValue;
import graphql.language.Value;
import graphql.schema.Coercing;
import graphql.schema.CoercingParseLiteralException;
import graphql.schema.CoercingParseValueException;
import graphql.schema.CoercingSerializeException;
import graphql.schema.GraphQLScalarType;
import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;
import org.apache.tuweni.units.bigints.UInt256;

public class Scalars {

  private Scalars() {}

<span class="fc" id="L41">  private static final Coercing&lt;Address, String&gt; ADDRESS_COERCING =</span>
<span class="fc" id="L42">      new Coercing&lt;Address, String&gt;() {</span>
        Address convertImpl(final Object input) {
<span class="fc bfc" id="L44" title="All 2 branches covered.">          if (input instanceof Address address) {</span>
<span class="fc" id="L45">            return address;</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">          } else if (input instanceof Bytes bytes) {</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            if (((Bytes) input).size() &lt;= 20) {</span>
<span class="nc" id="L48">              return Address.wrap(bytes);</span>
            } else {
<span class="nc" id="L50">              return null;</span>
            }
<span class="fc bfc" id="L52" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L53">            return convertImpl(stringValue.getValue());</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
            try {
<span class="fc" id="L56">              return Address.fromHexStringStrict(string);</span>
<span class="fc" id="L57">            } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L58">              return null;</span>
            }
          } else {
<span class="fc" id="L61">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L69">          Address result = convertImpl(input);</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L71">            return result.toHexString();</span>
          } else {
<span class="fc" id="L73">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Address&quot;);</span>
          }
        }

        @Override
        public Address parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L81">          Address result = convertImpl(input);</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L83">            return result;</span>
          } else {
<span class="fc" id="L85">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an Address&quot;);
          }
        }

        @Override
        public Address parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L97">          Address result = convertImpl(input);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L99">            return result;</span>
          } else {
<span class="fc" id="L101">            throw new CoercingParseLiteralException(&quot;Value is not any Address : '&quot; + input + &quot;'&quot;);</span>
          }
        }
      };

<span class="fc" id="L106">  private static final Coercing&lt;String, String&gt; BIG_INT_COERCING =</span>
<span class="fc" id="L107">      new Coercing&lt;String, String&gt;() {</span>

        String convertImpl(final Object input) {
<span class="fc bfc" id="L110" title="All 2 branches covered.">          if (input instanceof String string) {</span>
            try {
<span class="nc" id="L112">              return Bytes.fromHexStringLenient(string).toShortHexString();</span>
<span class="fc" id="L113">            } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L114">              return null;</span>
            }
<span class="fc bfc" id="L116" title="All 2 branches covered.">          } else if (input instanceof Bytes bytes) {</span>
<span class="fc" id="L117">            return bytes.toShortHexString();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L119">            return convertImpl(stringValue.getValue());</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">          } else if (input instanceof IntValue intValue) {</span>
<span class="nc" id="L121">            return UInt256.valueOf(intValue.getValue()).toShortHexString();</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">          } else if (input instanceof BigInteger bigInteger) {</span>
<span class="fc" id="L123">            return &quot;0x&quot; + bigInteger.toString(16);</span>
          } else {
<span class="fc" id="L125">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L133">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L135">            return result;</span>
          } else {
<span class="fc" id="L137">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an BigInt&quot;);</span>
          }
        }

        @Override
        public String parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L145">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L147">            return result;</span>
          } else {
<span class="fc" id="L149">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an BigInt&quot;);
          }
        }

        @Override
        public String parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L161">          var result = convertImpl(input);</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">          if (result != null) {</span>
<span class="nc" id="L163">            return result;</span>
          } else {
<span class="fc" id="L165">            throw new CoercingParseLiteralException(&quot;Value is not any BigInt : '&quot; + input + &quot;'&quot;);</span>
          }
        }
      };

<span class="fc" id="L170">  private static final Coercing&lt;Bytes, String&gt; BYTES_COERCING =</span>
<span class="fc" id="L171">      new Coercing&lt;Bytes, String&gt;() {</span>

        Bytes convertImpl(final Object input) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">          if (input instanceof Bytes bytes) {</span>
<span class="fc" id="L175">            return bytes;</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L177">            return convertImpl(stringValue.getValue());</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">            if (!Quantity.isValid(string)) {</span>
<span class="fc" id="L180">              throw new CoercingParseLiteralException(</span>
                  &quot;Bytes value '&quot; + input + &quot;' is not prefixed with 0x&quot;);
            }
            try {
<span class="fc" id="L184">              return Bytes.fromHexStringLenient((String) input);</span>
<span class="fc" id="L185">            } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L186">              return null;</span>
            }
          } else {
<span class="fc" id="L189">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L197">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L199">            return result.toHexString();</span>
          } else {
<span class="fc" id="L201">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Bytes&quot;);</span>
          }
        }

        @Override
        public Bytes parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L209">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L211">            return result;</span>
          } else {
<span class="fc" id="L213">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an Bytes&quot;);
          }
        }

        @Override
        public Bytes parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L225">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L227">            return result;</span>
          } else {
<span class="fc" id="L229">            throw new CoercingParseLiteralException(&quot;Value is not any Bytes : '&quot; + input + &quot;'&quot;);</span>
          }
        }
      };

<span class="fc" id="L234">  private static final Coercing&lt;Bytes32, String&gt; BYTES32_COERCING =</span>
<span class="fc" id="L235">      new Coercing&lt;Bytes32, String&gt;() {</span>

        Bytes32 convertImpl(final Object input) {
<span class="fc bfc" id="L238" title="All 2 branches covered.">          if (input instanceof Bytes32 bytes32) {</span>
<span class="fc" id="L239">            return bytes32;</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">          } else if (input instanceof Bytes bytes) {</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            if (bytes.size() &lt;= 32) {</span>
<span class="nc" id="L242">              return Bytes32.leftPad((Bytes) input);</span>
            } else {
<span class="nc" id="L244">              return null;</span>
            }
<span class="fc bfc" id="L246" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L247">            return convertImpl(stringValue.getValue());</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">            if (!Quantity.isValid(string)) {</span>
<span class="fc" id="L250">              throw new CoercingParseLiteralException(</span>
                  &quot;Bytes32 value '&quot; + input + &quot;' is not prefixed with 0x&quot;);
            } else {
              try {
<span class="fc" id="L254">                return Bytes32.fromHexStringLenient((String) input);</span>
<span class="fc" id="L255">              } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L256">                return null;</span>
              }
            }
          } else {
<span class="fc" id="L260">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L268">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">          if (result == null) {</span>
<span class="fc" id="L270">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Bytes32&quot;);</span>
          } else {
<span class="fc" id="L272">            return result.toHexString();</span>
          }
        }

        @Override
        public Bytes32 parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L280">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">          if (result == null) {</span>
<span class="fc" id="L282">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an Bytes32&quot;);
          } else {
<span class="fc" id="L285">            return result;</span>
          }
        }

        @Override
        public Bytes32 parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L296">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">          if (result == null) {</span>
<span class="fc" id="L298">            throw new CoercingParseLiteralException(&quot;Value is not any Bytes32 : '&quot; + input + &quot;'&quot;);</span>
          } else {
<span class="fc" id="L300">            return result;</span>
          }
        }
      };

<span class="fc" id="L305">  private static final Coercing&lt;Number, String&gt; LONG_COERCING =</span>
<span class="fc" id="L306">      new Coercing&lt;&gt;() {</span>
        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc bfc" id="L311" title="All 2 branches covered.">          if (input instanceof Number number) {</span>
<span class="fc" id="L312">            return Bytes.ofUnsignedLong(number.longValue()).toQuantityHexString();</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">            if (string.startsWith(&quot;0x&quot;)) {</span>
<span class="fc" id="L315">              return string;</span>
            } else {
<span class="nc" id="L317">              return &quot;0x&quot; + string;</span>
            }
          }
<span class="fc" id="L320">          throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Long&quot;);</span>
        }

        @Override
        public Number parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc bfc" id="L327" title="All 2 branches covered.">          if (input instanceof Number number) {</span>
<span class="fc" id="L328">            return number;</span>
<span class="fc bfc" id="L329" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="fc" id="L330">            final String value = string.toLowerCase();</span>
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">            if (value.startsWith(&quot;0x&quot;)) {</span>
<span class="fc" id="L332">              return Bytes.fromHexStringLenient(value).toLong();</span>
            } else {
<span class="nc" id="L334">              return Long.parseLong(value);</span>
            }
          }
<span class="fc" id="L337">          throw new CoercingParseValueException(</span>
              &quot;Unable to parse variable value &quot; + input + &quot; as an Long&quot;);
        }

        @Override
        public Number parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
          try {
<span class="fc bfc" id="L349" title="All 2 branches covered.">            if (input instanceof IntValue intValue) {</span>
<span class="fc" id="L350">              return intValue.getValue().longValue();</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">            } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L352">              final String value = stringValue.getValue().toLowerCase();</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">              if (value.startsWith(&quot;0x&quot;)) {</span>
<span class="fc" id="L354">                return Bytes.fromHexStringLenient(value).toLong();</span>
              } else {
<span class="fc" id="L356">                return Long.parseLong(value);</span>
              }
            }
<span class="fc" id="L359">          } catch (final NumberFormatException e) {</span>
            // fall through
<span class="nc" id="L361">          }</span>
<span class="fc" id="L362">          throw new CoercingParseLiteralException(&quot;Value is not any Long : '&quot; + input + &quot;'&quot;);</span>
        }
      };

  public static GraphQLScalarType addressScalar() {
<span class="fc" id="L367">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L368">        .name(&quot;Address&quot;)</span>
<span class="fc" id="L369">        .description(&quot;Address scalar&quot;)</span>
<span class="fc" id="L370">        .coercing(ADDRESS_COERCING)</span>
<span class="fc" id="L371">        .build();</span>
  }

  public static GraphQLScalarType bigIntScalar() {
<span class="fc" id="L375">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L376">        .name(&quot;BigInt&quot;)</span>
<span class="fc" id="L377">        .description(&quot;A BigInt (UInt256) scalar&quot;)</span>
<span class="fc" id="L378">        .coercing(BIG_INT_COERCING)</span>
<span class="fc" id="L379">        .build();</span>
  }

  public static GraphQLScalarType bytesScalar() {
<span class="fc" id="L383">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L384">        .name(&quot;Bytes&quot;)</span>
<span class="fc" id="L385">        .description(&quot;A Bytes scalar&quot;)</span>
<span class="fc" id="L386">        .coercing(BYTES_COERCING)</span>
<span class="fc" id="L387">        .build();</span>
  }

  public static GraphQLScalarType bytes32Scalar() {
<span class="fc" id="L391">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L392">        .name(&quot;Bytes32&quot;)</span>
<span class="fc" id="L393">        .description(&quot;A Bytes32 scalar&quot;)</span>
<span class="fc" id="L394">        .coercing(BYTES32_COERCING)</span>
<span class="fc" id="L395">        .build();</span>
  }

  public static GraphQLScalarType longScalar() {
<span class="fc" id="L399">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L400">        .name(&quot;Long&quot;)</span>
<span class="fc" id="L401">        .description(&quot;A Long (UInt64) scalar&quot;)</span>
<span class="fc" id="L402">        .coercing(LONG_COERCING)</span>
<span class="fc" id="L403">        .build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>