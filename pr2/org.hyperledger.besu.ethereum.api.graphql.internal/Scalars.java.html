<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Scalars.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.api.graphql.internal</a> &gt; <span class="el_source">Scalars.java</span></div><h1>Scalars.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.api.graphql.internal;

import org.hyperledger.besu.datatypes.Address;
import org.hyperledger.besu.datatypes.VersionedHash;
import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.Quantity;

import java.math.BigInteger;
import java.util.Locale;

import graphql.GraphQLContext;
import graphql.execution.CoercedVariables;
import graphql.language.IntValue;
import graphql.language.StringValue;
import graphql.language.Value;
import graphql.schema.Coercing;
import graphql.schema.CoercingParseLiteralException;
import graphql.schema.CoercingParseValueException;
import graphql.schema.CoercingSerializeException;
import graphql.schema.GraphQLScalarType;
import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;
import org.apache.tuweni.units.bigints.UInt256;

public class Scalars {

  private Scalars() {}

<span class="fc" id="L42">  private static final Coercing&lt;Address, String&gt; ADDRESS_COERCING =</span>
<span class="fc" id="L43">      new Coercing&lt;Address, String&gt;() {</span>
        Address convertImpl(final Object input) {
<span class="fc bfc" id="L45" title="All 2 branches covered.">          if (input instanceof Address address) {</span>
<span class="fc" id="L46">            return address;</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">          } else if (input instanceof Bytes bytes) {</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">            if (((Bytes) input).size() &lt;= 20) {</span>
<span class="nc" id="L49">              return Address.wrap(bytes);</span>
            } else {
<span class="nc" id="L51">              return null;</span>
            }
<span class="fc bfc" id="L53" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L54">            return convertImpl(stringValue.getValue());</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
            try {
<span class="fc" id="L57">              return Address.fromHexStringStrict(string);</span>
<span class="fc" id="L58">            } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L59">              return null;</span>
            }
          } else {
<span class="fc" id="L62">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L70">          Address result = convertImpl(input);</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L72">            return result.toHexString();</span>
          } else {
<span class="fc" id="L74">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Address&quot;);</span>
          }
        }

        @Override
        public Address parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L82">          Address result = convertImpl(input);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L84">            return result;</span>
          } else {
<span class="fc" id="L86">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an Address&quot;);
          }
        }

        @Override
        public Address parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L98">          Address result = convertImpl(input);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L100">            return result;</span>
          } else {
<span class="fc" id="L102">            throw new CoercingParseLiteralException(&quot;Value is not any Address : '&quot; + input + &quot;'&quot;);</span>
          }
        }
      };

<span class="fc" id="L107">  private static final Coercing&lt;String, String&gt; BIG_INT_COERCING =</span>
<span class="fc" id="L108">      new Coercing&lt;String, String&gt;() {</span>

        String convertImpl(final Object input) {
<span class="fc bfc" id="L111" title="All 2 branches covered.">          if (input instanceof String string) {</span>
            try {
<span class="nc" id="L113">              return Bytes.fromHexStringLenient(string).toShortHexString();</span>
<span class="fc" id="L114">            } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L115">              return null;</span>
            }
<span class="fc bfc" id="L117" title="All 2 branches covered.">          } else if (input instanceof Bytes bytes) {</span>
<span class="fc" id="L118">            return bytes.toShortHexString();</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L120">            return convertImpl(stringValue.getValue());</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">          } else if (input instanceof IntValue intValue) {</span>
<span class="nc" id="L122">            return UInt256.valueOf(intValue.getValue()).toShortHexString();</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">          } else if (input instanceof BigInteger bigInteger) {</span>
<span class="fc" id="L124">            return &quot;0x&quot; + bigInteger.toString(16);</span>
          } else {
<span class="fc" id="L126">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L134">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L136">            return result;</span>
          } else {
<span class="fc" id="L138">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an BigInt&quot;);</span>
          }
        }

        @Override
        public String parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L146">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L148">            return result;</span>
          } else {
<span class="fc" id="L150">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an BigInt&quot;);
          }
        }

        @Override
        public String parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L162">          var result = convertImpl(input);</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">          if (result != null) {</span>
<span class="nc" id="L164">            return result;</span>
          } else {
<span class="fc" id="L166">            throw new CoercingParseLiteralException(&quot;Value is not any BigInt : '&quot; + input + &quot;'&quot;);</span>
          }
        }
      };

<span class="fc" id="L171">  private static final Coercing&lt;Bytes, String&gt; BYTES_COERCING =</span>
<span class="fc" id="L172">      new Coercing&lt;Bytes, String&gt;() {</span>

        Bytes convertImpl(final Object input) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">          if (input instanceof Bytes bytes) {</span>
<span class="fc" id="L176">            return bytes;</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L178">            return convertImpl(stringValue.getValue());</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">            if (!Quantity.isValid(string)) {</span>
<span class="fc" id="L181">              throw new CoercingParseLiteralException(</span>
                  &quot;Bytes value '&quot; + input + &quot;' is not prefixed with 0x&quot;);
            }
            try {
<span class="fc" id="L185">              return Bytes.fromHexStringLenient((String) input);</span>
<span class="fc" id="L186">            } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L187">              return null;</span>
            }
          } else {
<span class="fc" id="L190">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L198">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L200">            return result.toHexString();</span>
          } else {
<span class="fc" id="L202">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Bytes&quot;);</span>
          }
        }

        @Override
        public Bytes parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L210">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L212">            return result;</span>
          } else {
<span class="fc" id="L214">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an Bytes&quot;);
          }
        }

        @Override
        public Bytes parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L226">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">          if (result != null) {</span>
<span class="fc" id="L228">            return result;</span>
          } else {
<span class="fc" id="L230">            throw new CoercingParseLiteralException(&quot;Value is not any Bytes : '&quot; + input + &quot;'&quot;);</span>
          }
        }
      };

<span class="fc" id="L235">  private static final Coercing&lt;Bytes32, String&gt; BYTES32_COERCING =</span>
<span class="fc" id="L236">      new Coercing&lt;Bytes32, String&gt;() {</span>

        Bytes32 convertImpl(final Object input) {
<span class="fc bfc" id="L239" title="All 2 branches covered.">          if (input instanceof Bytes32 bytes32) {</span>
<span class="fc" id="L240">            return bytes32;</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">          } else if (input instanceof Bytes bytes) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (bytes.size() &lt;= 32) {</span>
<span class="nc" id="L243">              return Bytes32.leftPad((Bytes) input);</span>
            } else {
<span class="nc" id="L245">              return null;</span>
            }
<span class="fc bfc" id="L247" title="All 2 branches covered.">          } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L248">            return convertImpl(stringValue.getValue());</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">            if (!Quantity.isValid(string)) {</span>
<span class="fc" id="L251">              throw new CoercingParseLiteralException(</span>
                  &quot;Bytes32 value '&quot; + input + &quot;' is not prefixed with 0x&quot;);
            } else {
              try {
<span class="fc" id="L255">                return Bytes32.fromHexStringLenient((String) input);</span>
<span class="fc" id="L256">              } catch (IllegalArgumentException iae) {</span>
<span class="fc" id="L257">                return null;</span>
              }
            }
<span class="fc bfc" id="L260" title="All 2 branches covered.">          } else if (input instanceof VersionedHash versionedHash) {</span>
<span class="fc" id="L261">            return versionedHash.toBytes();</span>
          } else {
<span class="fc" id="L263">            return null;</span>
          }
        }

        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc" id="L271">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">          if (result == null) {</span>
<span class="fc" id="L273">            throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Bytes32&quot;);</span>
          } else {
<span class="fc" id="L275">            return result.toHexString();</span>
          }
        }

        @Override
        public Bytes32 parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc" id="L283">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">          if (result == null) {</span>
<span class="fc" id="L285">            throw new CoercingParseValueException(</span>
                &quot;Unable to parse variable value &quot; + input + &quot; as an Bytes32&quot;);
          } else {
<span class="fc" id="L288">            return result;</span>
          }
        }

        @Override
        public Bytes32 parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
<span class="fc" id="L299">          var result = convertImpl(input);</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">          if (result == null) {</span>
<span class="fc" id="L301">            throw new CoercingParseLiteralException(&quot;Value is not any Bytes32 : '&quot; + input + &quot;'&quot;);</span>
          } else {
<span class="fc" id="L303">            return result;</span>
          }
        }
      };

<span class="fc" id="L308">  private static final Coercing&lt;Number, String&gt; LONG_COERCING =</span>
<span class="fc" id="L309">      new Coercing&lt;&gt;() {</span>
        @Override
        public String serialize(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingSerializeException {
<span class="fc bfc" id="L314" title="All 2 branches covered.">          if (input instanceof Number number) {</span>
<span class="fc" id="L315">            return Bytes.ofUnsignedLong(number.longValue()).toQuantityHexString();</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">            if (string.startsWith(&quot;0x&quot;)) {</span>
<span class="fc" id="L318">              return string;</span>
            } else {
<span class="nc" id="L320">              return &quot;0x&quot; + string;</span>
            }
          }
<span class="fc" id="L323">          throw new CoercingSerializeException(&quot;Unable to serialize &quot; + input + &quot; as an Long&quot;);</span>
        }

        @Override
        public Number parseValue(
            final Object input, final GraphQLContext graphQLContext, final Locale locale)
            throws CoercingParseValueException {
<span class="fc bfc" id="L330" title="All 2 branches covered.">          if (input instanceof Number number) {</span>
<span class="fc" id="L331">            return number;</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">          } else if (input instanceof String string) {</span>
<span class="fc" id="L333">            final String value = string.toLowerCase(Locale.ROOT);</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">            if (value.startsWith(&quot;0x&quot;)) {</span>
<span class="fc" id="L335">              return Bytes.fromHexStringLenient(value).toLong();</span>
            } else {
<span class="nc" id="L337">              return Long.parseLong(value);</span>
            }
          }
<span class="fc" id="L340">          throw new CoercingParseValueException(</span>
              &quot;Unable to parse variable value &quot; + input + &quot; as an Long&quot;);
        }

        @Override
        public Number parseLiteral(
            final Value&lt;?&gt; input,
            final CoercedVariables variables,
            final GraphQLContext graphQLContext,
            final Locale locale)
            throws CoercingParseLiteralException {
          try {
<span class="fc bfc" id="L352" title="All 2 branches covered.">            if (input instanceof IntValue intValue) {</span>
<span class="fc" id="L353">              return intValue.getValue().longValue();</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">            } else if (input instanceof StringValue stringValue) {</span>
<span class="fc" id="L355">              final String value = stringValue.getValue().toLowerCase(Locale.ROOT);</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">              if (value.startsWith(&quot;0x&quot;)) {</span>
<span class="fc" id="L357">                return Bytes.fromHexStringLenient(value).toLong();</span>
              } else {
<span class="fc" id="L359">                return Long.parseLong(value);</span>
              }
            }
<span class="fc" id="L362">          } catch (final NumberFormatException e) {</span>
            // fall through
<span class="nc" id="L364">          }</span>
<span class="fc" id="L365">          throw new CoercingParseLiteralException(&quot;Value is not any Long : '&quot; + input + &quot;'&quot;);</span>
        }
      };

  public static GraphQLScalarType addressScalar() {
<span class="fc" id="L370">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L371">        .name(&quot;Address&quot;)</span>
<span class="fc" id="L372">        .description(&quot;Address scalar&quot;)</span>
<span class="fc" id="L373">        .coercing(ADDRESS_COERCING)</span>
<span class="fc" id="L374">        .build();</span>
  }

  public static GraphQLScalarType bigIntScalar() {
<span class="fc" id="L378">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L379">        .name(&quot;BigInt&quot;)</span>
<span class="fc" id="L380">        .description(&quot;A BigInt (UInt256) scalar&quot;)</span>
<span class="fc" id="L381">        .coercing(BIG_INT_COERCING)</span>
<span class="fc" id="L382">        .build();</span>
  }

  public static GraphQLScalarType bytesScalar() {
<span class="fc" id="L386">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L387">        .name(&quot;Bytes&quot;)</span>
<span class="fc" id="L388">        .description(&quot;A Bytes scalar&quot;)</span>
<span class="fc" id="L389">        .coercing(BYTES_COERCING)</span>
<span class="fc" id="L390">        .build();</span>
  }

  public static GraphQLScalarType bytes32Scalar() {
<span class="fc" id="L394">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L395">        .name(&quot;Bytes32&quot;)</span>
<span class="fc" id="L396">        .description(&quot;A Bytes32 scalar&quot;)</span>
<span class="fc" id="L397">        .coercing(BYTES32_COERCING)</span>
<span class="fc" id="L398">        .build();</span>
  }

  public static GraphQLScalarType longScalar() {
<span class="fc" id="L402">    return GraphQLScalarType.newScalar()</span>
<span class="fc" id="L403">        .name(&quot;Long&quot;)</span>
<span class="fc" id="L404">        .description(&quot;A Long (UInt64) scalar&quot;)</span>
<span class="fc" id="L405">        .coercing(LONG_COERCING)</span>
<span class="fc" id="L406">        .build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>