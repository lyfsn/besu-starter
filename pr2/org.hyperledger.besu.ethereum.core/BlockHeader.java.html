<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BlockHeader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.core</a> &gt; <span class="el_source">BlockHeader.java</span></div><h1>BlockHeader.java</h1><pre class="source lang-java linenums">/*
 * Copyright Hyperledger Besu Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.core;

import org.hyperledger.besu.datatypes.Address;
import org.hyperledger.besu.datatypes.BlobGas;
import org.hyperledger.besu.datatypes.Hash;
import org.hyperledger.besu.datatypes.Wei;
import org.hyperledger.besu.ethereum.rlp.RLPInput;
import org.hyperledger.besu.ethereum.rlp.RLPOutput;
import org.hyperledger.besu.evm.log.LogsBloomFilter;

import java.util.Objects;
import java.util.function.Supplier;

import com.google.common.base.Suppliers;
import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;

/** A mined Ethereum block header. */
public class BlockHeader extends SealableBlockHeader
    implements org.hyperledger.besu.plugin.data.BlockHeader {

  public static final int MAX_EXTRA_DATA_BYTES = 32;

  public static final long GENESIS_BLOCK_NUMBER = 0L;

  private final long nonce;

  private final Supplier&lt;Hash&gt; hash;

  private final Supplier&lt;ParsedExtraData&gt; parsedExtraData;

  public BlockHeader(
      final Hash parentHash,
      final Hash ommersHash,
      final Address coinbase,
      final Hash stateRoot,
      final Hash transactionsRoot,
      final Hash receiptsRoot,
      final LogsBloomFilter logsBloom,
      final Difficulty difficulty,
      final long number,
      final long gasLimit,
      final long gasUsed,
      final long timestamp,
      final Bytes extraData,
      final Wei baseFee,
      final Bytes32 mixHashOrPrevRandao,
      final long nonce,
      final Hash withdrawalsRoot,
      final Long blobGasUsed,
      final BlobGas excessBlobGas,
      final Bytes32 parentBeaconBlockRoot,
      final Hash depositsRoot,
      final Hash exitsRoot,
      final BlockHeaderFunctions blockHeaderFunctions) {
<span class="fc" id="L70">    super(</span>
        parentHash,
        ommersHash,
        coinbase,
        stateRoot,
        transactionsRoot,
        receiptsRoot,
        logsBloom,
        difficulty,
        number,
        gasLimit,
        gasUsed,
        timestamp,
        extraData,
        baseFee,
        mixHashOrPrevRandao,
        withdrawalsRoot,
        blobGasUsed,
        excessBlobGas,
        parentBeaconBlockRoot,
        depositsRoot,
        exitsRoot);
<span class="fc" id="L92">    this.nonce = nonce;</span>
<span class="fc" id="L93">    this.hash = Suppliers.memoize(() -&gt; blockHeaderFunctions.hash(this));</span>
<span class="fc" id="L94">    this.parsedExtraData = Suppliers.memoize(() -&gt; blockHeaderFunctions.parseExtraData(this));</span>
<span class="fc" id="L95">  }</span>

  /**
   * Returns the block mixed hash.
   *
   * @return the block mixed hash
   */
  @Override
  public Hash getMixHash() {
<span class="fc" id="L104">    return Hash.wrap(mixHashOrPrevRandao);</span>
  }

  /**
   * Returns the block nonce.
   *
   * @return the block nonce
   */
  @Override
  public long getNonce() {
<span class="fc" id="L114">    return nonce;</span>
  }

  /**
   * Returns the block extra data field, as parsed by the {@link BlockHeaderFunctions}.
   *
   * @return the block extra data field
   */
  public ParsedExtraData getParsedExtraData() {
<span class="fc" id="L123">    return parsedExtraData.get();</span>
  }

  /**
   * Returns the block header hash.
   *
   * @return the block header hash
   */
  public Hash getHash() {
<span class="fc" id="L132">    return hash.get();</span>
  }

  @Override
  public Hash getBlockHash() {
<span class="fc" id="L137">    return hash.get();</span>
  }

  /**
   * Write an RLP representation.
   *
   * @param out The RLP output to write to
   */
  public void writeTo(final RLPOutput out) {
<span class="fc" id="L146">    out.startList();</span>

<span class="fc" id="L148">    out.writeBytes(parentHash);</span>
<span class="fc" id="L149">    out.writeBytes(ommersHash);</span>
<span class="fc" id="L150">    out.writeBytes(coinbase);</span>
<span class="fc" id="L151">    out.writeBytes(stateRoot);</span>
<span class="fc" id="L152">    out.writeBytes(transactionsRoot);</span>
<span class="fc" id="L153">    out.writeBytes(receiptsRoot);</span>
<span class="fc" id="L154">    out.writeBytes(logsBloom);</span>
<span class="fc" id="L155">    out.writeUInt256Scalar(difficulty);</span>
<span class="fc" id="L156">    out.writeLongScalar(number);</span>
<span class="fc" id="L157">    out.writeLongScalar(gasLimit);</span>
<span class="fc" id="L158">    out.writeLongScalar(gasUsed);</span>
<span class="fc" id="L159">    out.writeLongScalar(timestamp);</span>
<span class="fc" id="L160">    out.writeBytes(extraData);</span>
<span class="fc" id="L161">    out.writeBytes(mixHashOrPrevRandao);</span>
<span class="fc" id="L162">    out.writeLong(nonce);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">    if (baseFee != null) {</span>
<span class="fc" id="L164">      out.writeUInt256Scalar(baseFee);</span>
    }
<span class="fc bfc" id="L166" title="All 2 branches covered.">    if (withdrawalsRoot != null) {</span>
<span class="fc" id="L167">      out.writeBytes(withdrawalsRoot);</span>
    }
<span class="fc bfc" id="L169" title="All 4 branches covered.">    if (excessBlobGas != null &amp;&amp; blobGasUsed != null) {</span>
<span class="fc" id="L170">      out.writeLongScalar(blobGasUsed);</span>
<span class="fc" id="L171">      out.writeUInt64Scalar(excessBlobGas);</span>
    }
<span class="fc bfc" id="L173" title="All 2 branches covered.">    if (parentBeaconBlockRoot != null) {</span>
<span class="fc" id="L174">      out.writeBytes(parentBeaconBlockRoot);</span>
    }
<span class="fc bfc" id="L176" title="All 2 branches covered.">    if (depositsRoot != null) {</span>
<span class="fc" id="L177">      out.writeBytes(depositsRoot);</span>
    }
<span class="fc bfc" id="L179" title="All 2 branches covered.">    if (exitsRoot != null) {</span>
<span class="fc" id="L180">      out.writeBytes(exitsRoot);</span>
    }
<span class="fc" id="L182">    out.endList();</span>
<span class="fc" id="L183">  }</span>

  public static BlockHeader readFrom(
      final RLPInput input, final BlockHeaderFunctions blockHeaderFunctions) {
<span class="fc" id="L187">    input.enterList();</span>
<span class="fc" id="L188">    final Hash parentHash = Hash.wrap(input.readBytes32());</span>
<span class="fc" id="L189">    final Hash ommersHash = Hash.wrap(input.readBytes32());</span>
<span class="fc" id="L190">    final Address coinbase = Address.readFrom(input);</span>
<span class="fc" id="L191">    final Hash stateRoot = Hash.wrap(input.readBytes32());</span>
<span class="fc" id="L192">    final Hash transactionsRoot = Hash.wrap(input.readBytes32());</span>
<span class="fc" id="L193">    final Hash receiptsRoot = Hash.wrap(input.readBytes32());</span>
<span class="fc" id="L194">    final LogsBloomFilter logsBloom = LogsBloomFilter.readFrom(input);</span>
<span class="fc" id="L195">    final Difficulty difficulty = Difficulty.of(input.readUInt256Scalar());</span>
<span class="fc" id="L196">    final long number = input.readLongScalar();</span>
<span class="fc" id="L197">    final long gasLimit = input.readLongScalar();</span>
<span class="fc" id="L198">    final long gasUsed = input.readLongScalar();</span>
<span class="fc" id="L199">    final long timestamp = input.readLongScalar();</span>
<span class="fc" id="L200">    final Bytes extraData = input.readBytes();</span>
<span class="fc" id="L201">    final Bytes32 mixHashOrPrevRandao = input.readBytes32();</span>
<span class="fc" id="L202">    final long nonce = input.readLong();</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">    final Wei baseFee = !input.isEndOfCurrentList() ? Wei.of(input.readUInt256Scalar()) : null;</span>
    final Hash withdrawalHashRoot =
<span class="pc bpc" id="L205" title="1 of 4 branches missed.">        !(input.isEndOfCurrentList() || input.isZeroLengthString())</span>
<span class="fc" id="L206">            ? Hash.wrap(input.readBytes32())</span>
<span class="fc" id="L207">            : null;</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">    final Long blobGasUsed = !input.isEndOfCurrentList() ? input.readLongScalar() : null;</span>
    final BlobGas excessBlobGas =
<span class="fc bfc" id="L210" title="All 2 branches covered.">        !input.isEndOfCurrentList() ? BlobGas.of(input.readUInt64Scalar()) : null;</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">    final Bytes32 parentBeaconBlockRoot = !input.isEndOfCurrentList() ? input.readBytes32() : null;</span>
    final Hash depositHashRoot =
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        !input.isEndOfCurrentList() ? Hash.wrap(input.readBytes32()) : null;</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">    final Hash exitsHashRoot = !input.isEndOfCurrentList() ? Hash.wrap(input.readBytes32()) : null;</span>
<span class="fc" id="L215">    input.leaveList();</span>
<span class="fc" id="L216">    return new BlockHeader(</span>
        parentHash,
        ommersHash,
        coinbase,
        stateRoot,
        transactionsRoot,
        receiptsRoot,
        logsBloom,
        difficulty,
        number,
        gasLimit,
        gasUsed,
        timestamp,
        extraData,
        baseFee,
        mixHashOrPrevRandao,
        nonce,
        withdrawalHashRoot,
        blobGasUsed,
        excessBlobGas,
        parentBeaconBlockRoot,
        depositHashRoot,
        exitsHashRoot,
        blockHeaderFunctions);
  }

  @Override
  public boolean equals(final Object obj) {
<span class="fc bfc" id="L244" title="All 2 branches covered.">    if (obj == this) {</span>
<span class="fc" id="L245">      return true;</span>
    }
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">    if (!(obj instanceof BlockHeader other)) {</span>
<span class="nc" id="L248">      return false;</span>
    }
<span class="fc" id="L250">    return getHash().equals(other.getHash());</span>
  }

  @Override
  public int hashCode() {
<span class="fc" id="L255">    return Objects.hash(getHash());</span>
  }

  @Override
  public String toString() {
<span class="fc" id="L260">    final StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L261">    sb.append(&quot;BlockHeader{&quot;);</span>
<span class="fc" id="L262">    sb.append(&quot;number=&quot;).append(number).append(&quot;, &quot;);</span>
<span class="fc" id="L263">    sb.append(&quot;hash=&quot;).append(getHash()).append(&quot;, &quot;);</span>
<span class="fc" id="L264">    sb.append(&quot;parentHash=&quot;).append(parentHash).append(&quot;, &quot;);</span>
<span class="fc" id="L265">    sb.append(&quot;ommersHash=&quot;).append(ommersHash).append(&quot;, &quot;);</span>
<span class="fc" id="L266">    sb.append(&quot;coinbase=&quot;).append(coinbase).append(&quot;, &quot;);</span>
<span class="fc" id="L267">    sb.append(&quot;stateRoot=&quot;).append(stateRoot).append(&quot;, &quot;);</span>
<span class="fc" id="L268">    sb.append(&quot;transactionsRoot=&quot;).append(transactionsRoot).append(&quot;, &quot;);</span>
<span class="fc" id="L269">    sb.append(&quot;receiptsRoot=&quot;).append(receiptsRoot).append(&quot;, &quot;);</span>
<span class="fc" id="L270">    sb.append(&quot;logsBloom=&quot;).append(logsBloom).append(&quot;, &quot;);</span>
<span class="fc" id="L271">    sb.append(&quot;difficulty=&quot;).append(difficulty).append(&quot;, &quot;);</span>
<span class="fc" id="L272">    sb.append(&quot;gasLimit=&quot;).append(gasLimit).append(&quot;, &quot;);</span>
<span class="fc" id="L273">    sb.append(&quot;gasUsed=&quot;).append(gasUsed).append(&quot;, &quot;);</span>
<span class="fc" id="L274">    sb.append(&quot;timestamp=&quot;).append(timestamp).append(&quot;, &quot;);</span>
<span class="fc" id="L275">    sb.append(&quot;extraData=&quot;).append(extraData).append(&quot;, &quot;);</span>
<span class="fc" id="L276">    sb.append(&quot;baseFee=&quot;).append(baseFee).append(&quot;, &quot;);</span>
<span class="fc" id="L277">    sb.append(&quot;mixHashOrPrevRandao=&quot;).append(mixHashOrPrevRandao).append(&quot;, &quot;);</span>
<span class="fc" id="L278">    sb.append(&quot;nonce=&quot;).append(nonce).append(&quot;, &quot;);</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">    if (withdrawalsRoot != null) {</span>
<span class="fc" id="L280">      sb.append(&quot;withdrawalsRoot=&quot;).append(withdrawalsRoot).append(&quot;, &quot;);</span>
    }
<span class="pc bpc" id="L282" title="3 of 4 branches missed.">    if (blobGasUsed != null &amp;&amp; excessBlobGas != null) {</span>
<span class="nc" id="L283">      sb.append(&quot;blobGasUsed=&quot;).append(blobGasUsed).append(&quot;, &quot;);</span>
<span class="nc" id="L284">      sb.append(&quot;excessBlobGas=&quot;).append(excessBlobGas).append(&quot;, &quot;);</span>
    }
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">    if (parentBeaconBlockRoot != null) {</span>
<span class="nc" id="L287">      sb.append(&quot;parentBeaconBlockRoot=&quot;).append(parentBeaconBlockRoot).append(&quot;, &quot;);</span>
    }
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">    if (depositsRoot != null) {</span>
<span class="nc" id="L290">      sb.append(&quot;depositsRoot=&quot;).append(depositsRoot);</span>
    }
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">    if (exitsRoot != null) {</span>
<span class="nc" id="L293">      sb.append(&quot;exitsRoot=&quot;).append(exitsRoot);</span>
    }
<span class="fc" id="L295">    return sb.append(&quot;}&quot;).toString();</span>
  }

  public static org.hyperledger.besu.ethereum.core.BlockHeader convertPluginBlockHeader(
      final org.hyperledger.besu.plugin.data.BlockHeader pluginBlockHeader,
      final BlockHeaderFunctions blockHeaderFunctions) {
<span class="nc" id="L301">    return new org.hyperledger.besu.ethereum.core.BlockHeader(</span>
<span class="nc" id="L302">        Hash.fromHexString(pluginBlockHeader.getParentHash().toHexString()),</span>
<span class="nc" id="L303">        Hash.fromHexString(pluginBlockHeader.getOmmersHash().toHexString()),</span>
<span class="nc" id="L304">        Address.fromHexString(pluginBlockHeader.getCoinbase().toHexString()),</span>
<span class="nc" id="L305">        Hash.fromHexString(pluginBlockHeader.getStateRoot().toHexString()),</span>
<span class="nc" id="L306">        Hash.fromHexString(pluginBlockHeader.getTransactionsRoot().toHexString()),</span>
<span class="nc" id="L307">        Hash.fromHexString(pluginBlockHeader.getReceiptsRoot().toHexString()),</span>
<span class="nc" id="L308">        LogsBloomFilter.fromHexString(pluginBlockHeader.getLogsBloom().toHexString()),</span>
<span class="nc" id="L309">        Difficulty.fromHexString(pluginBlockHeader.getDifficulty().toHexString()),</span>
<span class="nc" id="L310">        pluginBlockHeader.getNumber(),</span>
<span class="nc" id="L311">        pluginBlockHeader.getGasLimit(),</span>
<span class="nc" id="L312">        pluginBlockHeader.getGasUsed(),</span>
<span class="nc" id="L313">        pluginBlockHeader.getTimestamp(),</span>
<span class="nc" id="L314">        pluginBlockHeader.getExtraData(),</span>
<span class="nc" id="L315">        pluginBlockHeader.getBaseFee().map(Wei::fromQuantity).orElse(null),</span>
<span class="nc" id="L316">        pluginBlockHeader.getPrevRandao().orElse(null),</span>
<span class="nc" id="L317">        pluginBlockHeader.getNonce(),</span>
        pluginBlockHeader
<span class="nc" id="L319">            .getWithdrawalsRoot()</span>
<span class="nc" id="L320">            .map(h -&gt; Hash.fromHexString(h.toHexString()))</span>
<span class="nc" id="L321">            .orElse(null),</span>
<span class="nc" id="L322">        pluginBlockHeader.getBlobGasUsed().map(Long::longValue).orElse(null),</span>
<span class="nc" id="L323">        pluginBlockHeader.getExcessBlobGas().map(BlobGas::fromQuantity).orElse(null),</span>
<span class="nc" id="L324">        pluginBlockHeader.getParentBeaconBlockRoot().orElse(null),</span>
        pluginBlockHeader
<span class="nc" id="L326">            .getDepositsRoot()</span>
<span class="nc" id="L327">            .map(h -&gt; Hash.fromHexString(h.toHexString()))</span>
<span class="nc" id="L328">            .orElse(null),</span>
<span class="nc" id="L329">        pluginBlockHeader.getExitsRoot().map(h -&gt; Hash.fromHexString(h.toHexString())).orElse(null),</span>
        blockHeaderFunctions);
  }

  @Override
  public String toLogString() {
<span class="fc" id="L335">    return getNumber() + &quot; (&quot; + getHash() + &quot;)&quot;;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>