<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProtocolScheduleBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.mainnet</a> &gt; <span class="el_source">ProtocolScheduleBuilder.java</span></div><h1>ProtocolScheduleBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.mainnet;

import org.hyperledger.besu.config.GenesisConfigOptions;
import org.hyperledger.besu.ethereum.chain.BadBlockManager;
import org.hyperledger.besu.ethereum.core.MiningParameters;
import org.hyperledger.besu.ethereum.core.PrivacyParameters;
import org.hyperledger.besu.ethereum.privacy.PrivateTransactionValidator;
import org.hyperledger.besu.evm.internal.EvmConfiguration;

import java.math.BigInteger;
import java.util.NavigableMap;
import java.util.Optional;
import java.util.OptionalLong;
import java.util.TreeMap;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ProtocolScheduleBuilder {

<span class="fc" id="L38">  private static final Logger LOG = LoggerFactory.getLogger(ProtocolScheduleBuilder.class);</span>
  private final GenesisConfigOptions config;
  private final Optional&lt;BigInteger&gt; defaultChainId;
  private final ProtocolSpecAdapters protocolSpecAdapters;
  private final PrivacyParameters privacyParameters;
  private final boolean isRevertReasonEnabled;
  private final EvmConfiguration evmConfiguration;
  private final MiningParameters miningParameters;
  private final BadBlockManager badBlockManager;

  private DefaultProtocolSchedule protocolSchedule;

  public ProtocolScheduleBuilder(
      final GenesisConfigOptions config,
      final BigInteger defaultChainId,
      final ProtocolSpecAdapters protocolSpecAdapters,
      final PrivacyParameters privacyParameters,
      final boolean isRevertReasonEnabled,
      final EvmConfiguration evmConfiguration,
      final MiningParameters miningParameters,
      final BadBlockManager badBlockManager) {
<span class="fc" id="L59">    this(</span>
        config,
<span class="fc" id="L61">        Optional.of(defaultChainId),</span>
        protocolSpecAdapters,
        privacyParameters,
        isRevertReasonEnabled,
        evmConfiguration,
        miningParameters,
        badBlockManager);
<span class="fc" id="L68">  }</span>

  public ProtocolScheduleBuilder(
      final GenesisConfigOptions config,
      final ProtocolSpecAdapters protocolSpecAdapters,
      final PrivacyParameters privacyParameters,
      final boolean isRevertReasonEnabled,
      final EvmConfiguration evmConfiguration,
      final MiningParameters miningParameters,
      final BadBlockManager badBlockManager) {
<span class="fc" id="L78">    this(</span>
        config,
<span class="fc" id="L80">        Optional.empty(),</span>
        protocolSpecAdapters,
        privacyParameters,
        isRevertReasonEnabled,
        evmConfiguration,
        miningParameters,
        badBlockManager);
<span class="fc" id="L87">  }</span>

  private ProtocolScheduleBuilder(
      final GenesisConfigOptions config,
      final Optional&lt;BigInteger&gt; defaultChainId,
      final ProtocolSpecAdapters protocolSpecAdapters,
      final PrivacyParameters privacyParameters,
      final boolean isRevertReasonEnabled,
      final EvmConfiguration evmConfiguration,
      final MiningParameters miningParameters,
<span class="fc" id="L97">      final BadBlockManager badBlockManager) {</span>
<span class="fc" id="L98">    this.config = config;</span>
<span class="fc" id="L99">    this.protocolSpecAdapters = protocolSpecAdapters;</span>
<span class="fc" id="L100">    this.privacyParameters = privacyParameters;</span>
<span class="fc" id="L101">    this.isRevertReasonEnabled = isRevertReasonEnabled;</span>
<span class="fc" id="L102">    this.evmConfiguration = evmConfiguration;</span>
<span class="fc" id="L103">    this.defaultChainId = defaultChainId;</span>
<span class="fc" id="L104">    this.miningParameters = miningParameters;</span>
<span class="fc" id="L105">    this.badBlockManager = badBlockManager;</span>
<span class="fc" id="L106">  }</span>

  public ProtocolSchedule createProtocolSchedule() {
<span class="fc" id="L109">    final Optional&lt;BigInteger&gt; chainId = config.getChainId().or(() -&gt; defaultChainId);</span>
<span class="fc" id="L110">    protocolSchedule = new DefaultProtocolSchedule(chainId);</span>
<span class="fc" id="L111">    initSchedule(protocolSchedule, chainId);</span>
<span class="fc" id="L112">    return protocolSchedule;</span>
  }

  private void initSchedule(
      final ProtocolSchedule protocolSchedule, final Optional&lt;BigInteger&gt; chainId) {

<span class="fc" id="L118">    final MainnetProtocolSpecFactory specFactory =</span>
        new MainnetProtocolSpecFactory(
            chainId,
<span class="fc" id="L121">            config.getContractSizeLimit(),</span>
<span class="fc" id="L122">            config.getEvmStackSize(),</span>
            isRevertReasonEnabled,
<span class="fc" id="L124">            config.getEcip1017EraRounds(),</span>
            evmConfiguration,
            miningParameters);

<span class="fc" id="L128">    validateForkOrdering();</span>

<span class="fc" id="L130">    final NavigableMap&lt;Long, BuilderMapEntry&gt; builders = buildMilestoneMap(specFactory);</span>

    // At this stage, all milestones are flagged with correct modifier, but ProtocolSpecs must be
    // inserted _AT_ the modifier block entry.
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">    if (!builders.isEmpty()) {</span>
<span class="fc" id="L135">      protocolSpecAdapters.stream()</span>
<span class="fc" id="L136">          .forEach(</span>
              entry -&gt; {
<span class="fc" id="L138">                final long modifierBlock = entry.getKey();</span>
<span class="fc" id="L139">                final BuilderMapEntry parent =</span>
<span class="fc" id="L140">                    Optional.ofNullable(builders.floorEntry(modifierBlock))</span>
<span class="fc" id="L141">                        .orElse(builders.firstEntry())</span>
<span class="fc" id="L142">                        .getValue();</span>
<span class="fc" id="L143">                builders.put(</span>
<span class="fc" id="L144">                    modifierBlock,</span>
                    new BuilderMapEntry(
                        parent.milestoneType,
                        modifierBlock,
<span class="fc" id="L148">                        parent.getBuilder(),</span>
<span class="fc" id="L149">                        entry.getValue()));</span>
<span class="fc" id="L150">              });</span>
    }

    // Create the ProtocolSchedule, such that the Dao/fork milestones can be inserted
<span class="fc" id="L154">    builders</span>
<span class="fc" id="L155">        .values()</span>
<span class="fc" id="L156">        .forEach(</span>
            e -&gt;
<span class="fc" id="L158">                addProtocolSpec(</span>
                    protocolSchedule,
                    e.milestoneType,
<span class="fc" id="L161">                    e.getBlockIdentifier(),</span>
<span class="fc" id="L162">                    e.getBuilder(),</span>
                    e.modifier));

    // NOTE: It is assumed that Daofork blocks will not be used for private networks
    // as too many risks exist around inserting a protocol-spec between daoBlock and daoBlock+10.
<span class="fc" id="L167">    config</span>
<span class="fc" id="L168">        .getDaoForkBlock()</span>
<span class="fc" id="L169">        .ifPresent(</span>
            daoBlockNumber -&gt; {
<span class="fc" id="L171">              final BuilderMapEntry previousSpecBuilder =</span>
<span class="fc" id="L172">                  builders.floorEntry(daoBlockNumber).getValue();</span>
<span class="fc" id="L173">              final ProtocolSpec originalProtocolSpec =</span>
<span class="fc" id="L174">                  getProtocolSpec(</span>
                      protocolSchedule,
<span class="fc" id="L176">                      previousSpecBuilder.getBuilder(),</span>
<span class="fc" id="L177">                      previousSpecBuilder.getModifier());</span>
<span class="fc" id="L178">              addProtocolSpec(</span>
                  protocolSchedule,
                  BuilderMapEntry.MilestoneType.BLOCK_NUMBER,
                  daoBlockNumber,
<span class="fc" id="L182">                  specFactory.daoRecoveryInitDefinition(),</span>
<span class="fc" id="L183">                  protocolSpecAdapters.getModifierForBlock(daoBlockNumber));</span>
<span class="fc" id="L184">              addProtocolSpec(</span>
                  protocolSchedule,
                  BuilderMapEntry.MilestoneType.BLOCK_NUMBER,
                  daoBlockNumber + 1L,
<span class="fc" id="L188">                  specFactory.daoRecoveryTransitionDefinition(),</span>
<span class="fc" id="L189">                  protocolSpecAdapters.getModifierForBlock(daoBlockNumber + 1L));</span>
              // Return to the previous protocol spec after the dao fork has completed.
<span class="fc" id="L191">              protocolSchedule.putBlockNumberMilestone(daoBlockNumber + 10, originalProtocolSpec);</span>
<span class="fc" id="L192">            });</span>

    // specs for classic network
<span class="fc" id="L195">    config</span>
<span class="fc" id="L196">        .getClassicForkBlock()</span>
<span class="fc" id="L197">        .ifPresent(</span>
            classicBlockNumber -&gt; {
<span class="fc" id="L199">              final BuilderMapEntry previousSpecBuilder =</span>
<span class="fc" id="L200">                  builders.floorEntry(classicBlockNumber).getValue();</span>
<span class="fc" id="L201">              final ProtocolSpec originalProtocolSpec =</span>
<span class="fc" id="L202">                  getProtocolSpec(</span>
                      protocolSchedule,
<span class="fc" id="L204">                      previousSpecBuilder.getBuilder(),</span>
<span class="fc" id="L205">                      previousSpecBuilder.getModifier());</span>
<span class="fc" id="L206">              addProtocolSpec(</span>
                  protocolSchedule,
                  BuilderMapEntry.MilestoneType.BLOCK_NUMBER,
                  classicBlockNumber,
<span class="fc" id="L210">                  ClassicProtocolSpecs.classicRecoveryInitDefinition(</span>
<span class="fc" id="L211">                      config.getContractSizeLimit(), config.getEvmStackSize(), evmConfiguration),</span>
<span class="fc" id="L212">                  Function.identity());</span>
<span class="fc" id="L213">              protocolSchedule.putBlockNumberMilestone(</span>
                  classicBlockNumber + 1, originalProtocolSpec);
<span class="fc" id="L215">            });</span>

<span class="fc" id="L217">    LOG.info(&quot;Protocol schedule created with milestones: {}&quot;, protocolSchedule.listMilestones());</span>
<span class="fc" id="L218">  }</span>

  private void validateForkOrdering() {
<span class="fc bfc" id="L221" title="All 2 branches covered.">    if (config.getDaoForkBlock().isEmpty()) {</span>
<span class="fc" id="L222">      validateClassicForkOrdering();</span>
    } else {
<span class="fc" id="L224">      validateEthereumForkOrdering();</span>
    }
<span class="fc" id="L226">  }</span>

  private void validateEthereumForkOrdering() {
<span class="fc" id="L229">    long lastForkBlock = 0;</span>
<span class="fc" id="L230">    lastForkBlock = validateForkOrder(&quot;Homestead&quot;, config.getHomesteadBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L231">    lastForkBlock = validateForkOrder(&quot;DaoFork&quot;, config.getDaoForkBlock(), lastForkBlock);</span>
<span class="fc" id="L232">    lastForkBlock =</span>
<span class="fc" id="L233">        validateForkOrder(</span>
<span class="fc" id="L234">            &quot;TangerineWhistle&quot;, config.getTangerineWhistleBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L235">    lastForkBlock =</span>
<span class="fc" id="L236">        validateForkOrder(&quot;SpuriousDragon&quot;, config.getSpuriousDragonBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L237">    lastForkBlock = validateForkOrder(&quot;Byzantium&quot;, config.getByzantiumBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L238">    lastForkBlock =</span>
<span class="fc" id="L239">        validateForkOrder(&quot;Constantinople&quot;, config.getConstantinopleBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L240">    lastForkBlock =</span>
<span class="fc" id="L241">        validateForkOrder(&quot;Petersburg&quot;, config.getPetersburgBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L242">    lastForkBlock = validateForkOrder(&quot;Istanbul&quot;, config.getIstanbulBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L243">    lastForkBlock =</span>
<span class="fc" id="L244">        validateForkOrder(&quot;MuirGlacier&quot;, config.getMuirGlacierBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L245">    lastForkBlock = validateForkOrder(&quot;Berlin&quot;, config.getBerlinBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L246">    lastForkBlock = validateForkOrder(&quot;London&quot;, config.getLondonBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L247">    lastForkBlock =</span>
<span class="fc" id="L248">        validateForkOrder(&quot;ArrowGlacier&quot;, config.getArrowGlacierBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L249">    lastForkBlock =</span>
<span class="fc" id="L250">        validateForkOrder(&quot;GrayGlacier&quot;, config.getGrayGlacierBlockNumber(), lastForkBlock);</span>
    // Begin timestamp forks
<span class="fc" id="L252">    lastForkBlock = validateForkOrder(&quot;Shanghai&quot;, config.getShanghaiTime(), lastForkBlock);</span>
<span class="fc" id="L253">    lastForkBlock = validateForkOrder(&quot;Cancun&quot;, config.getCancunTime(), lastForkBlock);</span>
<span class="fc" id="L254">    lastForkBlock = validateForkOrder(&quot;Prague&quot;, config.getPragueTime(), lastForkBlock);</span>
<span class="fc" id="L255">    lastForkBlock = validateForkOrder(&quot;FutureEips&quot;, config.getFutureEipsTime(), lastForkBlock);</span>
<span class="fc" id="L256">    lastForkBlock =</span>
<span class="fc" id="L257">        validateForkOrder(&quot;ExperimentalEips&quot;, config.getExperimentalEipsTime(), lastForkBlock);</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">    assert (lastForkBlock &gt;= 0);</span>
<span class="fc" id="L259">  }</span>

  private void validateClassicForkOrdering() {
<span class="fc" id="L262">    long lastForkBlock = 0;</span>
<span class="fc" id="L263">    lastForkBlock = validateForkOrder(&quot;Homestead&quot;, config.getHomesteadBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L264">    lastForkBlock =</span>
<span class="fc" id="L265">        validateForkOrder(</span>
<span class="fc" id="L266">            &quot;ClassicTangerineWhistle&quot;, config.getEcip1015BlockNumber(), lastForkBlock);</span>
<span class="fc" id="L267">    lastForkBlock = validateForkOrder(&quot;DieHard&quot;, config.getDieHardBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L268">    lastForkBlock = validateForkOrder(&quot;Gotham&quot;, config.getGothamBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L269">    lastForkBlock =</span>
<span class="fc" id="L270">        validateForkOrder(</span>
<span class="fc" id="L271">            &quot;DefuseDifficultyBomb&quot;, config.getDefuseDifficultyBombBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L272">    lastForkBlock = validateForkOrder(&quot;Atlantis&quot;, config.getAtlantisBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L273">    lastForkBlock = validateForkOrder(&quot;Agharta&quot;, config.getAghartaBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L274">    lastForkBlock = validateForkOrder(&quot;Phoenix&quot;, config.getPhoenixBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L275">    lastForkBlock = validateForkOrder(&quot;Thanos&quot;, config.getThanosBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L276">    lastForkBlock = validateForkOrder(&quot;Magneto&quot;, config.getMagnetoBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L277">    lastForkBlock = validateForkOrder(&quot;Mystique&quot;, config.getMystiqueBlockNumber(), lastForkBlock);</span>
<span class="fc" id="L278">    lastForkBlock = validateForkOrder(&quot;Spiral&quot;, config.getSpiralBlockNumber(), lastForkBlock);</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">    assert (lastForkBlock &gt;= 0);</span>
<span class="fc" id="L280">  }</span>

  private long validateForkOrder(
      final String forkName, final OptionalLong thisForkBlock, final long lastForkBlock) {
<span class="fc" id="L284">    final long referenceForkBlock = thisForkBlock.orElse(lastForkBlock);</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">    if (lastForkBlock &gt; referenceForkBlock) {</span>
<span class="fc" id="L286">      throw new RuntimeException(</span>
<span class="fc" id="L287">          String.format(</span>
              &quot;Genesis Config Error: '%s' is scheduled for milestone %d but it must be on or after milestone %d.&quot;,
<span class="fc" id="L289">              forkName, thisForkBlock.getAsLong(), lastForkBlock));</span>
    }
<span class="fc" id="L291">    return referenceForkBlock;</span>
  }

  private NavigableMap&lt;Long, BuilderMapEntry&gt; buildMilestoneMap(
      final MainnetProtocolSpecFactory specFactory) {
<span class="fc" id="L296">    return createMilestones(specFactory)</span>
<span class="fc" id="L297">        .flatMap(Optional::stream)</span>
<span class="fc" id="L298">        .collect(</span>
<span class="fc" id="L299">            Collectors.toMap(</span>
                BuilderMapEntry::getBlockIdentifier,
<span class="fc" id="L301">                b -&gt; b,</span>
<span class="fc" id="L302">                (existing, replacement) -&gt; replacement,</span>
                TreeMap::new));
  }

  private Stream&lt;Optional&lt;BuilderMapEntry&gt;&gt; createMilestones(
      final MainnetProtocolSpecFactory specFactory) {
<span class="fc" id="L308">    return Stream.of(</span>
<span class="fc" id="L309">        blockNumberMilestone(OptionalLong.of(0), specFactory.frontierDefinition()),</span>
<span class="fc" id="L310">        blockNumberMilestone(config.getHomesteadBlockNumber(), specFactory.homesteadDefinition()),</span>
<span class="fc" id="L311">        blockNumberMilestone(</span>
<span class="fc" id="L312">            config.getTangerineWhistleBlockNumber(), specFactory.tangerineWhistleDefinition()),</span>
<span class="fc" id="L313">        blockNumberMilestone(</span>
<span class="fc" id="L314">            config.getSpuriousDragonBlockNumber(), specFactory.spuriousDragonDefinition()),</span>
<span class="fc" id="L315">        blockNumberMilestone(config.getByzantiumBlockNumber(), specFactory.byzantiumDefinition()),</span>
<span class="fc" id="L316">        blockNumberMilestone(</span>
<span class="fc" id="L317">            config.getConstantinopleBlockNumber(), specFactory.constantinopleDefinition()),</span>
<span class="fc" id="L318">        blockNumberMilestone(config.getPetersburgBlockNumber(), specFactory.petersburgDefinition()),</span>
<span class="fc" id="L319">        blockNumberMilestone(config.getIstanbulBlockNumber(), specFactory.istanbulDefinition()),</span>
<span class="fc" id="L320">        blockNumberMilestone(</span>
<span class="fc" id="L321">            config.getMuirGlacierBlockNumber(), specFactory.muirGlacierDefinition()),</span>
<span class="fc" id="L322">        blockNumberMilestone(config.getBerlinBlockNumber(), specFactory.berlinDefinition()),</span>
<span class="fc" id="L323">        blockNumberMilestone(config.getLondonBlockNumber(), specFactory.londonDefinition(config)),</span>
<span class="fc" id="L324">        blockNumberMilestone(</span>
<span class="fc" id="L325">            config.getArrowGlacierBlockNumber(), specFactory.arrowGlacierDefinition(config)),</span>
<span class="fc" id="L326">        blockNumberMilestone(</span>
<span class="fc" id="L327">            config.getGrayGlacierBlockNumber(), specFactory.grayGlacierDefinition(config)),</span>
<span class="fc" id="L328">        blockNumberMilestone(</span>
<span class="fc" id="L329">            config.getMergeNetSplitBlockNumber(), specFactory.parisDefinition(config)),</span>
        // Timestamp Forks
<span class="fc" id="L331">        timestampMilestone(config.getShanghaiTime(), specFactory.shanghaiDefinition(config)),</span>
<span class="fc" id="L332">        timestampMilestone(config.getCancunTime(), specFactory.cancunDefinition(config)),</span>
<span class="fc" id="L333">        timestampMilestone(config.getPragueTime(), specFactory.pragueDefinition(config)),</span>
<span class="fc" id="L334">        timestampMilestone(config.getFutureEipsTime(), specFactory.futureEipsDefinition(config)),</span>
<span class="fc" id="L335">        timestampMilestone(</span>
<span class="fc" id="L336">            config.getExperimentalEipsTime(), specFactory.experimentalEipsDefinition(config)),</span>

        // Classic Milestones
<span class="fc" id="L339">        blockNumberMilestone(</span>
<span class="fc" id="L340">            config.getEcip1015BlockNumber(), specFactory.tangerineWhistleDefinition()),</span>
<span class="fc" id="L341">        blockNumberMilestone(config.getDieHardBlockNumber(), specFactory.dieHardDefinition()),</span>
<span class="fc" id="L342">        blockNumberMilestone(config.getGothamBlockNumber(), specFactory.gothamDefinition()),</span>
<span class="fc" id="L343">        blockNumberMilestone(</span>
<span class="fc" id="L344">            config.getDefuseDifficultyBombBlockNumber(),</span>
<span class="fc" id="L345">            specFactory.defuseDifficultyBombDefinition()),</span>
<span class="fc" id="L346">        blockNumberMilestone(config.getAtlantisBlockNumber(), specFactory.atlantisDefinition()),</span>
<span class="fc" id="L347">        blockNumberMilestone(config.getAghartaBlockNumber(), specFactory.aghartaDefinition()),</span>
<span class="fc" id="L348">        blockNumberMilestone(config.getPhoenixBlockNumber(), specFactory.phoenixDefinition()),</span>
<span class="fc" id="L349">        blockNumberMilestone(config.getThanosBlockNumber(), specFactory.thanosDefinition()),</span>
<span class="fc" id="L350">        blockNumberMilestone(config.getMagnetoBlockNumber(), specFactory.magnetoDefinition()),</span>
<span class="fc" id="L351">        blockNumberMilestone(config.getMystiqueBlockNumber(), specFactory.mystiqueDefinition()),</span>
<span class="fc" id="L352">        blockNumberMilestone(config.getSpiralBlockNumber(), specFactory.spiralDefinition()));</span>
  }

  private Optional&lt;BuilderMapEntry&gt; timestampMilestone(
      final OptionalLong blockIdentifier, final ProtocolSpecBuilder builder) {
<span class="fc" id="L357">    return createMilestone(blockIdentifier, builder, BuilderMapEntry.MilestoneType.TIMESTAMP);</span>
  }

  private Optional&lt;BuilderMapEntry&gt; blockNumberMilestone(
      final OptionalLong blockIdentifier, final ProtocolSpecBuilder builder) {
<span class="fc" id="L362">    return createMilestone(blockIdentifier, builder, BuilderMapEntry.MilestoneType.BLOCK_NUMBER);</span>
  }

  private Optional&lt;BuilderMapEntry&gt; createMilestone(
      final OptionalLong blockIdentifier,
      final ProtocolSpecBuilder builder,
      final BuilderMapEntry.MilestoneType milestoneType) {
<span class="fc bfc" id="L369" title="All 2 branches covered.">    if (blockIdentifier.isEmpty()) {</span>
<span class="fc" id="L370">      return Optional.empty();</span>
    }
<span class="fc" id="L372">    final long blockVal = blockIdentifier.getAsLong();</span>
<span class="fc" id="L373">    return Optional.of(</span>
        new BuilderMapEntry(
<span class="fc" id="L375">            milestoneType, blockVal, builder, protocolSpecAdapters.getModifierForBlock(blockVal)));</span>
  }

  private ProtocolSpec getProtocolSpec(
      final ProtocolSchedule protocolSchedule,
      final ProtocolSpecBuilder definition,
      final Function&lt;ProtocolSpecBuilder, ProtocolSpecBuilder&gt; modifier) {
<span class="fc" id="L382">    definition</span>
<span class="fc" id="L383">        .badBlocksManager(badBlockManager)</span>
<span class="fc" id="L384">        .privacyParameters(privacyParameters)</span>
<span class="fc" id="L385">        .privateTransactionValidatorBuilder(</span>
<span class="fc" id="L386">            () -&gt; new PrivateTransactionValidator(protocolSchedule.getChainId()));</span>

<span class="fc" id="L388">    return modifier.apply(definition).build(protocolSchedule);</span>
  }

  private void addProtocolSpec(
      final ProtocolSchedule protocolSchedule,
      final BuilderMapEntry.MilestoneType milestoneType,
      final long blockNumberOrTimestamp,
      final ProtocolSpecBuilder definition,
      final Function&lt;ProtocolSpecBuilder, ProtocolSpecBuilder&gt; modifier) {

<span class="pc bpc" id="L398" title="1 of 3 branches missed.">    switch (milestoneType) {</span>
      case BLOCK_NUMBER -&gt;
<span class="fc" id="L400">          protocolSchedule.putBlockNumberMilestone(</span>
<span class="fc" id="L401">              blockNumberOrTimestamp, getProtocolSpec(protocolSchedule, definition, modifier));</span>
      case TIMESTAMP -&gt;
<span class="fc" id="L403">          protocolSchedule.putTimestampMilestone(</span>
<span class="fc" id="L404">              blockNumberOrTimestamp, getProtocolSpec(protocolSchedule, definition, modifier));</span>
      default -&gt;
<span class="nc" id="L406">          throw new IllegalStateException(</span>
              &quot;Unexpected milestoneType: &quot;
                  + milestoneType
                  + &quot; for milestone: &quot;
                  + blockNumberOrTimestamp);
    }
<span class="fc" id="L412">  }</span>

  private static class BuilderMapEntry {
    private final MilestoneType milestoneType;
    private final long blockIdentifier;
    private final ProtocolSpecBuilder builder;
    private final Function&lt;ProtocolSpecBuilder, ProtocolSpecBuilder&gt; modifier;

    public BuilderMapEntry(
        final MilestoneType milestoneType,
        final long blockIdentifier,
        final ProtocolSpecBuilder builder,
<span class="fc" id="L424">        final Function&lt;ProtocolSpecBuilder, ProtocolSpecBuilder&gt; modifier) {</span>
<span class="fc" id="L425">      this.milestoneType = milestoneType;</span>
<span class="fc" id="L426">      this.blockIdentifier = blockIdentifier;</span>
<span class="fc" id="L427">      this.builder = builder;</span>
<span class="fc" id="L428">      this.modifier = modifier;</span>
<span class="fc" id="L429">    }</span>

    public long getBlockIdentifier() {
<span class="fc" id="L432">      return blockIdentifier;</span>
    }

    public ProtocolSpecBuilder getBuilder() {
<span class="fc" id="L436">      return builder;</span>
    }

    public Function&lt;ProtocolSpecBuilder, ProtocolSpecBuilder&gt; getModifier() {
<span class="fc" id="L440">      return modifier;</span>
    }

<span class="fc" id="L443">    private enum MilestoneType {</span>
<span class="fc" id="L444">      BLOCK_NUMBER,</span>
<span class="fc" id="L445">      TIMESTAMP</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>