<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Element.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.verkletrie.bandersnatch.fp</a> &gt; <span class="el_source">Element.java</span></div><h1>Element.java</h1><pre class="source lang-java linenums">/*
 * Copyright Besu Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.verkletrie.bandersnatch.fp;

import java.math.BigInteger;
import java.nio.ByteOrder;
import java.util.Objects;

import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;
import org.apache.tuweni.bytes.MutableBytes32;
import org.apache.tuweni.units.bigints.UInt256;

public class Element {
<span class="fc" id="L27">  public static final Element ZERO = new Element(UInt256.ZERO);</span>
  public static final Element ONE;
  static final Element Q_MODULUS;
  private static final Element R_SQUARE;

  static {
    {
      // z0, z1, z2 and z3 represent the 4 limbs of element
      // `1` in Montgomery form.
<span class="fc" id="L36">      UInt256 z0 = UInt256.valueOf(8589934590L);</span>
<span class="fc" id="L37">      UInt256 z1 = UInt256.valueOf(6378425256633387010L).shiftLeft(64);</span>
<span class="fc" id="L38">      UInt256 z2 = UInt256.valueOf(new BigInteger(&quot;11064306276430008309&quot;, 10)).shiftLeft(128);</span>
<span class="fc" id="L39">      UInt256 z3 = UInt256.valueOf(1739710354780652911L).shiftLeft(192);</span>
<span class="fc" id="L40">      ONE = new Element(z0.add(z1).add(z2).add(z3));</span>
    }
    {
<span class="fc" id="L43">      UInt256 z0 = UInt256.valueOf(new BigInteger(&quot;18446744069414584321&quot;, 10));</span>
<span class="fc" id="L44">      UInt256 z1 = UInt256.valueOf(new BigInteger(&quot;6034159408538082302&quot;, 10)).shiftLeft(64);</span>
<span class="fc" id="L45">      UInt256 z2 = UInt256.valueOf(new BigInteger(&quot;3691218898639771653&quot;, 10)).shiftLeft(128);</span>
<span class="fc" id="L46">      UInt256 z3 = UInt256.valueOf(new BigInteger(&quot;8353516859464449352&quot;, 10)).shiftLeft(192);</span>
<span class="fc" id="L47">      Q_MODULUS = new Element(z0.add(z1).add(z2).add(z3));</span>
    }
    {
<span class="fc" id="L50">      UInt256 z0 = UInt256.valueOf(new BigInteger(&quot;14526898881837571181&quot;, 10));</span>
<span class="fc" id="L51">      UInt256 z1 = UInt256.valueOf(new BigInteger(&quot;3129137299524312099&quot;, 10)).shiftLeft(64);</span>
<span class="fc" id="L52">      UInt256 z2 = UInt256.valueOf(new BigInteger(&quot;419701826671360399&quot;, 10)).shiftLeft(128);</span>
<span class="fc" id="L53">      UInt256 z3 = UInt256.valueOf(new BigInteger(&quot;524908885293268753&quot;, 10)).shiftLeft(192);</span>
<span class="fc" id="L54">      R_SQUARE = new Element(z0.add(z1).add(z2).add(z3));</span>
    }
<span class="fc" id="L56">  }</span>

  public static Element random() {
<span class="fc" id="L59">    UInt256 value = UInt256.fromBytes(Bytes32.random());</span>
<span class="fc" id="L60">    UInt256 divisor = UInt256.fromBytes(Bytes32.rightPad(Q_MODULUS.value.slice(8)));</span>
<span class="fc" id="L61">    value = value.mod(divisor);</span>

<span class="pc bpc" id="L63" title="1 of 2 branches missed.">    if (value.greaterThan(Q_MODULUS.value)) {</span>
<span class="nc" id="L64">      value = value.subtract(Q_MODULUS.value);</span>
    }
<span class="fc" id="L66">    return new Element(value);</span>
  }

  final UInt256 value;

<span class="fc" id="L71">  public Element(final UInt256 value) {</span>
<span class="fc" id="L72">    this.value = value;</span>
<span class="fc" id="L73">  }</span>

  public static Element fromBytes(final Bytes data, final ByteOrder byteOrder) {
<span class="nc" id="L76">    return new Element(</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        UInt256.fromBytes(byteOrder == ByteOrder.BIG_ENDIAN ? data : data.reverse()));</span>
  }

  public boolean biggerModulus() {
<span class="nc" id="L81">    return value.greaterOrEqualThan(Q_MODULUS.value);</span>
  }

  public Element inverse() {
<span class="fc bfc" id="L85" title="All 2 branches covered.">    if (isZero()) {</span>
<span class="fc" id="L86">      return new Element(UInt256.ZERO);</span>
    }
<span class="fc" id="L88">    UInt256 u = Q_MODULUS.value;</span>
<span class="fc" id="L89">    UInt256 s = R_SQUARE.value;</span>
<span class="fc" id="L90">    UInt256 v = value;</span>
<span class="fc" id="L91">    UInt256 r = UInt256.ZERO;</span>
    while (true) {
<span class="fc bfc" id="L93" title="All 2 branches covered.">      while ((v.getLong(24) &amp; 1L) == 0) {</span>
<span class="fc" id="L94">        v = v.shiftRight(1);</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if ((s.getLong(24) &amp; 1L) == 1) {</span>
<span class="fc" id="L96">          s = s.add(Q_MODULUS.value);</span>
        }
<span class="fc" id="L98">        s = s.shiftRight(1);</span>
      }
<span class="fc bfc" id="L100" title="All 2 branches covered.">      while ((u.getLong(24) &amp; 1L) == 0) {</span>
<span class="fc" id="L101">        u = u.shiftRight(1);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        if ((r.getLong(24) &amp; 1L) == 1) {</span>
<span class="fc" id="L103">          r = r.add(Q_MODULUS.value);</span>
        }
<span class="fc" id="L105">        r = r.shiftRight(1);</span>
      }
<span class="fc" id="L107">      boolean bigger = v.greaterOrEqualThan(u);</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">      if (bigger) {</span>
<span class="fc" id="L109">        v = v.subtract(u);</span>
<span class="fc" id="L110">        UInt256 oldS = s;</span>
<span class="fc" id="L111">        s = s.subtract(r);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (s.greaterThan(oldS)) {</span>
<span class="fc" id="L113">          s = s.add(Q_MODULUS.value);</span>
        }

<span class="fc" id="L116">      } else {</span>
<span class="fc" id="L117">        u = u.subtract(v);</span>
<span class="fc" id="L118">        UInt256 oldR = r;</span>
<span class="fc" id="L119">        r = r.subtract(s);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (r.greaterThan(oldR)) {</span>
<span class="fc" id="L121">          r = r.add(Q_MODULUS.value);</span>
        }
      }
<span class="pc bpc" id="L124" title="3 of 4 branches missed.">      if (u.getLong(24) == 1L &amp;&amp; u.shiftRight(8).equals(UInt256.ZERO)) {</span>
<span class="nc" id="L125">        return new Element(r);</span>
      }
<span class="pc bpc" id="L127" title="1 of 4 branches missed.">      if (v.getLong(24) == 1L &amp;&amp; v.shiftRight(8).equals(UInt256.ZERO)) {</span>
<span class="fc" id="L128">        return new Element(s);</span>
      }
<span class="fc" id="L130">    }</span>
  }

  public Element neg() {
<span class="fc bfc" id="L134" title="All 2 branches covered.">    if (isZero()) {</span>
<span class="fc" id="L135">      return this;</span>
    }
<span class="fc" id="L137">    return new Element(Q_MODULUS.value.subtract(this.value));</span>
  }

  public byte[] limb(final int i) {
<span class="nc" id="L141">    return value.slice(32 - (i + 1) * 8, 8).toArrayUnsafe();</span>
  }

  public boolean isZero() {
<span class="fc" id="L145">    return value.isZero();</span>
  }

  public Element divide(final Element b) {
<span class="fc" id="L149">    Element bInv = b.inverse();</span>
<span class="fc" id="L150">    return this.multiply(bInv);</span>
  }

  private UInt256 madd0(final UInt256 a, final UInt256 b, final UInt256 c) {
<span class="fc" id="L154">    UInt256 product = a.multiply(b).add(c);</span>
<span class="fc" id="L155">    return product;</span>
  }

  private UInt256 madd1(final UInt256 a, final UInt256 b, final UInt256 c) {
<span class="fc" id="L159">    UInt256 product = a.multiply(b).add(c);</span>
<span class="fc" id="L160">    return product;</span>
  }

  private UInt256 madd2(final UInt256 a, final UInt256 b, final UInt256 c, final UInt256 d) {
<span class="fc" id="L164">    UInt256 product = a.multiply(b).add(c).add(d);</span>
<span class="fc" id="L165">    return product;</span>
  }

  private UInt256 madd3(
      final UInt256 a, final UInt256 b, final UInt256 c, final UInt256 d, final UInt256 e) {
<span class="fc" id="L170">    UInt256 product = a.multiply(b);</span>
<span class="fc" id="L171">    product = product.add(c).add(d);</span>
<span class="fc" id="L172">    product = product.add(e.shiftLeft(64));</span>
<span class="fc" id="L173">    return product;</span>
  }

  private UInt256 limb(final UInt256 value, final int index) {
<span class="fc" id="L177">    return UInt256.fromBytes(Bytes32.leftPad(value.slice(32 - (index + 1) * 8, 8)));</span>
  }

  private UInt256 setLimb(final UInt256 value, final UInt256 limb, final int index) {
<span class="fc" id="L181">    MutableBytes32 mutable = value.toBytes().mutableCopy();</span>
<span class="fc" id="L182">    mutable.set(32 - (index + 1) * 8, limb.slice(24, 8));</span>
<span class="fc" id="L183">    return UInt256.fromBytes(mutable);</span>
  }

  public Element multiply(final Element y) {

<span class="fc" id="L188">    UInt256 t = UInt256.ZERO;</span>
    UInt256 c;

    // round 0
    {
      // v := x[0]
<span class="fc" id="L194">      UInt256 v = limb(this.value, 0);</span>
      // c[1], c[0] = bits.Mul64(v, y[0])
<span class="fc" id="L196">      UInt256 tempC = v.multiply(limb(y.value, 0));</span>
<span class="fc" id="L197">      c = setLimb(UInt256.ZERO, limb(tempC, 1), 1);</span>
<span class="fc" id="L198">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // m := c[0] * 18446744069414584319
<span class="fc" id="L200">      UInt256 constant = UInt256.valueOf(new BigInteger(&quot;18446744069414584319&quot;, 10));</span>
<span class="fc" id="L201">      UInt256 c0 = limb(c, 0);</span>
<span class="fc" id="L202">      UInt256 m = limb(constant.multiply(c0), 0);</span>

      // c[2] = madd0(m, 18446744069414584321, c[0])
<span class="fc" id="L205">      UInt256 c2 =</span>
<span class="fc" id="L206">          madd0(m, UInt256.valueOf(new BigInteger(&quot;18446744069414584321&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L207">      c = setLimb(c, limb(c2, 1), 2);</span>
      // c[1], c[0] = madd1(v, y[1], c[1])
<span class="fc" id="L209">      tempC = madd1(v, limb(y.value, 1), limb(c, 1));</span>
<span class="fc" id="L210">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L211">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // c[2], t[0] = madd2(m, 6034159408538082302, c[2], c[0])
<span class="fc" id="L213">      tempC =</span>
<span class="fc" id="L214">          madd2(</span>
              m,
<span class="fc" id="L216">              UInt256.valueOf(new BigInteger(&quot;6034159408538082302&quot;, 10)),</span>
<span class="fc" id="L217">              limb(c, 2),</span>
<span class="fc" id="L218">              limb(c, 0));</span>
<span class="fc" id="L219">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L220">      t = setLimb(t, limb(tempC, 0), 0);</span>
      // c[1], c[0] = madd1(v, y[2], c[1])
<span class="fc" id="L222">      tempC = madd1(v, limb(y.value, 2), limb(c, 1));</span>
<span class="fc" id="L223">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L224">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // c[2], t[1] = madd2(m, 3691218898639771653, c[2], c[0])
<span class="fc" id="L226">      tempC =</span>
<span class="fc" id="L227">          madd2(</span>
              m,
<span class="fc" id="L229">              UInt256.valueOf(new BigInteger(&quot;3691218898639771653&quot;, 10)),</span>
<span class="fc" id="L230">              limb(c, 2),</span>
<span class="fc" id="L231">              limb(c, 0));</span>
<span class="fc" id="L232">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L233">      t = setLimb(t, limb(tempC, 0), 1);</span>
      // c[1], c[0] = madd1(v, y[3], c[1])
<span class="fc" id="L235">      tempC = madd1(v, limb(y.value, 3), limb(c, 1));</span>
<span class="fc" id="L236">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L237">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // t[3], t[2] = madd3(m, 8353516859464449352, c[0], c[2], c[1])
<span class="fc" id="L239">      tempC =</span>
<span class="fc" id="L240">          madd3(</span>
              m,
<span class="fc" id="L242">              UInt256.valueOf(new BigInteger(&quot;8353516859464449352&quot;, 10)),</span>
<span class="fc" id="L243">              limb(c, 0),</span>
<span class="fc" id="L244">              limb(c, 2),</span>
<span class="fc" id="L245">              limb(c, 1));</span>
<span class="fc" id="L246">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L247">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }
    // round 1
    {
<span class="fc" id="L251">      UInt256 v = limb(this.value, 1);</span>
      // c[1], c[0] = madd1(v, y[0], t[0])
<span class="fc" id="L253">      UInt256 tempC = madd1(v, limb(y.value, 0), limb(t, 0));</span>
<span class="fc" id="L254">      c = setLimb(UInt256.ZERO, limb(tempC, 0), 0);</span>
<span class="fc" id="L255">      c = setLimb(c, limb(tempC, 1), 1);</span>
      // m := c[0] * 18446744069414584319
<span class="fc" id="L257">      UInt256 m =</span>
<span class="fc" id="L258">          setLimb(</span>
              UInt256.ZERO,
<span class="fc" id="L260">              limb(</span>
<span class="fc" id="L261">                  UInt256.valueOf(new BigInteger(&quot;18446744069414584319&quot;, 10)).multiply(limb(c, 0)),</span>
                  0),
              0);
      //		c[2] = madd0(m, 18446744069414584321, c[0])
<span class="fc" id="L265">      UInt256 c2 =</span>
<span class="fc" id="L266">          madd0(m, UInt256.valueOf(new BigInteger(&quot;18446744069414584321&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L267">      c = setLimb(c, limb(c2, 1), 2);</span>
      //		c[1], c[0] = madd2(v, y[1], c[1], t[1])
<span class="fc" id="L269">      tempC = madd2(v, limb(y.value, 1), limb(c, 1), limb(t, 1));</span>
<span class="fc" id="L270">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L271">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[0] = madd2(m, 6034159408538082302, c[2], c[0])
<span class="fc" id="L273">      tempC =</span>
<span class="fc" id="L274">          madd2(</span>
              m,
<span class="fc" id="L276">              UInt256.valueOf(new BigInteger(&quot;6034159408538082302&quot;, 10)),</span>
<span class="fc" id="L277">              limb(c, 2),</span>
<span class="fc" id="L278">              limb(c, 0));</span>
<span class="fc" id="L279">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L280">      t = setLimb(t, limb(tempC, 0), 0);</span>
      //		c[1], c[0] = madd2(v, y[2], c[1], t[2])
<span class="fc" id="L282">      tempC = madd2(v, limb(y.value, 2), limb(c, 1), limb(t, 2));</span>
<span class="fc" id="L283">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L284">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[1] = madd2(m, 3691218898639771653, c[2], c[0])
<span class="fc" id="L286">      tempC =</span>
<span class="fc" id="L287">          madd2(</span>
              m,
<span class="fc" id="L289">              UInt256.valueOf(new BigInteger(&quot;3691218898639771653&quot;, 10)),</span>
<span class="fc" id="L290">              limb(c, 2),</span>
<span class="fc" id="L291">              limb(c, 0));</span>
<span class="fc" id="L292">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L293">      t = setLimb(t, limb(tempC, 0), 1);</span>
      //		c[1], c[0] = madd2(v, y[3], c[1], t[3])
<span class="fc" id="L295">      tempC = madd2(v, limb(y.value, 3), limb(c, 1), limb(t, 3));</span>
<span class="fc" id="L296">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L297">      c = setLimb(c, limb(tempC, 0), 0);</span>

      //		t[3], t[2] = madd3(m, 8353516859464449352, c[0], c[2], c[1])
<span class="fc" id="L300">      tempC =</span>
<span class="fc" id="L301">          madd3(</span>
              m,
<span class="fc" id="L303">              UInt256.valueOf(new BigInteger(&quot;8353516859464449352&quot;, 10)),</span>
<span class="fc" id="L304">              limb(c, 0),</span>
<span class="fc" id="L305">              limb(c, 2),</span>
<span class="fc" id="L306">              limb(c, 1));</span>
<span class="fc" id="L307">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L308">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }
    // round 2
    {
      // v := x[2]
<span class="fc" id="L313">      UInt256 v = limb(this.value, 2);</span>
      //		c[1], c[0] = madd1(v, y[0], t[0])
<span class="fc" id="L315">      UInt256 tempC = madd1(v, limb(y.value, 0), limb(t, 0));</span>
<span class="fc" id="L316">      c = setLimb(UInt256.ZERO, limb(tempC, 0), 0);</span>
<span class="fc" id="L317">      c = setLimb(c, limb(tempC, 1), 1);</span>
      //		m := c[0] * 18446744069414584319
<span class="fc" id="L319">      UInt256 m =</span>
<span class="fc" id="L320">          setLimb(</span>
              UInt256.ZERO,
<span class="fc" id="L322">              limb(c, 0).multiply(UInt256.valueOf(new BigInteger(&quot;18446744069414584319&quot;, 10))),</span>
              0);
      //		c[2] = madd0(m, 18446744069414584321, c[0])
<span class="fc" id="L325">      UInt256 c2 =</span>
<span class="fc" id="L326">          madd0(m, UInt256.valueOf(new BigInteger(&quot;18446744069414584321&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L327">      c = setLimb(c, limb(c2, 1), 2);</span>
      //		c[1], c[0] = madd2(v, y[1], c[1], t[1])
<span class="fc" id="L329">      tempC = madd2(v, limb(y.value, 1), limb(c, 1), limb(t, 1));</span>
<span class="fc" id="L330">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L331">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[0] = madd2(m, 6034159408538082302, c[2], c[0])
<span class="fc" id="L333">      tempC =</span>
<span class="fc" id="L334">          madd2(</span>
              m,
<span class="fc" id="L336">              UInt256.valueOf(new BigInteger(&quot;6034159408538082302&quot;, 10)),</span>
<span class="fc" id="L337">              limb(c, 2),</span>
<span class="fc" id="L338">              limb(c, 0));</span>
<span class="fc" id="L339">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L340">      t = setLimb(t, limb(tempC, 0), 0);</span>
      //		c[1], c[0] = madd2(v, y[2], c[1], t[2])
<span class="fc" id="L342">      tempC = madd2(v, limb(y.value, 2), limb(c, 1), limb(t, 2));</span>
<span class="fc" id="L343">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L344">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[1] = madd2(m, 3691218898639771653, c[2], c[0])
<span class="fc" id="L346">      tempC =</span>
<span class="fc" id="L347">          madd2(</span>
              m,
<span class="fc" id="L349">              UInt256.valueOf(new BigInteger(&quot;3691218898639771653&quot;, 10)),</span>
<span class="fc" id="L350">              limb(c, 2),</span>
<span class="fc" id="L351">              limb(c, 0));</span>
<span class="fc" id="L352">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L353">      t = setLimb(t, limb(tempC, 0), 1);</span>
      //		c[1], c[0] = madd2(v, y[3], c[1], t[3])
<span class="fc" id="L355">      tempC = madd2(v, limb(y.value, 3), limb(c, 1), limb(t, 3));</span>
<span class="fc" id="L356">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L357">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		t[3], t[2] = madd3(m, 8353516859464449352, c[0], c[2], c[1])
<span class="fc" id="L359">      tempC =</span>
<span class="fc" id="L360">          madd3(</span>
              m,
<span class="fc" id="L362">              UInt256.valueOf(new BigInteger(&quot;8353516859464449352&quot;, 10)),</span>
<span class="fc" id="L363">              limb(c, 0),</span>
<span class="fc" id="L364">              limb(c, 2),</span>
<span class="fc" id="L365">              limb(c, 1));</span>
<span class="fc" id="L366">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L367">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }
    // round 3
    {
      // v := x[3]
<span class="fc" id="L372">      UInt256 v = limb(this.value, 3);</span>
      //		c[1], c[0] = madd1(v, y[0], t[0])
<span class="fc" id="L374">      UInt256 tempC = madd1(v, limb(y.value, 0), limb(t, 0));</span>
<span class="fc" id="L375">      c = setLimb(UInt256.ZERO, limb(tempC, 0), 0);</span>
<span class="fc" id="L376">      c = setLimb(c, limb(tempC, 1), 1);</span>
      //		m := c[0] * 18446744069414584319
<span class="fc" id="L378">      UInt256 m =</span>
<span class="fc" id="L379">          setLimb(</span>
              UInt256.ZERO,
<span class="fc" id="L381">              limb(c, 0).multiply(UInt256.valueOf(new BigInteger(&quot;18446744069414584319&quot;, 10))),</span>
              0);
      //		c[2] = madd0(m, 18446744069414584321, c[0])
<span class="fc" id="L384">      UInt256 c2 =</span>
<span class="fc" id="L385">          madd0(m, UInt256.valueOf(new BigInteger(&quot;18446744069414584321&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L386">      c = setLimb(c, limb(c2, 1), 2);</span>
      //		c[1], c[0] = madd2(v, y[1], c[1], t[1])
<span class="fc" id="L388">      tempC = madd2(v, limb(y.value, 1), limb(c, 1), limb(t, 1));</span>
<span class="fc" id="L389">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L390">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], z[0] = madd2(m, 6034159408538082302, c[2], c[0])
<span class="fc" id="L392">      tempC =</span>
<span class="fc" id="L393">          madd2(</span>
              m,
<span class="fc" id="L395">              UInt256.valueOf(new BigInteger(&quot;6034159408538082302&quot;, 10)),</span>
<span class="fc" id="L396">              limb(c, 2),</span>
<span class="fc" id="L397">              limb(c, 0));</span>
<span class="fc" id="L398">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L399">      t = setLimb(t, limb(tempC, 0), 0);</span>
      //		c[1], c[0] = madd2(v, y[2], c[1], t[2])
<span class="fc" id="L401">      tempC = madd2(v, limb(y.value, 2), limb(c, 1), limb(t, 2));</span>
<span class="fc" id="L402">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L403">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], z[1] = madd2(m, 3691218898639771653, c[2], c[0])
<span class="fc" id="L405">      tempC =</span>
<span class="fc" id="L406">          madd2(</span>
              m,
<span class="fc" id="L408">              UInt256.valueOf(new BigInteger(&quot;3691218898639771653&quot;, 10)),</span>
<span class="fc" id="L409">              limb(c, 2),</span>
<span class="fc" id="L410">              limb(c, 0));</span>
<span class="fc" id="L411">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L412">      t = setLimb(t, limb(tempC, 0), 1);</span>
      //		c[1], c[0] = madd2(v, y[3], c[1], t[3])
<span class="fc" id="L414">      tempC = madd2(v, limb(y.value, 3), limb(c, 1), limb(t, 3));</span>
<span class="fc" id="L415">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L416">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		z[3], z[2] = madd3(m, 8353516859464449352, c[0], c[2], c[1])
<span class="fc" id="L418">      tempC =</span>
<span class="fc" id="L419">          madd3(</span>
              m,
<span class="fc" id="L421">              UInt256.valueOf(new BigInteger(&quot;8353516859464449352&quot;, 10)),</span>
<span class="fc" id="L422">              limb(c, 0),</span>
<span class="fc" id="L423">              limb(c, 2),</span>
<span class="fc" id="L424">              limb(c, 1));</span>
<span class="fc" id="L425">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L426">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }

<span class="fc bfc" id="L429" title="All 2 branches covered.">    if (t.greaterThan(Q_MODULUS.value)) {</span>
<span class="fc" id="L430">      t = t.subtract(Q_MODULUS.value);</span>
    }

<span class="fc" id="L433">    return new Element(t);</span>
  }

  public boolean lexicographicallyLargest() {
<span class="nc" id="L437">    return value.greaterThan((Q_MODULUS.value.subtract(1)).divide(2));</span>
  }

  public Bytes32 getValue(final ByteOrder byteOrder) {
<span class="nc bnc" id="L441" title="All 2 branches missed.">    if (byteOrder == ByteOrder.BIG_ENDIAN) {</span>
<span class="nc" id="L442">      return this.value;</span>
    } else {
<span class="nc" id="L444">      return (Bytes32) this.value.reverse();</span>
    }
  }

  public Bytes32 getBytes(final ByteOrder byteOrder) {
<span class="nc" id="L449">    Element toRegular = fromMontgomery();</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">    if (byteOrder == ByteOrder.BIG_ENDIAN) {</span>
<span class="nc" id="L451">      return toRegular.value;</span>
    } else {
<span class="nc" id="L453">      return (Bytes32) toRegular.value.reverse();</span>
    }
  }

  @Override
  public boolean equals(final Object o) {
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">    if (this == o) return true;</span>
<span class="pc bpc" id="L460" title="2 of 4 branches missed.">    if (o == null || getClass() != o.getClass()) return false;</span>
<span class="fc" id="L461">    Element element = (Element) o;</span>
<span class="fc" id="L462">    return Objects.equals(value, element.value);</span>
  }

  @Override
  public int hashCode() {
<span class="nc" id="L467">    return Objects.hash(value);</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L472">    return &quot;Element{&quot; + &quot;value=&quot; + value + '}';</span>
  }

  private UInt256 add(final UInt256 z) {
<span class="fc" id="L476">    UInt256 mutableZ = z;</span>
    // m = z[0]n'[0] mod W
    // m := z[0] * 18446744069414584319
<span class="fc" id="L479">    UInt256 z0 = limb(mutableZ, 0);</span>
<span class="fc" id="L480">    UInt256 m =</span>
<span class="fc" id="L481">        setLimb(</span>
            UInt256.ZERO,
<span class="fc" id="L483">            UInt256.valueOf(new BigInteger(&quot;18446744069414584319&quot;, 10)).multiply(z0),</span>
            0);
    // C := madd0(m, 18446744069414584321, z[0])
<span class="fc" id="L486">    UInt256 tempC = madd0(m, limb(Q_MODULUS.value, 0), limb(mutableZ, 0));</span>
<span class="fc" id="L487">    UInt256 c = setLimb(UInt256.ZERO, limb(tempC, 1), 0);</span>
    // C, z[0] = madd2(m, 6034159408538082302, z[1], C)
<span class="fc" id="L489">    tempC = madd2(m, limb(Q_MODULUS.value, 1), limb(mutableZ, 1), c);</span>
<span class="fc" id="L490">    c = setLimb(c, limb(tempC, 1), 0);</span>
<span class="fc" id="L491">    mutableZ = setLimb(mutableZ, limb(tempC, 0), 0);</span>
    // C, z[1] = madd2(m, 3691218898639771653, z[2], C)
<span class="fc" id="L493">    tempC = madd2(m, limb(Q_MODULUS.value, 2), limb(mutableZ, 2), c);</span>
<span class="fc" id="L494">    c = setLimb(c, limb(tempC, 1), 0);</span>
<span class="fc" id="L495">    mutableZ = setLimb(mutableZ, limb(tempC, 0), 1);</span>
    // C, z[2] = madd2(m, 8353516859464449352, z[3], C)
<span class="fc" id="L497">    tempC = madd2(m, limb(Q_MODULUS.value, 3), limb(mutableZ, 3), c);</span>
<span class="fc" id="L498">    c = setLimb(c, limb(tempC, 1), 0);</span>
<span class="fc" id="L499">    mutableZ = setLimb(mutableZ, limb(tempC, 0), 2);</span>
    // z[3] = C
<span class="fc" id="L501">    mutableZ = setLimb(mutableZ, limb(c, 0), 3);</span>
<span class="fc" id="L502">    return mutableZ;</span>
  }

  /**
   * fromMontgomery converts the element from Montgomery to regular representation sets and returns
   * z = z * 1
   *
   * @return z * 1
   */
  public Element fromMontgomery() {
<span class="fc" id="L512">    UInt256 calc = add(this.value);</span>
<span class="fc" id="L513">    calc = add(calc);</span>
<span class="fc" id="L514">    calc = add(calc);</span>
<span class="fc" id="L515">    calc = add(calc);</span>

<span class="pc bpc" id="L517" title="1 of 2 branches missed.">    if (calc.greaterThan(Q_MODULUS.value)) {</span>
<span class="nc" id="L518">      return new Element(calc.subtract(Q_MODULUS.value));</span>
    }
<span class="fc" id="L520">    return new Element(calc);</span>
  }

  public Element toMontgomery() {
<span class="fc" id="L524">    return multiply(Element.R_SQUARE);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>