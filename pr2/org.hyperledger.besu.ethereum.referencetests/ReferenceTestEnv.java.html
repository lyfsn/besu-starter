<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReferenceTestEnv.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.referencetests</a> &gt; <span class="el_source">ReferenceTestEnv.java</span></div><h1>ReferenceTestEnv.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 */

package org.hyperledger.besu.ethereum.referencetests;

import static java.nio.charset.StandardCharsets.UTF_8;
import static org.hyperledger.besu.evm.internal.Words.decodeUnsignedLong;

import org.hyperledger.besu.datatypes.Address;
import org.hyperledger.besu.datatypes.BlobGas;
import org.hyperledger.besu.datatypes.GWei;
import org.hyperledger.besu.datatypes.Hash;
import org.hyperledger.besu.datatypes.Wei;
import org.hyperledger.besu.ethereum.core.BlockHeader;
import org.hyperledger.besu.ethereum.core.BlockHeaderBuilder;
import org.hyperledger.besu.ethereum.core.Difficulty;
import org.hyperledger.besu.ethereum.core.Withdrawal;
import org.hyperledger.besu.ethereum.mainnet.BodyValidation;
import org.hyperledger.besu.ethereum.mainnet.MainnetBlockHeaderFunctions;
import org.hyperledger.besu.ethereum.mainnet.ProtocolSpec;
import org.hyperledger.besu.ethereum.mainnet.feemarket.BaseFeeMarket;
import org.hyperledger.besu.evm.log.LogsBloomFilter;

import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;

import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.google.common.base.Strings;
import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;
import org.apache.tuweni.units.bigints.UInt64;

/** A memory holder for testing. */
public class ReferenceTestEnv extends BlockHeader {

<span class="pc" id="L53">  public record EnvWithdrawal(</span>
      @JsonProperty(&quot;index&quot;) String index,
      @JsonProperty(&quot;validatorIndex&quot;) String validatorIndex,
      @JsonProperty(&quot;address&quot;) String address,
      @JsonProperty(&quot;amount&quot;) String amount) {

    Withdrawal asWithdrawal() {
<span class="fc" id="L60">      return new Withdrawal(</span>
<span class="fc" id="L61">          UInt64.fromHexString(index),</span>
<span class="fc" id="L62">          UInt64.fromHexString(validatorIndex),</span>
<span class="fc" id="L63">          Address.fromHexString(address),</span>
<span class="fc" id="L64">          GWei.fromHexString(amount));</span>
    }
  }

  private final String parentDifficulty;

  private final String parentBaseFee;

  private final String parentGasUsed;

  private final String parentGasLimit;

  private final String parentTimestamp;

  private final List&lt;Withdrawal&gt; withdrawals;

  private final Map&lt;Long, Hash&gt; blockHashes;

  private final String parentExcessBlobGas;

  private final String parentBlobGasUsed;

  private final Bytes32 beaconRoot;

  /**
   * Public constructor.
   *
   * @param coinbase Coinbase/beneficiary for the mock block being tested.
   * @param difficulty Difficulty for the mock block being tested.
   * @param gasLimit Gas Limit for the mock block being tested.
   * @param number Block number for the mock block being tested.
   * @param baseFee Optional BaseFee for the mock block being tested.
   * @param timestamp Timestamp for the mock block being tested.
   * @param random Optional RANDAO or the mock block being tested.
   */
  @JsonCreator
  public ReferenceTestEnv(
      @JsonProperty(&quot;parentBeaconBlockRoot&quot;) final String beaconRoot,
      @JsonProperty(&quot;blockHashes&quot;) final Map&lt;String, String&gt; blockHashes,
      @JsonProperty(&quot;ommers&quot;) final List&lt;String&gt; _ommers,
      @JsonProperty(&quot;previousHash&quot;) final String previousHash,
      @JsonProperty(&quot;withdrawals&quot;) final List&lt;EnvWithdrawal&gt; withdrawals,
      @JsonProperty(&quot;currentBaseFee&quot;) final String baseFee,
      @JsonProperty(&quot;currentBeaconRoot&quot;) final String currentBeaconRoot,
      @JsonProperty(&quot;currentBlobGasUsed&quot;) final String currentBlobGasUsed,
      @JsonProperty(&quot;currentCoinbase&quot;) final String coinbase,
      @JsonProperty(&quot;currentDataGasUsed&quot;) final String currentDataGasUsed,
      @JsonProperty(&quot;currentDifficulty&quot;) final String difficulty,
      @JsonProperty(&quot;currentExcessBlobGas&quot;) final String currentExcessBlobGas,
      @JsonProperty(&quot;currentExcessDataGas&quot;) final String currentExcessDataGas,
      @JsonProperty(&quot;currentGasLimit&quot;) final String gasLimit,
      @JsonProperty(&quot;currentNumber&quot;) final String number,
      @JsonProperty(&quot;currentRandom&quot;) final String random,
      @JsonProperty(&quot;currentStateRoot&quot;) final String stateRoot,
      @JsonProperty(&quot;currentTimestamp&quot;) final String timestamp,
      @JsonProperty(&quot;currentWithdrawalsRoot&quot;) final String currentWithdrawalsRoot,
      @JsonProperty(&quot;parentBaseFee&quot;) final String parentBaseFee,
      @JsonProperty(&quot;parentBlobGasUsed&quot;) final String parentBlobGasUsed,
      @JsonProperty(&quot;parentDataGasUsed&quot;) final String parentDataGasUsed,
      @JsonProperty(&quot;parentDifficulty&quot;) final String parentDifficulty,
      @JsonProperty(&quot;parentExcessBlobGas&quot;) final String parentExcessBlobGas,
      @JsonProperty(&quot;parentExcessDataGas&quot;) final String parentExcessDataGas,
      @JsonProperty(&quot;parentGasLimit&quot;) final String parentGasLimit,
      @JsonProperty(&quot;parentGasUsed&quot;) final String parentGasUsed,
      @JsonProperty(&quot;parentTimestamp&quot;) final String parentTimestamp,
      @JsonProperty(&quot;parentUncleHash&quot;) final String _parentUncleHash) {
<span class="fc" id="L130">    super(</span>
<span class="fc" id="L131">        generateTestBlockHash(previousHash, number),</span>
        Hash.EMPTY_LIST_HASH, // ommersHash
<span class="fc" id="L133">        Address.fromHexString(coinbase),</span>
<span class="fc" id="L134">        Optional.ofNullable(stateRoot).map(Hash::fromHexString).orElse(Hash.EMPTY), // stateRoot</span>
        Hash.EMPTY, // transactionsRoot
        Hash.EMPTY, // receiptsRoot
        new LogsBloomFilter(),
<span class="fc bfc" id="L138" title="All 2 branches covered.">        difficulty == null ? null : Difficulty.fromHexOrDecimalString(difficulty),</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">        number == null ? 0 : Long.decode(number),</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        gasLimit == null ? 15_000_000L : Long.decode(gasLimit),</span>
        0L,
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        timestamp == null ? 0L : decodeUnsignedLong(timestamp),</span>
        Bytes.EMPTY,
<span class="fc" id="L144">        Optional.ofNullable(baseFee).map(Wei::fromHexString).orElse(null),</span>
<span class="fc" id="L145">        Optional.ofNullable(random).map(Difficulty::fromHexString).orElse(Difficulty.ZERO),</span>
        0L,
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">        currentWithdrawalsRoot == null ? null : Hash.fromHexString(currentWithdrawalsRoot),</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        currentBlobGasUsed == null</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            ? currentDataGasUsed == null ? null : Long.decode(currentDataGasUsed)</span>
<span class="fc" id="L150">            : Long.decode(currentBlobGasUsed),</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">        currentExcessBlobGas == null</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">            ? currentExcessDataGas == null ? null : BlobGas.fromHexString(currentExcessDataGas)</span>
<span class="fc" id="L153">            : BlobGas.fromHexString(currentExcessBlobGas),</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        beaconRoot == null ? null : Bytes32.fromHexString(beaconRoot),</span>
        null, // depositsRoot
        null, // exitsRoot
        new MainnetBlockHeaderFunctions());
<span class="fc" id="L158">    this.parentDifficulty = parentDifficulty;</span>
<span class="fc" id="L159">    this.parentBaseFee = parentBaseFee;</span>
<span class="fc" id="L160">    this.parentGasUsed = parentGasUsed;</span>
<span class="fc" id="L161">    this.parentGasLimit = parentGasLimit;</span>
<span class="fc" id="L162">    this.parentTimestamp = parentTimestamp;</span>
<span class="fc" id="L163">    this.parentExcessBlobGas =</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        parentExcessBlobGas == null ? parentExcessDataGas : parentExcessBlobGas;</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">    this.parentBlobGasUsed = parentBlobGasUsed == null ? parentDataGasUsed : parentBlobGasUsed;</span>
<span class="fc" id="L166">    this.withdrawals =</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        withdrawals == null</span>
<span class="fc" id="L168">            ? List.of()</span>
<span class="fc" id="L169">            : withdrawals.stream().map(EnvWithdrawal::asWithdrawal).toList();</span>
<span class="fc" id="L170">    this.blockHashes =</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        blockHashes == null</span>
<span class="fc" id="L172">            ? Map.of()</span>
<span class="fc" id="L173">            : blockHashes.entrySet().stream()</span>
<span class="fc" id="L174">                .map(</span>
                    entry -&gt;
<span class="fc" id="L176">                        Map.entry(</span>
<span class="fc" id="L177">                            Long.decode(entry.getKey()), Hash.fromHexString(entry.getValue())))</span>
<span class="fc" id="L178">                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));</span>
<span class="fc" id="L179">    this.beaconRoot =</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        beaconRoot == null</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">            ? (currentBeaconRoot == null ? null : Hash.fromHexString(currentBeaconRoot))</span>
<span class="pc" id="L182">            : Hash.fromHexString(beaconRoot);</span>
<span class="fc" id="L183">  }</span>

  @Override
  public Difficulty getDifficulty() {
<span class="fc bfc" id="L187" title="All 2 branches covered.">    return difficulty == null ? Difficulty.ZERO : super.getDifficulty();</span>
  }

  private static Hash generateTestBlockHash(final String previousHash, final String number) {
<span class="fc bfc" id="L191" title="All 2 branches covered.">    if (Strings.isNullOrEmpty(previousHash)) {</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">      if (number == null) {</span>
<span class="nc" id="L193">        return Hash.EMPTY;</span>
      } else {
<span class="fc" id="L195">        final byte[] bytes = Long.toString(Long.decode(number) - 1).getBytes(UTF_8);</span>
<span class="fc" id="L196">        return Hash.hash(Bytes.wrap(bytes));</span>
      }
    } else {
<span class="fc" id="L199">      return Hash.wrap(Bytes32.fromHexString(previousHash));</span>
    }
  }

  public BlockHeader updateFromParentValues(final ProtocolSpec protocolSpec) {
<span class="fc" id="L204">    var builder =</span>
<span class="fc" id="L205">        BlockHeaderBuilder.fromHeader(this)</span>
<span class="fc" id="L206">            .blockHeaderFunctions(protocolSpec.getBlockHeaderFunctions());</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">    if (protocolSpec.getWithdrawalsProcessor().isPresent()) {</span>
<span class="fc" id="L208">      builder.withdrawalsRoot(BodyValidation.withdrawalsRoot(withdrawals));</span>
    }
<span class="pc bpc" id="L210" title="1 of 6 branches missed.">    if ((baseFee == null || baseFee.isEmpty()) &amp;&amp; protocolSpec.getFeeMarket().implementsBaseFee()) {</span>
<span class="fc" id="L211">      builder.baseFee(</span>
<span class="fc" id="L212">          ((BaseFeeMarket) protocolSpec.getFeeMarket())</span>
<span class="fc" id="L213">              .computeBaseFee(</span>
                  number,
<span class="fc" id="L215">                  Wei.fromHexString(parentBaseFee),</span>
<span class="fc" id="L216">                  Long.decode(parentGasUsed),</span>
                  gasLimit / 2));
    }
<span class="pc bpc" id="L219" title="1 of 4 branches missed.">    if (difficulty == null &amp;&amp; parentDifficulty != null) {</span>
<span class="fc" id="L220">      builder.difficulty(</span>
<span class="fc" id="L221">          Difficulty.of(</span>
              protocolSpec
<span class="fc" id="L223">                  .getDifficultyCalculator()</span>
<span class="fc" id="L224">                  .nextDifficulty(</span>
                      timestamp,
<span class="fc" id="L226">                      BlockHeaderBuilder.createDefault()</span>
<span class="fc" id="L227">                          .difficulty(Difficulty.fromHexOrDecimalString(parentDifficulty))</span>
<span class="fc" id="L228">                          .number(number - 1)</span>
<span class="fc" id="L229">                          .buildBlockHeader(),</span>
                      null)));
    }
<span class="pc bpc" id="L232" title="1 of 4 branches missed.">    if (parentExcessBlobGas != null &amp;&amp; parentBlobGasUsed != null) {</span>
<span class="fc" id="L233">      builder.excessBlobGas(</span>
<span class="fc" id="L234">          BlobGas.of(</span>
              protocolSpec
<span class="fc" id="L236">                  .getGasCalculator()</span>
<span class="fc" id="L237">                  .computeExcessBlobGas(</span>
<span class="fc" id="L238">                      Long.decode(parentExcessBlobGas), Long.decode(parentBlobGasUsed))));</span>
    }

<span class="fc" id="L241">    return builder.buildBlockHeader();</span>
  }

  public List&lt;Withdrawal&gt; getWithdrawals() {
<span class="fc" id="L245">    return withdrawals;</span>
  }

  public Optional&lt;Hash&gt; getBlockhashByNumber(final long number) {
<span class="fc" id="L249">    return Optional.ofNullable(blockHashes.get(number));</span>
  }

  @Override
  public boolean equals(final Object o) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">    if (this == o) return true;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">    if (!(o instanceof ReferenceTestEnv that)) return false;</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">    if (!super.equals(o)) return false;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">    return Objects.equals(parentDifficulty, that.parentDifficulty)</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        &amp;&amp; Objects.equals(parentBaseFee, that.parentBaseFee)</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        &amp;&amp; Objects.equals(parentGasUsed, that.parentGasUsed)</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        &amp;&amp; Objects.equals(parentGasLimit, that.parentGasLimit)</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        &amp;&amp; Objects.equals(parentTimestamp, that.parentTimestamp)</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        &amp;&amp; Objects.equals(parentBlobGasUsed, that.parentBlobGasUsed)</span>
<span class="nc bnc" id="L263" title="All 2 branches missed.">        &amp;&amp; Objects.equals(parentExcessBlobGas, that.parentExcessBlobGas)</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        &amp;&amp; Objects.equals(withdrawals, that.withdrawals)</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        &amp;&amp; Objects.equals(beaconRoot, that.beaconRoot);</span>
  }

  @Override
  public int hashCode() {
<span class="nc" id="L270">    return Objects.hash(</span>
<span class="nc" id="L271">        super.hashCode(),</span>
        parentDifficulty,
        parentBaseFee,
        parentGasUsed,
        parentGasLimit,
        parentTimestamp,
        parentBlobGasUsed,
        parentExcessBlobGas,
        withdrawals,
        beaconRoot);
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>