<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Enclave.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.enclave</a> &gt; <span class="el_source">Enclave.java</span></div><h1>Enclave.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.enclave;

import org.hyperledger.besu.enclave.RequestTransmitter.ResponseBodyHandler;
import org.hyperledger.besu.enclave.types.CreatePrivacyGroupRequest;
import org.hyperledger.besu.enclave.types.DeletePrivacyGroupRequest;
import org.hyperledger.besu.enclave.types.ErrorResponse;
import org.hyperledger.besu.enclave.types.FindPrivacyGroupRequest;
import org.hyperledger.besu.enclave.types.PrivacyGroup;
import org.hyperledger.besu.enclave.types.ReceiveRequest;
import org.hyperledger.besu.enclave.types.ReceiveResponse;
import org.hyperledger.besu.enclave.types.RetrievePrivacyGroupRequest;
import org.hyperledger.besu.enclave.types.SendRequestBesu;
import org.hyperledger.besu.enclave.types.SendRequestLegacy;
import org.hyperledger.besu.enclave.types.SendResponse;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.List;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

/** The Enclave. */
public class Enclave {

<span class="fc" id="L40">  private static final ObjectMapper objectMapper = new ObjectMapper();</span>
  private static final String ORION = &quot;application/vnd.orion.v1+json&quot;;
  private static final String JSON = &quot;application/json&quot;;

  private final RequestTransmitter requestTransmitter;

  /**
   * Instantiates a new Enclave.
   *
   * @param requestTransmitter the request transmitter
   */
<span class="fc" id="L51">  public Enclave(final RequestTransmitter requestTransmitter) {</span>
<span class="fc" id="L52">    this.requestTransmitter = requestTransmitter;</span>
<span class="fc" id="L53">  }</span>

  /**
   * Up check.
   *
   * @return the boolean
   */
  public boolean upCheck() {
    try {
<span class="fc" id="L62">      final String upcheckResponse =</span>
<span class="fc" id="L63">          requestTransmitter.get(null, null, &quot;/upcheck&quot;, this::handleRawResponse, false);</span>
<span class="fc" id="L64">      return upcheckResponse.equals(&quot;I'm up!&quot;);</span>
<span class="fc" id="L65">    } catch (final Exception e) {</span>
<span class="fc" id="L66">      return false;</span>
    }
  }

  /**
   * Send payload.
   *
   * @param payload the payload
   * @param privateFrom the private from
   * @param privateFor the private for
   * @return the send response
   */
  public SendResponse send(
      final String payload, final String privateFrom, final List&lt;String&gt; privateFor) {
<span class="fc" id="L80">    final SendRequestLegacy request = new SendRequestLegacy(payload, privateFrom, privateFor);</span>
<span class="fc" id="L81">    return post(</span>
        JSON,
        request,
        &quot;/send&quot;,
<span class="fc" id="L85">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, SendResponse.class));</span>
  }

  /**
   * Send payload.
   *
   * @param payload the payload
   * @param privateFrom the private from
   * @param privacyGroupId the privacy group id
   * @return the send response
   */
  public SendResponse send(
      final String payload, final String privateFrom, final String privacyGroupId) {
<span class="fc" id="L98">    final SendRequestBesu request = new SendRequestBesu(payload, privateFrom, privacyGroupId);</span>
<span class="fc" id="L99">    return post(</span>
        JSON,
        request,
        &quot;/send&quot;,
<span class="fc" id="L103">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, SendResponse.class));</span>
  }

  /**
   * Receive response.
   *
   * @param payloadKey the payload key
   * @return the receive response
   */
  public ReceiveResponse receive(final String payloadKey) {
<span class="fc" id="L113">    final ReceiveRequest request = new ReceiveRequest(payloadKey);</span>
<span class="fc" id="L114">    return post(</span>
        ORION,
        request,
        &quot;/receive&quot;,
<span class="fc" id="L118">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, ReceiveResponse.class));</span>
  }

  /**
   * Receive response.
   *
   * @param payloadKey the payload key
   * @param to the to
   * @return the receive response
   */
  public ReceiveResponse receive(final String payloadKey, final String to) {
<span class="fc" id="L129">    final ReceiveRequest request = new ReceiveRequest(payloadKey, to);</span>
<span class="fc" id="L130">    return post(</span>
        ORION,
        request,
        &quot;/receive&quot;,
<span class="fc" id="L134">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, ReceiveResponse.class));</span>
  }

  /**
   * Create privacy group.
   *
   * @param addresses the addresses
   * @param from the from
   * @param name the name
   * @param description the description
   * @return the privacy group
   */
  public PrivacyGroup createPrivacyGroup(
      final List&lt;String&gt; addresses,
      final String from,
      final String name,
      final String description) {
<span class="fc" id="L151">    final CreatePrivacyGroupRequest request =</span>
        new CreatePrivacyGroupRequest(addresses, from, name, description);
<span class="fc" id="L153">    return post(</span>
        JSON,
        request,
        &quot;/createPrivacyGroup&quot;,
<span class="fc" id="L157">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, PrivacyGroup.class));</span>
  }

  /**
   * Delete privacy group.
   *
   * @param privacyGroupId the privacy group id
   * @param from the from
   * @return the result of POST operation
   */
  public String deletePrivacyGroup(final String privacyGroupId, final String from) {
<span class="fc" id="L168">    final DeletePrivacyGroupRequest request = new DeletePrivacyGroupRequest(privacyGroupId, from);</span>
<span class="fc" id="L169">    return post(</span>
        JSON,
        request,
        &quot;/deletePrivacyGroup&quot;,
<span class="fc" id="L173">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, String.class));</span>
  }

  /**
   * Find privacy group.
   *
   * @param addresses the addresses
   * @return Array of privacy group
   */
  public PrivacyGroup[] findPrivacyGroup(final List&lt;String&gt; addresses) {
<span class="fc" id="L183">    final FindPrivacyGroupRequest request = new FindPrivacyGroupRequest(addresses);</span>
<span class="fc" id="L184">    return post(</span>
        JSON,
        request,
        &quot;/findPrivacyGroup&quot;,
<span class="fc" id="L188">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, PrivacyGroup[].class));</span>
  }

  /**
   * Retrieve privacy group.
   *
   * @param privacyGroupId the privacy group id
   * @return the privacy group
   */
  public PrivacyGroup retrievePrivacyGroup(final String privacyGroupId) {
<span class="fc" id="L198">    final RetrievePrivacyGroupRequest request = new RetrievePrivacyGroupRequest(privacyGroupId);</span>
<span class="fc" id="L199">    return post(</span>
        JSON,
        request,
        &quot;/retrievePrivacyGroup&quot;,
<span class="fc" id="L203">        (statusCode, body) -&gt; handleJsonResponse(statusCode, body, PrivacyGroup.class));</span>
  }

  private &lt;T&gt; T post(
      final String mediaType,
      final Object content,
      final String endpoint,
      final ResponseBodyHandler&lt;T&gt; responseBodyHandler) {
    final String bodyText;
    try {
<span class="fc" id="L213">      bodyText = objectMapper.writeValueAsString(content);</span>
<span class="nc" id="L214">    } catch (final JsonProcessingException e) {</span>
<span class="nc" id="L215">      throw new EnclaveClientException(400, &quot;Unable to serialize request.&quot;);</span>
<span class="fc" id="L216">    }</span>

<span class="fc" id="L218">    return requestTransmitter.post(mediaType, bodyText, endpoint, responseBodyHandler);</span>
  }

  private &lt;T&gt; T handleJsonResponse(
      final int statusCode, final byte[] body, final Class&lt;T&gt; responseType) {

<span class="fc bfc" id="L224" title="All 2 branches covered.">    if (isSuccess(statusCode)) {</span>
<span class="fc" id="L225">      return parseResponse(statusCode, body, responseType);</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">    } else if (clientError(statusCode)) {</span>
<span class="fc" id="L227">      final ErrorResponse errorResponse = parseResponse(statusCode, body, ErrorResponse.class);</span>
<span class="fc" id="L228">      throw new EnclaveClientException(statusCode, errorResponse.getError());</span>
    } else {
<span class="fc" id="L230">      final ErrorResponse errorResponse = parseResponse(statusCode, body, ErrorResponse.class);</span>
<span class="fc" id="L231">      throw new EnclaveServerException(statusCode, errorResponse.getError());</span>
    }
  }

  private &lt;T&gt; T parseResponse(
      final int statusCode, final byte[] body, final Class&lt;T&gt; responseType) {
    try {
<span class="fc" id="L238">      return objectMapper.readValue(body, responseType);</span>
<span class="fc" id="L239">    } catch (final IOException e) {</span>
<span class="fc" id="L240">      final String utf8EncodedBody = new String(body, StandardCharsets.UTF_8);</span>
      // Check if it's a Tessera error message
      try {
<span class="fc" id="L243">        return objectMapper.readValue(</span>
<span class="fc" id="L244">            processTesseraError(utf8EncodedBody, responseType), responseType);</span>
<span class="nc" id="L245">      } catch (final IOException ex) {</span>
<span class="nc" id="L246">        throw new EnclaveClientException(statusCode, utf8EncodedBody);</span>
      }
    }
  }

  private &lt;T&gt; byte[] processTesseraError(final String errorMsg, final Class&lt;T&gt; responseType) {
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">    if (responseType == SendResponse.class) {</span>
<span class="nc" id="L253">      final String base64Key =</span>
<span class="nc" id="L254">          errorMsg.substring(errorMsg.substring(0, errorMsg.indexOf('=')).lastIndexOf(' '));</span>
<span class="nc" id="L255">      return jsonByteArrayFromString(&quot;key&quot;, base64Key);</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">    } else if (responseType == ErrorResponse.class) {</span>
      // Remove dynamic values
<span class="fc" id="L258">      return jsonByteArrayFromString(&quot;error&quot;, removeBase64(errorMsg));</span>
    } else {
<span class="nc" id="L260">      throw new RuntimeException(&quot;Unhandled response type.&quot;);</span>
    }
  }

  private String removeBase64(final String input) {
<span class="fc bfc" id="L265" title="All 2 branches covered.">    if (input.contains(&quot;=&quot;)) {</span>
<span class="fc" id="L266">      final String startInclBase64 = input.substring(0, input.lastIndexOf('='));</span>
<span class="fc" id="L267">      final String startTrimmed = startInclBase64.substring(0, startInclBase64.lastIndexOf(&quot; &quot;));</span>
<span class="fc" id="L268">      final String end = input.substring(input.lastIndexOf(&quot;=&quot;));</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">      if (end.length() &gt; 1) {</span>
        // Base64 in middle
<span class="fc" id="L271">        return startTrimmed + end.substring(1);</span>
      } else {
        // Base64 at end
<span class="fc" id="L274">        return startTrimmed;</span>
      }
    } else {
<span class="fc" id="L277">      return input;</span>
    }
  }

  private byte[] jsonByteArrayFromString(final String key, final String value) {
<span class="fc" id="L282">    String format = String.format(&quot;{\&quot;%s\&quot;:\&quot;%s\&quot;}&quot;, key, value);</span>
<span class="fc" id="L283">    return format.getBytes(StandardCharsets.UTF_8);</span>
  }

  private boolean clientError(final int statusCode) {
<span class="pc bpc" id="L287" title="1 of 4 branches missed.">    return statusCode &gt;= 400 &amp;&amp; statusCode &lt; 500;</span>
  }

  private boolean isSuccess(final int statusCode) {
<span class="fc bfc" id="L291" title="All 2 branches covered.">    return statusCode == 200;</span>
  }

  private String handleRawResponse(final int statusCode, final byte[] body) {
<span class="fc" id="L295">    final String bodyText = new String(body, StandardCharsets.UTF_8);</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">    if (isSuccess(statusCode)) {</span>
<span class="fc" id="L297">      return bodyText;</span>
    }
<span class="nc" id="L299">    throw new EnclaveClientException(</span>
<span class="nc" id="L300">        statusCode, String.format(&quot;Request failed with %d; body={%s}&quot;, statusCode, bodyText));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>