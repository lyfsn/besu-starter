<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Element.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.verkletrie.bandersnatch.fr</a> &gt; <span class="el_source">Element.java</span></div><h1>Element.java</h1><pre class="source lang-java linenums">/*
 * Copyright Besu Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.verkletrie.bandersnatch.fr;

import java.math.BigInteger;
import java.nio.ByteOrder;
import java.util.Objects;

import org.apache.tuweni.bytes.Bytes;
import org.apache.tuweni.bytes.Bytes32;
import org.apache.tuweni.bytes.MutableBytes32;
import org.apache.tuweni.units.bigints.UInt256;

public class Element {
<span class="fc" id="L27">  public static final Element ZERO = new Element(UInt256.ZERO);</span>
  public static final Element ONE;
  static final Element Q_MODULUS;
  private static final Element R_SQUARE;

  static {
    {
<span class="fc" id="L34">      UInt256 z0 = UInt256.valueOf(new BigInteger(&quot;6347764673676886264&quot;, 10));</span>
<span class="fc" id="L35">      UInt256 z1 = UInt256.valueOf(new BigInteger(&quot;253265890806062196&quot;, 10)).shiftLeft(64);</span>
<span class="fc" id="L36">      UInt256 z2 = UInt256.valueOf(new BigInteger(&quot;11064306276430008312&quot;, 10)).shiftLeft(128);</span>
<span class="fc" id="L37">      UInt256 z3 = UInt256.valueOf(new BigInteger(&quot;1739710354780652911&quot;, 10)).shiftLeft(192);</span>
<span class="fc" id="L38">      ONE = new Element(z0.add(z1).add(z2).add(z3));</span>
    }
    {
<span class="fc" id="L41">      UInt256 z0 = UInt256.valueOf(new BigInteger(&quot;8429901452645165025&quot;, 10));</span>
<span class="fc" id="L42">      UInt256 z1 = UInt256.valueOf(new BigInteger(&quot;18415085837358793841&quot;, 10)).shiftLeft(64);</span>
<span class="fc" id="L43">      UInt256 z2 = UInt256.valueOf(new BigInteger(&quot;922804724659942912&quot;, 10)).shiftLeft(128);</span>
<span class="fc" id="L44">      UInt256 z3 = UInt256.valueOf(new BigInteger(&quot;2088379214866112338&quot;, 10)).shiftLeft(192);</span>
<span class="fc" id="L45">      Q_MODULUS = new Element(z0.add(z1).add(z2).add(z3));</span>
    }
    {
<span class="fc" id="L48">      UInt256 z0 = UInt256.valueOf(new BigInteger(&quot;15831548891076708299&quot;, 10));</span>
<span class="fc" id="L49">      UInt256 z1 = UInt256.valueOf(new BigInteger(&quot;4682191799977818424&quot;, 10)).shiftLeft(64);</span>
<span class="fc" id="L50">      UInt256 z2 = UInt256.valueOf(new BigInteger(&quot;12294384630081346794&quot;, 10)).shiftLeft(128);</span>
<span class="fc" id="L51">      UInt256 z3 = UInt256.valueOf(new BigInteger(&quot;785759240370973821&quot;, 10)).shiftLeft(192);</span>
<span class="fc" id="L52">      R_SQUARE = new Element(z0.add(z1).add(z2).add(z3));</span>
    }
<span class="fc" id="L54">  }</span>

  public static Element random() {
<span class="fc" id="L57">    UInt256 value = UInt256.fromBytes(Bytes32.random());</span>
<span class="fc" id="L58">    UInt256 divisor = UInt256.fromBytes(Bytes32.rightPad(Q_MODULUS.value.slice(8)));</span>
<span class="fc" id="L59">    value = value.mod(divisor);</span>

<span class="pc bpc" id="L61" title="1 of 2 branches missed.">    if (value.greaterThan(Q_MODULUS.value)) {</span>
<span class="nc" id="L62">      value = value.subtract(Q_MODULUS.value);</span>
    }
<span class="fc" id="L64">    return new Element(value);</span>
  }

  final UInt256 value;

<span class="fc" id="L69">  public Element(final UInt256 value) {</span>
<span class="fc" id="L70">    this.value = value;</span>
<span class="fc" id="L71">  }</span>

  public static Element fromBytes(final Bytes data, final ByteOrder byteOrder) {
<span class="nc" id="L74">    return new Element(</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">        UInt256.fromBytes(byteOrder == ByteOrder.BIG_ENDIAN ? data : data.reverse()));</span>
  }

  public boolean biggerModulus() {
<span class="nc" id="L79">    return value.greaterOrEqualThan(Q_MODULUS.value);</span>
  }

  public Element inverse() {
<span class="fc bfc" id="L83" title="All 2 branches covered.">    if (isZero()) {</span>
<span class="fc" id="L84">      return new Element(UInt256.ZERO);</span>
    }
<span class="fc" id="L86">    UInt256 u = Q_MODULUS.value;</span>
<span class="fc" id="L87">    UInt256 s = R_SQUARE.value;</span>
<span class="fc" id="L88">    UInt256 v = value;</span>
<span class="fc" id="L89">    UInt256 r = UInt256.ZERO;</span>
    while (true) {
<span class="fc bfc" id="L91" title="All 2 branches covered.">      while ((v.getLong(24) &amp; 1L) == 0) {</span>
<span class="fc" id="L92">        v = v.shiftRight(1);</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if ((s.getLong(24) &amp; 1L) == 1) {</span>
<span class="fc" id="L94">          s = s.add(Q_MODULUS.value);</span>
        }
<span class="fc" id="L96">        s = s.shiftRight(1);</span>
      }
<span class="fc bfc" id="L98" title="All 2 branches covered.">      while ((u.getLong(24) &amp; 1L) == 0) {</span>
<span class="fc" id="L99">        u = u.shiftRight(1);</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if ((r.getLong(24) &amp; 1L) == 1) {</span>
<span class="fc" id="L101">          r = r.add(Q_MODULUS.value);</span>
        }
<span class="fc" id="L103">        r = r.shiftRight(1);</span>
      }
<span class="fc" id="L105">      boolean bigger = v.greaterOrEqualThan(u);</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">      if (bigger) {</span>
<span class="fc" id="L107">        v = v.subtract(u);</span>
<span class="fc" id="L108">        UInt256 oldS = s;</span>
<span class="fc" id="L109">        s = s.subtract(r);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (s.greaterThan(oldS)) {</span>
<span class="fc" id="L111">          s = s.add(Q_MODULUS.value);</span>
        }

<span class="fc" id="L114">      } else {</span>
<span class="fc" id="L115">        u = u.subtract(v);</span>
<span class="fc" id="L116">        UInt256 oldR = r;</span>
<span class="fc" id="L117">        r = r.subtract(s);</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (r.greaterThan(oldR)) {</span>
<span class="fc" id="L119">          r = r.add(Q_MODULUS.value);</span>
        }
      }
<span class="pc bpc" id="L122" title="1 of 4 branches missed.">      if (u.getLong(24) == 1L &amp;&amp; u.shiftRight(8).equals(UInt256.ZERO)) {</span>
<span class="fc" id="L123">        return new Element(r);</span>
      }
<span class="pc bpc" id="L125" title="1 of 4 branches missed.">      if (v.getLong(24) == 1L &amp;&amp; v.shiftRight(8).equals(UInt256.ZERO)) {</span>
<span class="fc" id="L126">        return new Element(s);</span>
      }
<span class="fc" id="L128">    }</span>
  }

  public Element neg() {
<span class="fc bfc" id="L132" title="All 2 branches covered.">    if (isZero()) {</span>
<span class="fc" id="L133">      return this;</span>
    }
<span class="fc" id="L135">    return new Element(Q_MODULUS.value.subtract(this.value));</span>
  }

  public byte[] limb(final int i) {
<span class="nc" id="L139">    return value.slice(32 - (i + 1) * 8, 8).toArrayUnsafe();</span>
  }

  public boolean isZero() {
<span class="fc" id="L143">    return value.isZero();</span>
  }

  public Element divide(final Element b) {
<span class="fc" id="L147">    Element bInv = b.inverse();</span>
<span class="fc" id="L148">    return this.multiply(bInv);</span>
  }

  private UInt256 madd0(final UInt256 a, final UInt256 b, final UInt256 c) {
<span class="fc" id="L152">    UInt256 product = a.multiply(b).add(c);</span>
<span class="fc" id="L153">    return product;</span>
  }

  private UInt256 madd1(final UInt256 a, final UInt256 b, final UInt256 c) {
<span class="fc" id="L157">    UInt256 product = a.multiply(b).add(c);</span>
<span class="fc" id="L158">    return product;</span>
  }

  private UInt256 madd2(final UInt256 a, final UInt256 b, final UInt256 c, final UInt256 d) {
<span class="fc" id="L162">    UInt256 product = a.multiply(b).add(c).add(d);</span>
<span class="fc" id="L163">    return product;</span>
  }

  private UInt256 madd3(
      final UInt256 a, final UInt256 b, final UInt256 c, final UInt256 d, final UInt256 e) {
<span class="fc" id="L168">    UInt256 product = a.multiply(b);</span>
<span class="fc" id="L169">    product = product.add(c).add(d);</span>
<span class="fc" id="L170">    product = product.add(e.shiftLeft(64));</span>
<span class="fc" id="L171">    return product;</span>
  }

  private UInt256 limb(final UInt256 value, final int index) {
<span class="fc" id="L175">    return UInt256.fromBytes(Bytes32.leftPad(value.slice(32 - (index + 1) * 8, 8)));</span>
  }

  private UInt256 setLimb(final UInt256 value, final UInt256 limb, final int index) {
<span class="fc" id="L179">    MutableBytes32 mutable = value.toBytes().mutableCopy();</span>
<span class="fc" id="L180">    mutable.set(32 - (index + 1) * 8, limb.slice(24, 8));</span>
<span class="fc" id="L181">    return UInt256.fromBytes(mutable);</span>
  }

  public Element multiply(final Element y) {

<span class="fc" id="L186">    UInt256 t = UInt256.ZERO;</span>
    UInt256 c;

    // round 0
    {
      // v := x[0]
<span class="fc" id="L192">      UInt256 v = limb(this.value, 0);</span>
      // c[1], c[0] = bits.Mul64(v, y[0])
<span class="fc" id="L194">      UInt256 tempC = v.multiply(limb(y.value, 0));</span>
<span class="fc" id="L195">      c = setLimb(UInt256.ZERO, limb(tempC, 1), 1);</span>
<span class="fc" id="L196">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // m := c[0] * 17410672245482742751
<span class="fc" id="L198">      UInt256 constant = UInt256.valueOf(new BigInteger(&quot;17410672245482742751&quot;, 10));</span>
<span class="fc" id="L199">      UInt256 c0 = limb(c, 0);</span>
<span class="fc" id="L200">      UInt256 m = limb(constant.multiply(c0), 0);</span>

      // c[2] = madd0(m, 8429901452645165025, c[0])
<span class="fc" id="L203">      UInt256 c2 = madd0(m, UInt256.valueOf(new BigInteger(&quot;8429901452645165025&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L204">      c = setLimb(c, limb(c2, 1), 2);</span>
      // c[1], c[0] = madd1(v, y[1], c[1])
<span class="fc" id="L206">      tempC = madd1(v, limb(y.value, 1), limb(c, 1));</span>
<span class="fc" id="L207">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L208">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // c[2], t[0] = madd2(m, 18415085837358793841, c[2], c[0])
<span class="fc" id="L210">      tempC =</span>
<span class="fc" id="L211">          madd2(</span>
              m,
<span class="fc" id="L213">              UInt256.valueOf(new BigInteger(&quot;18415085837358793841&quot;, 10)),</span>
<span class="fc" id="L214">              limb(c, 2),</span>
<span class="fc" id="L215">              limb(c, 0));</span>
<span class="fc" id="L216">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L217">      t = setLimb(t, limb(tempC, 0), 0);</span>
      // c[1], c[0] = madd1(v, y[2], c[1])
<span class="fc" id="L219">      tempC = madd1(v, limb(y.value, 2), limb(c, 1));</span>
<span class="fc" id="L220">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L221">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // c[2], t[1] = madd2(m, 922804724659942912, c[2], c[0])
<span class="fc" id="L223">      tempC =</span>
<span class="fc" id="L224">          madd2(</span>
<span class="fc" id="L225">              m, UInt256.valueOf(new BigInteger(&quot;922804724659942912&quot;, 10)), limb(c, 2), limb(c, 0));</span>
<span class="fc" id="L226">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L227">      t = setLimb(t, limb(tempC, 0), 1);</span>
      // c[1], c[0] = madd1(v, y[3], c[1])
<span class="fc" id="L229">      tempC = madd1(v, limb(y.value, 3), limb(c, 1));</span>
<span class="fc" id="L230">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L231">      c = setLimb(c, limb(tempC, 0), 0);</span>
      // t[3], t[2] = madd3(m, 2088379214866112338, c[0], c[2], c[1])
<span class="fc" id="L233">      tempC =</span>
<span class="fc" id="L234">          madd3(</span>
              m,
<span class="fc" id="L236">              UInt256.valueOf(new BigInteger(&quot;2088379214866112338&quot;, 10)),</span>
<span class="fc" id="L237">              limb(c, 0),</span>
<span class="fc" id="L238">              limb(c, 2),</span>
<span class="fc" id="L239">              limb(c, 1));</span>
<span class="fc" id="L240">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L241">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }
    // round 1
    {
<span class="fc" id="L245">      UInt256 v = limb(this.value, 1);</span>
      // c[1], c[0] = madd1(v, y[0], t[0])
<span class="fc" id="L247">      UInt256 tempC = madd1(v, limb(y.value, 0), limb(t, 0));</span>
<span class="fc" id="L248">      c = setLimb(UInt256.ZERO, limb(tempC, 0), 0);</span>
<span class="fc" id="L249">      c = setLimb(c, limb(tempC, 1), 1);</span>
      // m := c[0] * 17410672245482742751
<span class="fc" id="L251">      UInt256 m =</span>
<span class="fc" id="L252">          setLimb(</span>
              UInt256.ZERO,
<span class="fc" id="L254">              limb(</span>
<span class="fc" id="L255">                  UInt256.valueOf(new BigInteger(&quot;17410672245482742751&quot;, 10)).multiply(limb(c, 0)),</span>
                  0),
              0);
      //		c[2] = madd0(m, 8429901452645165025, c[0])
<span class="fc" id="L259">      UInt256 c2 = madd0(m, UInt256.valueOf(new BigInteger(&quot;8429901452645165025&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L260">      c = setLimb(c, limb(c2, 1), 2);</span>
      //		c[1], c[0] = madd2(v, y[1], c[1], t[1])
<span class="fc" id="L262">      tempC = madd2(v, limb(y.value, 1), limb(c, 1), limb(t, 1));</span>
<span class="fc" id="L263">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L264">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[0] = madd2(m, 18415085837358793841, c[2], c[0])
<span class="fc" id="L266">      tempC =</span>
<span class="fc" id="L267">          madd2(</span>
              m,
<span class="fc" id="L269">              UInt256.valueOf(new BigInteger(&quot;18415085837358793841&quot;, 10)),</span>
<span class="fc" id="L270">              limb(c, 2),</span>
<span class="fc" id="L271">              limb(c, 0));</span>
<span class="fc" id="L272">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L273">      t = setLimb(t, limb(tempC, 0), 0);</span>
      //		c[1], c[0] = madd2(v, y[2], c[1], t[2])
<span class="fc" id="L275">      tempC = madd2(v, limb(y.value, 2), limb(c, 1), limb(t, 2));</span>
<span class="fc" id="L276">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L277">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[1] = madd2(m, 922804724659942912, c[2], c[0])
<span class="fc" id="L279">      tempC =</span>
<span class="fc" id="L280">          madd2(</span>
<span class="fc" id="L281">              m, UInt256.valueOf(new BigInteger(&quot;922804724659942912&quot;, 10)), limb(c, 2), limb(c, 0));</span>
<span class="fc" id="L282">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L283">      t = setLimb(t, limb(tempC, 0), 1);</span>
      //		c[1], c[0] = madd2(v, y[3], c[1], t[3])
<span class="fc" id="L285">      tempC = madd2(v, limb(y.value, 3), limb(c, 1), limb(t, 3));</span>
<span class="fc" id="L286">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L287">      c = setLimb(c, limb(tempC, 0), 0);</span>

      //		t[3], t[2] = madd3(m, 2088379214866112338, c[0], c[2], c[1])
<span class="fc" id="L290">      tempC =</span>
<span class="fc" id="L291">          madd3(</span>
              m,
<span class="fc" id="L293">              UInt256.valueOf(new BigInteger(&quot;2088379214866112338&quot;, 10)),</span>
<span class="fc" id="L294">              limb(c, 0),</span>
<span class="fc" id="L295">              limb(c, 2),</span>
<span class="fc" id="L296">              limb(c, 1));</span>
<span class="fc" id="L297">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L298">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }
    // round 2
    {
      // v := x[2]
<span class="fc" id="L303">      UInt256 v = limb(this.value, 2);</span>
      //		c[1], c[0] = madd1(v, y[0], t[0])
<span class="fc" id="L305">      UInt256 tempC = madd1(v, limb(y.value, 0), limb(t, 0));</span>
<span class="fc" id="L306">      c = setLimb(UInt256.ZERO, limb(tempC, 0), 0);</span>
<span class="fc" id="L307">      c = setLimb(c, limb(tempC, 1), 1);</span>
      //		m := c[0] * 17410672245482742751
<span class="fc" id="L309">      UInt256 m =</span>
<span class="fc" id="L310">          setLimb(</span>
              UInt256.ZERO,
<span class="fc" id="L312">              limb(c, 0).multiply(UInt256.valueOf(new BigInteger(&quot;17410672245482742751&quot;, 10))),</span>
              0);
      //		c[2] = madd0(m, 8429901452645165025, c[0])
<span class="fc" id="L315">      UInt256 c2 = madd0(m, UInt256.valueOf(new BigInteger(&quot;8429901452645165025&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L316">      c = setLimb(c, limb(c2, 1), 2);</span>
      //		c[1], c[0] = madd2(v, y[1], c[1], t[1])
<span class="fc" id="L318">      tempC = madd2(v, limb(y.value, 1), limb(c, 1), limb(t, 1));</span>
<span class="fc" id="L319">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L320">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[0] = madd2(m, 18415085837358793841, c[2], c[0])
<span class="fc" id="L322">      tempC =</span>
<span class="fc" id="L323">          madd2(</span>
              m,
<span class="fc" id="L325">              UInt256.valueOf(new BigInteger(&quot;18415085837358793841&quot;, 10)),</span>
<span class="fc" id="L326">              limb(c, 2),</span>
<span class="fc" id="L327">              limb(c, 0));</span>
<span class="fc" id="L328">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L329">      t = setLimb(t, limb(tempC, 0), 0);</span>
      //		c[1], c[0] = madd2(v, y[2], c[1], t[2])
<span class="fc" id="L331">      tempC = madd2(v, limb(y.value, 2), limb(c, 1), limb(t, 2));</span>
<span class="fc" id="L332">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L333">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], t[1] = madd2(m, 922804724659942912, c[2], c[0])
<span class="fc" id="L335">      tempC =</span>
<span class="fc" id="L336">          madd2(</span>
<span class="fc" id="L337">              m, UInt256.valueOf(new BigInteger(&quot;922804724659942912&quot;, 10)), limb(c, 2), limb(c, 0));</span>
<span class="fc" id="L338">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L339">      t = setLimb(t, limb(tempC, 0), 1);</span>
      //		c[1], c[0] = madd2(v, y[3], c[1], t[3])
<span class="fc" id="L341">      tempC = madd2(v, limb(y.value, 3), limb(c, 1), limb(t, 3));</span>
<span class="fc" id="L342">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L343">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		t[3], t[2] = madd3(m, 2088379214866112338, c[0], c[2], c[1])
<span class="fc" id="L345">      tempC =</span>
<span class="fc" id="L346">          madd3(</span>
              m,
<span class="fc" id="L348">              UInt256.valueOf(new BigInteger(&quot;2088379214866112338&quot;, 10)),</span>
<span class="fc" id="L349">              limb(c, 0),</span>
<span class="fc" id="L350">              limb(c, 2),</span>
<span class="fc" id="L351">              limb(c, 1));</span>
<span class="fc" id="L352">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L353">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }
    // round 3
    {
      // v := x[3]
<span class="fc" id="L358">      UInt256 v = limb(this.value, 3);</span>
      //		c[1], c[0] = madd1(v, y[0], t[0])
<span class="fc" id="L360">      UInt256 tempC = madd1(v, limb(y.value, 0), limb(t, 0));</span>
<span class="fc" id="L361">      c = setLimb(UInt256.ZERO, limb(tempC, 0), 0);</span>
<span class="fc" id="L362">      c = setLimb(c, limb(tempC, 1), 1);</span>
      //		m := c[0] * 17410672245482742751
<span class="fc" id="L364">      UInt256 m =</span>
<span class="fc" id="L365">          setLimb(</span>
              UInt256.ZERO,
<span class="fc" id="L367">              limb(c, 0).multiply(UInt256.valueOf(new BigInteger(&quot;17410672245482742751&quot;, 10))),</span>
              0);
      //		c[2] = madd0(m, 8429901452645165025, c[0])
<span class="fc" id="L370">      UInt256 c2 = madd0(m, UInt256.valueOf(new BigInteger(&quot;8429901452645165025&quot;, 10)), limb(c, 0));</span>
<span class="fc" id="L371">      c = setLimb(c, limb(c2, 1), 2);</span>
      //		c[1], c[0] = madd2(v, y[1], c[1], t[1])
<span class="fc" id="L373">      tempC = madd2(v, limb(y.value, 1), limb(c, 1), limb(t, 1));</span>
<span class="fc" id="L374">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L375">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], z[0] = madd2(m, 18415085837358793841, c[2], c[0])
<span class="fc" id="L377">      tempC =</span>
<span class="fc" id="L378">          madd2(</span>
              m,
<span class="fc" id="L380">              UInt256.valueOf(new BigInteger(&quot;18415085837358793841&quot;, 10)),</span>
<span class="fc" id="L381">              limb(c, 2),</span>
<span class="fc" id="L382">              limb(c, 0));</span>
<span class="fc" id="L383">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L384">      t = setLimb(t, limb(tempC, 0), 0);</span>
      //		c[1], c[0] = madd2(v, y[2], c[1], t[2])
<span class="fc" id="L386">      tempC = madd2(v, limb(y.value, 2), limb(c, 1), limb(t, 2));</span>
<span class="fc" id="L387">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L388">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		c[2], z[1] = madd2(m, 922804724659942912, c[2], c[0])
<span class="fc" id="L390">      tempC =</span>
<span class="fc" id="L391">          madd2(</span>
<span class="fc" id="L392">              m, UInt256.valueOf(new BigInteger(&quot;922804724659942912&quot;, 10)), limb(c, 2), limb(c, 0));</span>
<span class="fc" id="L393">      c = setLimb(c, limb(tempC, 1), 2);</span>
<span class="fc" id="L394">      t = setLimb(t, limb(tempC, 0), 1);</span>
      //		c[1], c[0] = madd2(v, y[3], c[1], t[3])
<span class="fc" id="L396">      tempC = madd2(v, limb(y.value, 3), limb(c, 1), limb(t, 3));</span>
<span class="fc" id="L397">      c = setLimb(c, limb(tempC, 1), 1);</span>
<span class="fc" id="L398">      c = setLimb(c, limb(tempC, 0), 0);</span>
      //		z[3], z[2] = madd3(m, 2088379214866112338, c[0], c[2], c[1])
<span class="fc" id="L400">      tempC =</span>
<span class="fc" id="L401">          madd3(</span>
              m,
<span class="fc" id="L403">              UInt256.valueOf(new BigInteger(&quot;2088379214866112338&quot;, 10)),</span>
<span class="fc" id="L404">              limb(c, 0),</span>
<span class="fc" id="L405">              limb(c, 2),</span>
<span class="fc" id="L406">              limb(c, 1));</span>
<span class="fc" id="L407">      t = setLimb(t, limb(tempC, 1), 3);</span>
<span class="fc" id="L408">      t = setLimb(t, limb(tempC, 0), 2);</span>
    }

<span class="fc bfc" id="L411" title="All 2 branches covered.">    if (t.greaterThan(Q_MODULUS.value)) {</span>
<span class="fc" id="L412">      t = t.subtract(Q_MODULUS.value);</span>
    }

<span class="fc" id="L415">    return new Element(t);</span>
  }

  public boolean lexicographicallyLargest() {
<span class="nc" id="L419">    return value.greaterThan((Q_MODULUS.value.subtract(1)).divide(2));</span>
  }

  public Bytes32 getValue(final ByteOrder byteOrder) {
<span class="nc bnc" id="L423" title="All 2 branches missed.">    if (byteOrder == ByteOrder.BIG_ENDIAN) {</span>
<span class="nc" id="L424">      return this.value;</span>
    } else {
<span class="nc" id="L426">      return (Bytes32) this.value.reverse();</span>
    }
  }

  public Bytes32 getBytes(final ByteOrder byteOrder) {
<span class="nc" id="L431">    Element toRegular = fromMontgomery();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">    if (byteOrder == ByteOrder.BIG_ENDIAN) {</span>
<span class="nc" id="L433">      return toRegular.value;</span>
    } else {
<span class="nc" id="L435">      return (Bytes32) toRegular.value.reverse();</span>
    }
  }

  @Override
  public boolean equals(final Object o) {
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">    if (this == o) return true;</span>
<span class="pc bpc" id="L442" title="2 of 4 branches missed.">    if (o == null || getClass() != o.getClass()) return false;</span>
<span class="fc" id="L443">    Element element = (Element) o;</span>
<span class="fc" id="L444">    return Objects.equals(value, element.value);</span>
  }

  @Override
  public int hashCode() {
<span class="nc" id="L449">    return Objects.hash(value);</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L454">    return &quot;Element{&quot; + &quot;value=&quot; + value + '}';</span>
  }

  private UInt256 add(final UInt256 z) {
<span class="fc" id="L458">    UInt256 mutableZ = z;</span>
    // m = z[0]n'[0] mod W
    // m := z[0] * 17410672245482742751
<span class="fc" id="L461">    UInt256 z0 = limb(mutableZ, 0);</span>
<span class="fc" id="L462">    UInt256 m =</span>
<span class="fc" id="L463">        setLimb(</span>
            UInt256.ZERO,
<span class="fc" id="L465">            UInt256.valueOf(new BigInteger(&quot;17410672245482742751&quot;, 10)).multiply(z0),</span>
            0);
    // C := madd0(m, 8429901452645165025, z[0])
<span class="fc" id="L468">    UInt256 tempC = madd0(m, limb(Q_MODULUS.value, 0), limb(mutableZ, 0));</span>
<span class="fc" id="L469">    UInt256 c = setLimb(UInt256.ZERO, limb(tempC, 1), 0);</span>
    // C, z[0] = madd2(m, 18415085837358793841, z[1], C)
<span class="fc" id="L471">    tempC = madd2(m, limb(Q_MODULUS.value, 1), limb(mutableZ, 1), c);</span>
<span class="fc" id="L472">    c = setLimb(c, limb(tempC, 1), 0);</span>
<span class="fc" id="L473">    mutableZ = setLimb(mutableZ, limb(tempC, 0), 0);</span>
    // C, z[1] = madd2(m, 922804724659942912, z[2], C)
<span class="fc" id="L475">    tempC = madd2(m, limb(Q_MODULUS.value, 2), limb(mutableZ, 2), c);</span>
<span class="fc" id="L476">    c = setLimb(c, limb(tempC, 1), 0);</span>
<span class="fc" id="L477">    mutableZ = setLimb(mutableZ, limb(tempC, 0), 1);</span>
    // C, z[2] = madd2(m, 2088379214866112338, z[3], C)
<span class="fc" id="L479">    tempC = madd2(m, limb(Q_MODULUS.value, 3), limb(mutableZ, 3), c);</span>
<span class="fc" id="L480">    c = setLimb(c, limb(tempC, 1), 0);</span>
<span class="fc" id="L481">    mutableZ = setLimb(mutableZ, limb(tempC, 0), 2);</span>
    // z[3] = C
<span class="fc" id="L483">    mutableZ = setLimb(mutableZ, limb(c, 0), 3);</span>
<span class="fc" id="L484">    return mutableZ;</span>
  }

  /**
   * fromMontgomery converts the element from Montgomery to regular representation sets and returns
   * z = z * 1
   *
   * @return z * 1
   */
  public Element fromMontgomery() {
<span class="fc" id="L494">    UInt256 calc = add(this.value);</span>
<span class="fc" id="L495">    calc = add(calc);</span>
<span class="fc" id="L496">    calc = add(calc);</span>
<span class="fc" id="L497">    calc = add(calc);</span>

<span class="pc bpc" id="L499" title="1 of 2 branches missed.">    if (calc.greaterThan(Q_MODULUS.value)) {</span>
<span class="nc" id="L500">      return new Element(calc.subtract(Q_MODULUS.value));</span>
    }
<span class="fc" id="L502">    return new Element(calc);</span>
  }

  public Element toMontgomery() {
<span class="fc" id="L506">    return multiply(R_SQUARE);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>