<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigurationOverviewBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.cli</a> &gt; <span class="el_source">ConfigurationOverviewBuilder.java</span></div><h1>ConfigurationOverviewBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright Hyperledger Besu Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.cli;

import org.hyperledger.besu.BesuInfo;
import org.hyperledger.besu.ethereum.eth.transactions.TransactionPoolConfiguration;
import org.hyperledger.besu.evm.internal.EvmConfiguration;
import org.hyperledger.besu.services.BesuPluginContextImpl;
import org.hyperledger.besu.util.log.FramedLogMessage;
import org.hyperledger.besu.util.platform.PlatformDetector;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;

import org.slf4j.Logger;
import oshi.PlatformEnum;
import oshi.SystemInfo;
import oshi.hardware.HardwareAbstractionLayer;

/** The Configuration overview builder. */
public class ConfigurationOverviewBuilder {
  @SuppressWarnings(&quot;PrivateStaticFinalLoggers&quot;)
  private final Logger logger;

  private String network;
  private BigInteger networkId;
  private String profile;
  private boolean hasCustomGenesis;
  private String customGenesisFileName;
  private String dataStorage;
  private String syncMode;
  private Integer rpcPort;
  private Collection&lt;String&gt; rpcHttpApis;
  private Integer enginePort;
  private Collection&lt;String&gt; engineApis;
  private String engineJwtFilePath;
<span class="fc" id="L54">  private boolean isHighSpec = false;</span>
<span class="fc" id="L55">  private boolean isBonsaiLimitTrieLogsEnabled = false;</span>
<span class="fc" id="L56">  private long trieLogRetentionLimit = 0;</span>
<span class="fc" id="L57">  private Integer trieLogsPruningWindowSize = null;</span>
<span class="fc" id="L58">  private boolean isSnapServerEnabled = false;</span>
  private TransactionPoolConfiguration.Implementation txPoolImplementation;
  private EvmConfiguration.WorldUpdaterMode worldStateUpdateMode;
  private Map&lt;String, String&gt; environment;
  private BesuPluginContextImpl besuPluginContext;

  /**
   * @param logger the logger
   */
<span class="fc" id="L67">  public ConfigurationOverviewBuilder(final Logger logger) {</span>
<span class="fc" id="L68">    this.logger = logger;</span>
<span class="fc" id="L69">  }</span>

  /**
   * Sets network.
   *
   * @param network the network
   * @return the network
   */
  public ConfigurationOverviewBuilder setNetwork(final String network) {
<span class="fc" id="L78">    this.network = network;</span>
<span class="fc" id="L79">    return this;</span>
  }

  /**
   * Sets whether a networkId has been specified
   *
   * @param networkId the specified networkId
   * @return the builder
   */
  public ConfigurationOverviewBuilder setNetworkId(final BigInteger networkId) {
<span class="fc" id="L89">    this.networkId = networkId;</span>
<span class="fc" id="L90">    return this;</span>
  }

  /**
   * Sets profile.
   *
   * @param profile the profile
   * @return the profile
   */
  public ConfigurationOverviewBuilder setProfile(final String profile) {
<span class="fc" id="L100">    this.profile = profile;</span>
<span class="fc" id="L101">    return this;</span>
  }

  /**
   * Sets whether a custom genesis has been specified.
   *
   * @param hasCustomGenesis a boolean representing whether a custom genesis file was specified
   * @return the builder
   */
  public ConfigurationOverviewBuilder setHasCustomGenesis(final boolean hasCustomGenesis) {
<span class="fc" id="L111">    this.hasCustomGenesis = hasCustomGenesis;</span>
<span class="fc" id="L112">    return this;</span>
  }

  /**
   * Sets location of custom genesis file specified.
   *
   * @param customGenesisFileName the filename of the custom genesis file, only set if specified
   * @return the builder
   */
  public ConfigurationOverviewBuilder setCustomGenesis(final String customGenesisFileName) {
<span class="fc" id="L122">    this.customGenesisFileName = customGenesisFileName;</span>
<span class="fc" id="L123">    return this;</span>
  }

  /**
   * Sets data storage.
   *
   * @param dataStorage the data storage
   * @return the builder
   */
  public ConfigurationOverviewBuilder setDataStorage(final String dataStorage) {
<span class="fc" id="L133">    this.dataStorage = dataStorage;</span>
<span class="fc" id="L134">    return this;</span>
  }

  /**
   * Sets sync mode.
   *
   * @param syncMode the sync mode
   * @return the builder
   */
  public ConfigurationOverviewBuilder setSyncMode(final String syncMode) {
<span class="fc" id="L144">    this.syncMode = syncMode;</span>
<span class="fc" id="L145">    return this;</span>
  }

  /**
   * Sets rpc port.
   *
   * @param rpcPort the rpc port
   * @return the builder
   */
  public ConfigurationOverviewBuilder setRpcPort(final Integer rpcPort) {
<span class="fc" id="L155">    this.rpcPort = rpcPort;</span>
<span class="fc" id="L156">    return this;</span>
  }

  /**
   * Sets rpc http apis.
   *
   * @param rpcHttpApis the rpc http apis
   * @return the builder
   */
  public ConfigurationOverviewBuilder setRpcHttpApis(final Collection&lt;String&gt; rpcHttpApis) {
<span class="fc" id="L166">    this.rpcHttpApis = rpcHttpApis;</span>
<span class="fc" id="L167">    return this;</span>
  }

  /**
   * Sets engine port.
   *
   * @param enginePort the engine port
   * @return the builder
   */
  public ConfigurationOverviewBuilder setEnginePort(final Integer enginePort) {
<span class="fc" id="L177">    this.enginePort = enginePort;</span>
<span class="fc" id="L178">    return this;</span>
  }

  /**
   * Sets engine apis.
   *
   * @param engineApis the engine apis
   * @return the builder
   */
  public ConfigurationOverviewBuilder setEngineApis(final Collection&lt;String&gt; engineApis) {
<span class="fc" id="L188">    this.engineApis = engineApis;</span>
<span class="fc" id="L189">    return this;</span>
  }

  /**
   * Sets high spec enabled.
   *
   * @return the builder
   */
  public ConfigurationOverviewBuilder setHighSpecEnabled() {
<span class="fc" id="L198">    isHighSpec = true;</span>
<span class="fc" id="L199">    return this;</span>
  }

  /**
   * Sets limit trie logs enabled
   *
   * @return the builder
   */
  public ConfigurationOverviewBuilder setLimitTrieLogsEnabled() {
<span class="fc" id="L208">    isBonsaiLimitTrieLogsEnabled = true;</span>
<span class="fc" id="L209">    return this;</span>
  }

  /**
   * Sets trie log retention limit
   *
   * @param limit the number of blocks to retain trie logs for
   * @return the builder
   */
  public ConfigurationOverviewBuilder setTrieLogRetentionLimit(final long limit) {
<span class="fc" id="L219">    trieLogRetentionLimit = limit;</span>
<span class="fc" id="L220">    return this;</span>
  }

  /**
   * Sets snap server enabled/disabled
   *
   * @param snapServerEnabled bool to indicate if snap server is enabled
   * @return the builder
   */
  public ConfigurationOverviewBuilder setSnapServerEnabled(final boolean snapServerEnabled) {
<span class="fc" id="L230">    isSnapServerEnabled = snapServerEnabled;</span>
<span class="fc" id="L231">    return this;</span>
  }

  /**
   * Sets trie logs pruning window size
   *
   * @param size the max number of blocks to load and prune trie logs for at startup
   * @return the builder
   */
  public ConfigurationOverviewBuilder setTrieLogsPruningWindowSize(final int size) {
<span class="fc" id="L241">    trieLogsPruningWindowSize = size;</span>
<span class="fc" id="L242">    return this;</span>
  }

  /**
   * Sets the txpool implementation in use.
   *
   * @param implementation the txpool implementation
   * @return the builder
   */
  public ConfigurationOverviewBuilder setTxPoolImplementation(
      final TransactionPoolConfiguration.Implementation implementation) {
<span class="fc" id="L253">    txPoolImplementation = implementation;</span>
<span class="fc" id="L254">    return this;</span>
  }

  /**
   * Sets the world state updater mode
   *
   * @param worldStateUpdateMode the world state updater mode
   * @return the builder
   */
  public ConfigurationOverviewBuilder setWorldStateUpdateMode(
      final EvmConfiguration.WorldUpdaterMode worldStateUpdateMode) {
<span class="fc" id="L265">    this.worldStateUpdateMode = worldStateUpdateMode;</span>
<span class="fc" id="L266">    return this;</span>
  }

  /**
   * Sets the engine jwt file path.
   *
   * @param engineJwtFilePath the engine apis
   * @return the builder
   */
  public ConfigurationOverviewBuilder setEngineJwtFile(final String engineJwtFilePath) {
<span class="fc" id="L276">    this.engineJwtFilePath = engineJwtFilePath;</span>
<span class="fc" id="L277">    return this;</span>
  }

  /**
   * Sets the environment variables.
   *
   * @param environment the environment variables
   * @return the builder
   */
  public ConfigurationOverviewBuilder setEnvironment(final Map&lt;String, String&gt; environment) {
<span class="fc" id="L287">    this.environment = environment;</span>
<span class="fc" id="L288">    return this;</span>
  }

  /**
   * Build configuration overview.
   *
   * @return the string representing configuration overview
   */
  public String build() {
<span class="fc" id="L297">    final List&lt;String&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L298">    lines.add(&quot;Besu version &quot; + BesuInfo.class.getPackage().getImplementationVersion());</span>
<span class="fc" id="L299">    lines.add(&quot;&quot;);</span>
<span class="fc" id="L300">    lines.add(&quot;Configuration:&quot;);</span>

    // Don't include the default network if a genesis file has been supplied
<span class="fc bfc" id="L303" title="All 4 branches covered.">    if (network != null &amp;&amp; !hasCustomGenesis) {</span>
<span class="fc" id="L304">      lines.add(&quot;Network: &quot; + network);</span>
    }

<span class="fc bfc" id="L307" title="All 2 branches covered.">    if (hasCustomGenesis) {</span>
<span class="fc" id="L308">      lines.add(&quot;Network: Custom genesis file&quot;);</span>
<span class="fc" id="L309">      lines.add(</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">          customGenesisFileName == null ? &quot;Custom genesis file is null&quot; : customGenesisFileName);</span>
    }

<span class="fc bfc" id="L313" title="All 2 branches covered.">    if (networkId != null) {</span>
<span class="fc" id="L314">      lines.add(&quot;Network Id: &quot; + networkId);</span>
    }

<span class="fc bfc" id="L317" title="All 2 branches covered.">    if (profile != null) {</span>
<span class="fc" id="L318">      lines.add(&quot;Profile: &quot; + profile);</span>
    }

<span class="fc bfc" id="L321" title="All 2 branches covered.">    if (dataStorage != null) {</span>
<span class="fc" id="L322">      lines.add(&quot;Data storage: &quot; + dataStorage);</span>
    }

<span class="fc bfc" id="L325" title="All 2 branches covered.">    if (syncMode != null) {</span>
<span class="fc" id="L326">      lines.add(&quot;Sync mode: &quot; + syncMode);</span>
    }

<span class="fc bfc" id="L329" title="All 2 branches covered.">    if (rpcHttpApis != null) {</span>
<span class="fc" id="L330">      lines.add(&quot;RPC HTTP APIs: &quot; + String.join(&quot;,&quot;, rpcHttpApis));</span>
    }
<span class="fc bfc" id="L332" title="All 2 branches covered.">    if (rpcPort != null) {</span>
<span class="fc" id="L333">      lines.add(&quot;RPC HTTP port: &quot; + rpcPort);</span>
    }

<span class="fc bfc" id="L336" title="All 2 branches covered.">    if (engineApis != null) {</span>
<span class="fc" id="L337">      lines.add(&quot;Engine APIs: &quot; + String.join(&quot;,&quot;, engineApis));</span>
    }
<span class="fc bfc" id="L339" title="All 2 branches covered.">    if (enginePort != null) {</span>
<span class="fc" id="L340">      lines.add(&quot;Engine port: &quot; + enginePort);</span>
    }
<span class="fc bfc" id="L342" title="All 2 branches covered.">    if (engineJwtFilePath != null) {</span>
<span class="fc" id="L343">      lines.add(&quot;Engine JWT: &quot; + engineJwtFilePath);</span>
    }

<span class="fc" id="L346">    lines.add(&quot;Using &quot; + txPoolImplementation + &quot; transaction pool implementation&quot;);</span>

<span class="fc bfc" id="L348" title="All 2 branches covered.">    if (isHighSpec) {</span>
<span class="fc" id="L349">      lines.add(&quot;Experimental high spec configuration enabled&quot;);</span>
    }

<span class="fc" id="L352">    lines.add(&quot;Using &quot; + worldStateUpdateMode + &quot; worldstate update mode&quot;);</span>

<span class="pc bpc" id="L354" title="1 of 2 branches missed.">    if (isSnapServerEnabled) {</span>
<span class="nc" id="L355">      lines.add(&quot;Experimental Snap Sync server enabled&quot;);</span>
    }

<span class="fc bfc" id="L358" title="All 2 branches covered.">    if (isBonsaiLimitTrieLogsEnabled) {</span>
<span class="fc" id="L359">      final StringBuilder trieLogPruningString = new StringBuilder();</span>
<span class="fc" id="L360">      trieLogPruningString</span>
<span class="fc" id="L361">          .append(&quot;Limit trie logs enabled: retention: &quot;)</span>
<span class="fc" id="L362">          .append(trieLogRetentionLimit);</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">      if (trieLogsPruningWindowSize != null) {</span>
<span class="fc" id="L364">        trieLogPruningString.append(&quot;; prune window: &quot;).append(trieLogsPruningWindowSize);</span>
      }
<span class="fc" id="L366">      lines.add(trieLogPruningString.toString());</span>
    }

<span class="fc" id="L369">    lines.add(&quot;&quot;);</span>
<span class="fc" id="L370">    lines.add(&quot;Host:&quot;);</span>

<span class="fc" id="L372">    lines.add(&quot;Java: &quot; + PlatformDetector.getVM());</span>
<span class="fc" id="L373">    lines.add(&quot;Maximum heap size: &quot; + normalizeSize(Runtime.getRuntime().maxMemory()));</span>
<span class="fc" id="L374">    lines.add(&quot;OS: &quot; + PlatformDetector.getOS());</span>

<span class="pc bpc" id="L376" title="1 of 2 branches missed.">    if (SystemInfo.getCurrentPlatform() == PlatformEnum.LINUX) {</span>
<span class="nc" id="L377">      final String glibcVersion = PlatformDetector.getGlibc();</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">      if (glibcVersion != null) {</span>
<span class="nc" id="L379">        lines.add(&quot;glibc: &quot; + glibcVersion);</span>
      }

<span class="nc" id="L382">      detectJemalloc(lines);</span>
    }

<span class="fc" id="L385">    final HardwareAbstractionLayer hardwareInfo = new SystemInfo().getHardware();</span>

<span class="fc" id="L387">    lines.add(&quot;Total memory: &quot; + normalizeSize(hardwareInfo.getMemory().getTotal()));</span>
<span class="fc" id="L388">    lines.add(&quot;CPU cores: &quot; + hardwareInfo.getProcessor().getLogicalProcessorCount());</span>

<span class="fc" id="L390">    lines.add(&quot;&quot;);</span>

<span class="pc bpc" id="L392" title="1 of 2 branches missed.">    if (besuPluginContext != null) {</span>
<span class="nc" id="L393">      lines.addAll(besuPluginContext.getPluginsSummaryLog());</span>
    }

<span class="fc" id="L396">    return FramedLogMessage.generate(lines);</span>
  }

  private void detectJemalloc(final List&lt;String&gt; lines) {
<span class="nc bnc" id="L400" title="All 2 branches missed.">    Optional.ofNullable(Objects.isNull(environment) ? null : environment.get(&quot;BESU_USING_JEMALLOC&quot;))</span>
<span class="nc" id="L401">        .ifPresentOrElse(</span>
            t -&gt; {
              try {
<span class="nc" id="L404">                final String version = PlatformDetector.getJemalloc();</span>
<span class="nc" id="L405">                lines.add(&quot;jemalloc: &quot; + version);</span>
<span class="nc" id="L406">              } catch (final Throwable throwable) {</span>
<span class="nc" id="L407">                logger.warn(</span>
                    &quot;BESU_USING_JEMALLOC is present but we failed to load jemalloc library to get the version&quot;,
                    throwable);
<span class="nc" id="L410">              }</span>
<span class="nc" id="L411">            },</span>
            () -&gt; {
              // in case the user is using jemalloc without BESU_USING_JEMALLOC env var
              try {
<span class="nc" id="L415">                final String version = PlatformDetector.getJemalloc();</span>
<span class="nc" id="L416">                lines.add(&quot;jemalloc: &quot; + version);</span>
<span class="nc" id="L417">              } catch (final Throwable throwable) {</span>
<span class="nc" id="L418">                logger.info(</span>
                    &quot;jemalloc library not found, memory usage may be reduced by installing it&quot;);
<span class="nc" id="L420">              }</span>
<span class="nc" id="L421">            });</span>
<span class="nc" id="L422">  }</span>

  private String normalizeSize(final long size) {
<span class="fc" id="L425">    return String.format(&quot;%.02f&quot;, (double) (size) / 1024 / 1024 / 1024) + &quot; GB&quot;;</span>
  }

  /**
   * set the plugin context
   *
   * @param besuPluginContext the plugin context
   */
  public void setPluginContext(final BesuPluginContextImpl besuPluginContext) {
<span class="fc" id="L434">    this.besuPluginContext = besuPluginContext;</span>
<span class="fc" id="L435">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>