<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BlockResultFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.api.jsonrpc.internal.results</a> &gt; <span class="el_source">BlockResultFactory.java</span></div><h1>BlockResultFactory.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.api.jsonrpc.internal.results;

import org.hyperledger.besu.datatypes.Hash;
import org.hyperledger.besu.datatypes.Wei;
import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.EngineGetPayloadBodiesResultV1.PayloadBody;
import org.hyperledger.besu.ethereum.api.query.BlockWithMetadata;
import org.hyperledger.besu.ethereum.api.query.TransactionWithMetadata;
import org.hyperledger.besu.ethereum.core.Block;
import org.hyperledger.besu.ethereum.core.BlockBody;
import org.hyperledger.besu.ethereum.core.BlockHeader;
import org.hyperledger.besu.ethereum.core.BlockValueCalculator;
import org.hyperledger.besu.ethereum.core.BlockWithReceipts;
import org.hyperledger.besu.ethereum.core.encoding.EncodingContext;
import org.hyperledger.besu.ethereum.core.encoding.TransactionEncoder;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.TextNode;
import org.apache.tuweni.bytes.Bytes;

<span class="fc" id="L39">public class BlockResultFactory {</span>

  public BlockResult transactionComplete(
      final BlockWithMetadata&lt;TransactionWithMetadata, Hash&gt; blockWithMetadata) {
<span class="fc" id="L43">    return transactionComplete(blockWithMetadata, false);</span>
  }

  public BlockResult transactionComplete(
      final BlockWithMetadata&lt;TransactionWithMetadata, Hash&gt; blockWithMetadata,
      final boolean includeCoinbase) {
<span class="fc" id="L49">    final List&lt;TransactionResult&gt; txs =</span>
<span class="fc" id="L50">        blockWithMetadata.getTransactions().stream()</span>
<span class="fc" id="L51">            .map(TransactionCompleteResult::new)</span>
<span class="fc" id="L52">            .collect(Collectors.toList());</span>
<span class="fc" id="L53">    final List&lt;JsonNode&gt; ommers =</span>
<span class="fc" id="L54">        blockWithMetadata.getOmmers().stream()</span>
<span class="fc" id="L55">            .map(Hash::toString)</span>
<span class="fc" id="L56">            .map(TextNode::new)</span>
<span class="fc" id="L57">            .collect(Collectors.toList());</span>
<span class="fc" id="L58">    return new BlockResult(</span>
<span class="fc" id="L59">        blockWithMetadata.getHeader(),</span>
        txs,
        ommers,
<span class="fc" id="L62">        blockWithMetadata.getTotalDifficulty(),</span>
<span class="fc" id="L63">        blockWithMetadata.getSize(),</span>
        includeCoinbase,
<span class="fc" id="L65">        blockWithMetadata.getWithdrawals());</span>
  }

  public BlockResult transactionComplete(final Block block) {

<span class="fc" id="L70">    final int count = block.getBody().getTransactions().size();</span>
<span class="fc" id="L71">    final List&lt;TransactionWithMetadata&gt; transactionWithMetadata = new ArrayList&lt;&gt;(count);</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">    for (int i = 0; i &lt; count; i++) {</span>
<span class="fc" id="L73">      transactionWithMetadata.add(</span>
          new TransactionWithMetadata(
<span class="fc" id="L75">              block.getBody().getTransactions().get(i),</span>
<span class="fc" id="L76">              block.getHeader().getNumber(),</span>
<span class="fc" id="L77">              block.getHeader().getBaseFee(),</span>
<span class="fc" id="L78">              block.getHash(),</span>
              i));
    }
<span class="fc" id="L81">    final List&lt;TransactionResult&gt; txs =</span>
<span class="fc" id="L82">        transactionWithMetadata.stream()</span>
<span class="fc" id="L83">            .map(TransactionCompleteResult::new)</span>
<span class="fc" id="L84">            .collect(Collectors.toList());</span>

<span class="fc" id="L86">    final List&lt;JsonNode&gt; ommers =</span>
<span class="fc" id="L87">        block.getBody().getOmmers().stream()</span>
<span class="fc" id="L88">            .map(BlockHeader::getHash)</span>
<span class="fc" id="L89">            .map(Hash::toString)</span>
<span class="fc" id="L90">            .map(TextNode::new)</span>
<span class="fc" id="L91">            .collect(Collectors.toList());</span>
<span class="fc" id="L92">    return new BlockResult(</span>
<span class="fc" id="L93">        block.getHeader(), txs, ommers, block.getHeader().getDifficulty(), block.calculateSize());</span>
  }

  public EngineGetPayloadResultV1 payloadTransactionCompleteV1(final Block block) {
<span class="fc" id="L97">    final List&lt;String&gt; txs =</span>
<span class="fc" id="L98">        block.getBody().getTransactions().stream()</span>
<span class="fc" id="L99">            .map(</span>
                transaction -&gt;
<span class="nc" id="L101">                    TransactionEncoder.encodeOpaqueBytes(transaction, EncodingContext.BLOCK_BODY))</span>
<span class="fc" id="L102">            .map(Bytes::toHexString)</span>
<span class="fc" id="L103">            .collect(Collectors.toList());</span>

<span class="fc" id="L105">    return new EngineGetPayloadResultV1(block.getHeader(), txs);</span>
  }

  public EngineGetPayloadResultV2 payloadTransactionCompleteV2(
      final BlockWithReceipts blockWithReceipts) {
<span class="fc" id="L110">    final List&lt;String&gt; txs =</span>
<span class="fc" id="L111">        blockWithReceipts.getBlock().getBody().getTransactions().stream()</span>
<span class="fc" id="L112">            .map(</span>
                transaction -&gt;
<span class="nc" id="L114">                    TransactionEncoder.encodeOpaqueBytes(transaction, EncodingContext.BLOCK_BODY))</span>
<span class="fc" id="L115">            .map(Bytes::toHexString)</span>
<span class="fc" id="L116">            .collect(Collectors.toList());</span>

<span class="fc" id="L118">    final Wei blockValue = new BlockValueCalculator().calculateBlockValue(blockWithReceipts);</span>
<span class="fc" id="L119">    return new EngineGetPayloadResultV2(</span>
<span class="fc" id="L120">        blockWithReceipts.getHeader(),</span>
        txs,
<span class="fc" id="L122">        blockWithReceipts.getBlock().getBody().getWithdrawals(),</span>
<span class="fc" id="L123">        Quantity.create(blockValue));</span>
  }

  public EngineGetPayloadBodiesResultV1 payloadBodiesCompleteV1(
      final List&lt;Optional&lt;BlockBody&gt;&gt; blockBodies) {
<span class="fc" id="L128">    final List&lt;PayloadBody&gt; payloadBodies =</span>
<span class="fc" id="L129">        blockBodies.stream()</span>
<span class="fc" id="L130">            .map(maybeBody -&gt; maybeBody.map(PayloadBody::new).orElse(null))</span>
<span class="fc" id="L131">            .collect(Collectors.toList());</span>
<span class="fc" id="L132">    return new EngineGetPayloadBodiesResultV1(payloadBodies);</span>
  }

  public EngineGetPayloadResultV3 payloadTransactionCompleteV3(
      final BlockWithReceipts blockWithReceipts) {
<span class="fc" id="L137">    final List&lt;String&gt; txs =</span>
<span class="fc" id="L138">        blockWithReceipts.getBlock().getBody().getTransactions().stream()</span>
<span class="fc" id="L139">            .map(</span>
                transaction -&gt;
<span class="fc" id="L141">                    TransactionEncoder.encodeOpaqueBytes(transaction, EncodingContext.BLOCK_BODY))</span>
<span class="fc" id="L142">            .map(Bytes::toHexString)</span>
<span class="fc" id="L143">            .collect(Collectors.toList());</span>

<span class="fc" id="L145">    final Wei blockValue = new BlockValueCalculator().calculateBlockValue(blockWithReceipts);</span>

<span class="fc" id="L147">    final BlobsBundleV1 blobsBundleV1 =</span>
<span class="fc" id="L148">        new BlobsBundleV1(blockWithReceipts.getBlock().getBody().getTransactions());</span>
<span class="fc" id="L149">    return new EngineGetPayloadResultV3(</span>
<span class="fc" id="L150">        blockWithReceipts.getHeader(),</span>
        txs,
<span class="fc" id="L152">        blockWithReceipts.getBlock().getBody().getWithdrawals(),</span>
<span class="fc" id="L153">        Quantity.create(blockValue),</span>
        blobsBundleV1);
  }

  public EngineGetPayloadResultV4 payloadTransactionCompleteV4(
      final BlockWithReceipts blockWithReceipts) {
<span class="fc" id="L159">    final List&lt;String&gt; txs =</span>
<span class="fc" id="L160">        blockWithReceipts.getBlock().getBody().getTransactions().stream()</span>
<span class="fc" id="L161">            .map(</span>
                transaction -&gt;
<span class="fc" id="L163">                    TransactionEncoder.encodeOpaqueBytes(transaction, EncodingContext.BLOCK_BODY))</span>
<span class="fc" id="L164">            .map(Bytes::toHexString)</span>
<span class="fc" id="L165">            .collect(Collectors.toList());</span>

<span class="fc" id="L167">    final Wei blockValue = new BlockValueCalculator().calculateBlockValue(blockWithReceipts);</span>

<span class="fc" id="L169">    final BlobsBundleV1 blobsBundleV1 =</span>
<span class="fc" id="L170">        new BlobsBundleV1(blockWithReceipts.getBlock().getBody().getTransactions());</span>
<span class="fc" id="L171">    return new EngineGetPayloadResultV4(</span>
<span class="fc" id="L172">        blockWithReceipts.getHeader(),</span>
        txs,
<span class="fc" id="L174">        blockWithReceipts.getBlock().getBody().getWithdrawals(),</span>
<span class="fc" id="L175">        blockWithReceipts.getBlock().getBody().getDeposits(),</span>
<span class="fc" id="L176">        blockWithReceipts.getBlock().getBody().getExits(),</span>
<span class="fc" id="L177">        Quantity.create(blockValue),</span>
        blobsBundleV1);
  }

  public BlockResult transactionHash(final BlockWithMetadata&lt;Hash, Hash&gt; blockWithMetadata) {
<span class="fc" id="L182">    return transactionHash(blockWithMetadata, false);</span>
  }

  public BlockResult transactionHash(
      final BlockWithMetadata&lt;Hash, Hash&gt; blockWithMetadata, final boolean includeCoinbase) {
<span class="fc" id="L187">    final List&lt;TransactionResult&gt; txs =</span>
<span class="fc" id="L188">        blockWithMetadata.getTransactions().stream()</span>
<span class="fc" id="L189">            .map(Hash::toString)</span>
<span class="fc" id="L190">            .map(TransactionHashResult::new)</span>
<span class="fc" id="L191">            .collect(Collectors.toList());</span>
<span class="fc" id="L192">    final List&lt;JsonNode&gt; ommers =</span>
<span class="fc" id="L193">        blockWithMetadata.getOmmers().stream()</span>
<span class="fc" id="L194">            .map(Hash::toString)</span>
<span class="fc" id="L195">            .map(TextNode::new)</span>
<span class="fc" id="L196">            .collect(Collectors.toList());</span>
<span class="fc" id="L197">    return new BlockResult(</span>
<span class="fc" id="L198">        blockWithMetadata.getHeader(),</span>
        txs,
        ommers,
<span class="fc" id="L201">        blockWithMetadata.getTotalDifficulty(),</span>
<span class="fc" id="L202">        blockWithMetadata.getSize(),</span>
        includeCoinbase,
<span class="fc" id="L204">        blockWithMetadata.getWithdrawals());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>