<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BlockTestUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.testutil</a> &gt; <span class="el_source">BlockTestUtil.java</span></div><h1>BlockTestUtil.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.testutil;

import java.io.IOException;
import java.net.URISyntaxException;
import java.net.URL;
import java.nio.file.FileSystemNotFoundException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.nio.file.StandardOpenOption;
import java.util.function.Supplier;

import com.google.common.base.Preconditions;
import com.google.common.base.Suppliers;
import com.google.common.io.Resources;

/** The Block test util. */
public final class BlockTestUtil {

<span class="nc" id="L35">  private BlockTestUtil() {</span>
<span class="nc" id="L36">    throw new RuntimeException(&quot;Utility Class&quot;);</span>
  }

<span class="fc" id="L39">  private static final Supplier&lt;ChainResources&gt; testChainSupplier =</span>
<span class="fc" id="L40">      Suppliers.memoize(BlockTestUtil::supplyTestChainResources);</span>
<span class="fc" id="L41">  private static final Supplier&lt;ChainResources&gt; hiveTestChainSupplier =</span>
<span class="fc" id="L42">      Suppliers.memoize(BlockTestUtil::supplyHiveTestChainResources);</span>
<span class="fc" id="L43">  private static final Supplier&lt;ChainResources&gt; testChainLondonSupplier =</span>
<span class="fc" id="L44">      Suppliers.memoize(BlockTestUtil::supplyTestChainLondonResources);</span>
<span class="fc" id="L45">  private static final Supplier&lt;ChainResources&gt; mainnetChainSupplier =</span>
<span class="fc" id="L46">      Suppliers.memoize(BlockTestUtil::supplyMainnetChainResources);</span>
<span class="fc" id="L47">  private static final Supplier&lt;ChainResources&gt; badPowChainSupplier =</span>
<span class="fc" id="L48">      Suppliers.memoize(BlockTestUtil::supplyBadPowChainResources);</span>
<span class="fc" id="L49">  private static final Supplier&lt;ChainResources&gt; forkOutdatedSupplier =</span>
<span class="fc" id="L50">      Suppliers.memoize(BlockTestUtil::supplyOutdatedForkResources);</span>
<span class="fc" id="L51">  private static final Supplier&lt;ChainResources&gt; forkUpgradedSupplier =</span>
<span class="fc" id="L52">      Suppliers.memoize(BlockTestUtil::supplyUpgradedForkResources);</span>
<span class="fc" id="L53">  private static final Supplier&lt;ChainResources&gt; testRpcCompactChainSupplier =</span>
<span class="fc" id="L54">      Suppliers.memoize(BlockTestUtil::supplyTestRpcCompactResources);</span>

  /**
   * Gets test blockchain url.
   *
   * @return the test blockchain url
   */
  public static URL getTestBlockchainUrl() {
<span class="fc" id="L62">    return getTestChainResources().getBlocksURL();</span>
  }

  /**
   * Gets test london blockchain url.
   *
   * @return the test london blockchain url
   */
  public static URL getTestLondonBlockchainUrl() {
<span class="nc" id="L71">    return getTestChainLondonResources().getBlocksURL();</span>
  }

  /**
   * Gets test genesis url.
   *
   * @return the test genesis url
   */
  public static URL getTestGenesisUrl() {
<span class="fc" id="L80">    return getTestChainResources().getGenesisURL();</span>
  }

  /**
   * Gets test london genesis url.
   *
   * @return the test london genesis url
   */
  public static URL getTestLondonGenesisUrl() {
<span class="nc" id="L89">    return getTestChainLondonResources().getGenesisURL();</span>
  }

  /**
   * Gets test chain resources.
   *
   * @return the test chain resources
   */
  public static ChainResources getTestChainResources() {
<span class="fc" id="L98">    return testChainSupplier.get();</span>
  }

  /**
   * Gets test chain resources for hive tests.
   *
   * @return the test chain resources
   */
  public static ChainResources getHiveTestChainResources() {
<span class="fc" id="L107">    return hiveTestChainSupplier.get();</span>
  }

  /**
   * Gets test chain london resources.
   *
   * @return the test chain london resources
   */
  public static ChainResources getTestChainLondonResources() {
<span class="nc" id="L116">    return testChainLondonSupplier.get();</span>
  }

  /**
   * Gets mainnet resources.
   *
   * @return the mainnet resources
   */
  public static ChainResources getMainnetResources() {
<span class="fc" id="L125">    return mainnetChainSupplier.get();</span>
  }

  private static ChainResources getBadPowResources() {
<span class="fc" id="L129">    return badPowChainSupplier.get();</span>
  }

  /**
   * Gets outdated fork resources.
   *
   * @return the outdated fork resources
   */
  public static ChainResources getOutdatedForkResources() {
<span class="fc" id="L138">    return forkOutdatedSupplier.get();</span>
  }

  /**
   * Gets upgraded fork resources.
   *
   * @return the upgraded fork resources
   */
  public static ChainResources getUpgradedForkResources() {
<span class="fc" id="L147">    return forkUpgradedSupplier.get();</span>
  }

  /**
   * Gets Eth Ref Test resources.
   *
   * @return the Eth Ref Test resources.
   */
  public static ChainResources getEthRefTestResources() {
<span class="nc" id="L156">    return testRpcCompactChainSupplier.get();</span>
  }

  private static ChainResources supplyTestChainResources() {
<span class="fc" id="L160">    final URL genesisURL =</span>
<span class="fc" id="L161">        ensureFileUrl(BlockTestUtil.class.getClassLoader().getResource(&quot;testGenesis.json&quot;));</span>
<span class="fc" id="L162">    final URL blocksURL =</span>
<span class="fc" id="L163">        ensureFileUrl(BlockTestUtil.class.getClassLoader().getResource(&quot;testBlockchain.blocks&quot;));</span>
<span class="fc" id="L164">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyHiveTestChainResources() {
<span class="fc" id="L168">    final URL genesisURL =</span>
<span class="fc" id="L169">        ensureFileUrl(BlockTestUtil.class.getClassLoader().getResource(&quot;hive/testGenesis.json&quot;));</span>
<span class="fc" id="L170">    final URL blocksURL =</span>
<span class="fc" id="L171">        ensureFileUrl(</span>
<span class="fc" id="L172">            BlockTestUtil.class.getClassLoader().getResource(&quot;hive/testBlockchain.blocks&quot;));</span>
<span class="fc" id="L173">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyTestChainLondonResources() {
<span class="nc" id="L177">    final URL genesisURL =</span>
<span class="nc" id="L178">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="nc" id="L180">                .getClassLoader()</span>
<span class="nc" id="L181">                .getResource(&quot;fork-london-data/testLondonGenesis.json&quot;));</span>
<span class="nc" id="L182">    final URL blocksURL =</span>
<span class="nc" id="L183">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="nc" id="L185">                .getClassLoader()</span>
<span class="nc" id="L186">                .getResource(&quot;fork-london-data/testLondonBlockchain.blocks&quot;));</span>
<span class="nc" id="L187">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyMainnetChainResources() {
<span class="fc" id="L191">    final URL genesisURL =</span>
<span class="fc" id="L192">        ensureFileUrl(</span>
<span class="fc" id="L193">            BlockTestUtil.class.getClassLoader().getResource(&quot;mainnet-data/mainnet.json&quot;));</span>
<span class="fc" id="L194">    final URL blocksURL =</span>
<span class="fc" id="L195">        ensureFileUrl(BlockTestUtil.class.getClassLoader().getResource(&quot;mainnet-data/1000.blocks&quot;));</span>
<span class="fc" id="L196">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyBadPowChainResources() {
<span class="fc" id="L200">    final URL genesisURL =</span>
<span class="fc" id="L201">        ensureFileUrl(</span>
<span class="fc" id="L202">            BlockTestUtil.class.getClassLoader().getResource(&quot;mainnet-data/mainnet.json&quot;));</span>
<span class="fc" id="L203">    final URL blocksURL =</span>
<span class="fc" id="L204">        ensureFileUrl(</span>
<span class="fc" id="L205">            BlockTestUtil.class.getClassLoader().getResource(&quot;mainnet-data/badpow.blocks&quot;));</span>
<span class="fc" id="L206">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyOutdatedForkResources() {
<span class="fc" id="L210">    final URL genesisURL =</span>
<span class="fc" id="L211">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="fc" id="L213">                .getClassLoader()</span>
<span class="fc" id="L214">                .getResource(&quot;fork-chain-data/genesis-outdated.json&quot;));</span>
<span class="fc" id="L215">    final URL blocksURL =</span>
<span class="fc" id="L216">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="fc" id="L218">                .getClassLoader()</span>
<span class="fc" id="L219">                .getResource(&quot;fork-chain-data/fork-outdated.blocks&quot;));</span>
<span class="fc" id="L220">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyUpgradedForkResources() {
<span class="fc" id="L224">    final URL genesisURL =</span>
<span class="fc" id="L225">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="fc" id="L227">                .getClassLoader()</span>
<span class="fc" id="L228">                .getResource(&quot;fork-chain-data/genesis-upgraded.json&quot;));</span>
<span class="fc" id="L229">    final URL blocksURL =</span>
<span class="fc" id="L230">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="fc" id="L232">                .getClassLoader()</span>
<span class="fc" id="L233">                .getResource(&quot;fork-chain-data/fork-upgraded.blocks&quot;));</span>
<span class="fc" id="L234">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  private static ChainResources supplyTestRpcCompactResources() {
<span class="nc" id="L238">    final URL genesisURL =</span>
<span class="nc" id="L239">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="nc" id="L241">                .getClassLoader()</span>
<span class="nc" id="L242">                .getResource(&quot;test-eth-ref-rpc-compact/genesis.json&quot;));</span>
<span class="nc" id="L243">    final URL blocksURL =</span>
<span class="nc" id="L244">        ensureFileUrl(</span>
            BlockTestUtil.class
<span class="nc" id="L246">                .getClassLoader()</span>
<span class="nc" id="L247">                .getResource(&quot;test-eth-ref-rpc-compact/chain.blocks&quot;));</span>
<span class="nc" id="L248">    return new ChainResources(genesisURL, blocksURL);</span>
  }

  /** Take a resource URL and if needed copy it to a temp file and return that URL. */
  private static URL ensureFileUrl(final URL resource) {
<span class="fc" id="L253">    Preconditions.checkNotNull(resource);</span>
    try {
      try {
<span class="nc" id="L256">        Paths.get(resource.toURI());</span>
<span class="fc" id="L257">      } catch (final FileSystemNotFoundException e) {</span>
<span class="fc" id="L258">        final Path target = Files.createTempFile(&quot;besu&quot;, null);</span>
<span class="fc" id="L259">        target.toFile().deleteOnExit();</span>
<span class="fc" id="L260">        Files.copy(resource.openStream(), target, StandardCopyOption.REPLACE_EXISTING);</span>
<span class="fc" id="L261">        return target.toUri().toURL();</span>
<span class="nc" id="L262">      }</span>
<span class="nc" id="L263">    } catch (final IOException | URISyntaxException e) {</span>
<span class="nc" id="L264">      throw new RuntimeException(e);</span>
<span class="nc" id="L265">    }</span>
<span class="nc" id="L266">    return resource;</span>
  }

  /**
   * Writes the first 1000 blocks of the public chain to the given file.
   *
   * @param target FIle to write blocks to
   */
  public static void write1000Blocks(final Path target) {
    try {
<span class="fc" id="L276">      Files.write(</span>
          target,
<span class="fc" id="L278">          Resources.toByteArray(getMainnetResources().getBlocksURL()),</span>
          StandardOpenOption.CREATE,
          StandardOpenOption.TRUNCATE_EXISTING);
<span class="nc" id="L281">    } catch (final IOException ex) {</span>
<span class="nc" id="L282">      throw new IllegalStateException(ex);</span>
<span class="fc" id="L283">    }</span>
<span class="fc" id="L284">  }</span>

  /**
   * Writes the first 1000 blocks of the public chain to the given file.
   *
   * @param target FIle to write blocks to
   */
  public static void writeBadPowBlocks(final Path target) {
    try {
<span class="fc" id="L293">      Files.write(</span>
          target,
<span class="fc" id="L295">          Resources.toByteArray(getBadPowResources().getBlocksURL()),</span>
          StandardOpenOption.CREATE,
          StandardOpenOption.TRUNCATE_EXISTING);
<span class="nc" id="L298">    } catch (final IOException ex) {</span>
<span class="nc" id="L299">      throw new IllegalStateException(ex);</span>
<span class="fc" id="L300">    }</span>
<span class="fc" id="L301">  }</span>

  /** The Chain resources. */
  public static class ChainResources {
    private final URL genesisURL;
    private final URL blocksURL;

    /**
     * Instantiates a new Chain resources.
     *
     * @param genesisURL the genesis url
     * @param blocksURL the blocks url
     */
<span class="fc" id="L314">    public ChainResources(final URL genesisURL, final URL blocksURL) {</span>
<span class="fc" id="L315">      this.genesisURL = genesisURL;</span>
<span class="fc" id="L316">      this.blocksURL = blocksURL;</span>
<span class="fc" id="L317">    }</span>

    /**
     * Gets genesis url.
     *
     * @return the genesis url
     */
    public URL getGenesisURL() {
<span class="fc" id="L325">      return genesisURL;</span>
    }

    /**
     * Gets blocks url.
     *
     * @return the blocks url
     */
    public URL getBlocksURL() {
<span class="fc" id="L334">      return blocksURL;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>