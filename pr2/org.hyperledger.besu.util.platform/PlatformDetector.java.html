<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlatformDetector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.util.platform</a> &gt; <span class="el_source">PlatformDetector.java</span></div><h1>PlatformDetector.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.util.platform;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.nio.charset.Charset;
import java.util.Locale;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import com.sun.jna.Library;
import com.sun.jna.Native;
import com.sun.jna.ptr.IntByReference;
import com.sun.jna.ptr.PointerByReference;

/**
 * Detects OS and VMs.
 *
 * &lt;p&gt;Derived from Detector.java https://github.com/trustin/os-maven-plugin/ version 59fd029 on 21
 * Apr 2018, Copyright 2014 Trustin Heuiseung Lee.
 */
<span class="nc" id="L37">public class PlatformDetector {</span>

  private static String _os;
  private static String _osType;
  private static String _vm;
  private static String _arch;
  private static String _glibc;
  private static String _jemalloc;

  /**
   * Gets OS type.
   *
   * @return the OS type
   */
  public static String getOSType() {
<span class="fc bfc" id="L52" title="All 2 branches covered.">    if (_osType == null) {</span>
<span class="fc" id="L53">      detect();</span>
    }
<span class="fc" id="L55">    return _osType;</span>
  }

  /**
   * Gets OS.
   *
   * @return the OS
   */
  public static String getOS() {
<span class="fc bfc" id="L64" title="All 2 branches covered.">    if (_os == null) {</span>
<span class="fc" id="L65">      detect();</span>
    }
<span class="fc" id="L67">    return _os;</span>
  }

  /**
   * Gets Arch.
   *
   * @return the Arch
   */
  public static String getArch() {
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">    if (_arch == null) {</span>
<span class="nc" id="L77">      detect();</span>
    }
<span class="fc" id="L79">    return _arch;</span>
  }

  /**
   * Gets VM.
   *
   * @return the VM
   */
  public static String getVM() {
<span class="fc bfc" id="L88" title="All 2 branches covered.">    if (_vm == null) {</span>
<span class="fc" id="L89">      detect();</span>
    }
<span class="fc" id="L91">    return _vm;</span>
  }

  /**
   * Gets Glibc version.
   *
   * @return the Glibc version
   */
  public static String getGlibc() {
<span class="nc bnc" id="L100" title="All 2 branches missed.">    if (_glibc == null) {</span>
<span class="nc" id="L101">      detectGlibc();</span>
    }

<span class="nc" id="L104">    return _glibc;</span>
  }

  /**
   * Gets jemalloc version.
   *
   * @throws UnsatisfiedLinkError if the library cannot be found or dependent libraries are missing.
   * @return the jemalloc version
   */
  public static String getJemalloc() {
<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (_jemalloc == null) {</span>
<span class="nc" id="L115">      detectJemalloc();</span>
    }

<span class="nc" id="L118">    return _jemalloc;</span>
  }

  private static final String UNKNOWN = &quot;unknown&quot;;

  private static void detect() {
<span class="fc" id="L124">    final String detectedOS = normalizeOS(normalize(&quot;os.name&quot;));</span>
<span class="fc" id="L125">    final String detectedArch = normalizeArch(normalize(&quot;os.arch&quot;));</span>
<span class="fc" id="L126">    final String detectedVM = normalizeVM(normalize(&quot;java.vendor&quot;), normalize(&quot;java.vm.name&quot;));</span>
<span class="fc" id="L127">    final String detectedJavaVersion = normalizeJavaVersion(&quot;java.specification.version&quot;);</span>

<span class="fc" id="L129">    _os = detectedOS + '-' + detectedArch;</span>
<span class="fc" id="L130">    _arch = detectedArch;</span>
<span class="fc" id="L131">    _osType = detectedOS;</span>
<span class="fc" id="L132">    _vm = detectedVM + &quot;-java-&quot; + detectedJavaVersion;</span>
<span class="fc" id="L133">  }</span>

  private static String normalizeOS(final String osName) {
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">    if (osName.startsWith(&quot;aix&quot;)) {</span>
<span class="nc" id="L137">      return &quot;aix&quot;;</span>
    }
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">    if (osName.startsWith(&quot;hpux&quot;)) {</span>
<span class="nc" id="L140">      return &quot;hpux&quot;;</span>
    }
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">    if (osName.startsWith(&quot;os400&quot;)) {</span>
      // Avoid the names such as os4000
<span class="nc bnc" id="L144" title="All 4 branches missed.">      if (osName.length() &lt;= 5 || !Character.isDigit(osName.charAt(5))) {</span>
<span class="nc" id="L145">        return &quot;os400&quot;;</span>
      }
    }
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">    if (osName.startsWith(&quot;linux&quot;)) {</span>
<span class="nc" id="L149">      return &quot;linux&quot;;</span>
    }
<span class="pc bpc" id="L151" title="3 of 4 branches missed.">    if (osName.startsWith(&quot;macosx&quot;) || osName.startsWith(&quot;osx&quot;)) {</span>
<span class="fc" id="L152">      return &quot;osx&quot;;</span>
    }
<span class="nc bnc" id="L154" title="All 2 branches missed.">    if (osName.startsWith(&quot;freebsd&quot;)) {</span>
<span class="nc" id="L155">      return &quot;freebsd&quot;;</span>
    }
<span class="nc bnc" id="L157" title="All 2 branches missed.">    if (osName.startsWith(&quot;openbsd&quot;)) {</span>
<span class="nc" id="L158">      return &quot;openbsd&quot;;</span>
    }
<span class="nc bnc" id="L160" title="All 2 branches missed.">    if (osName.startsWith(&quot;netbsd&quot;)) {</span>
<span class="nc" id="L161">      return &quot;netbsd&quot;;</span>
    }
<span class="nc bnc" id="L163" title="All 4 branches missed.">    if (osName.startsWith(&quot;solaris&quot;) || osName.startsWith(&quot;sunos&quot;)) {</span>
<span class="nc" id="L164">      return &quot;sunos&quot;;</span>
    }
<span class="nc bnc" id="L166" title="All 2 branches missed.">    if (osName.startsWith(&quot;windows&quot;)) {</span>
<span class="nc" id="L167">      return &quot;windows&quot;;</span>
    }

<span class="nc" id="L170">    return UNKNOWN;</span>
  }

  private static String normalizeArch(final String osArch) {
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">    if (osArch.matches(&quot;^(x8664|amd64|ia32e|em64t|x64)$&quot;)) {</span>
<span class="nc" id="L175">      return &quot;x86_64&quot;;</span>
    }
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">    if (osArch.matches(&quot;^(x8632|x86|i[3-6]86|ia32|x32)$&quot;)) {</span>
<span class="nc" id="L178">      return &quot;x86_32&quot;;</span>
    }
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">    if (osArch.matches(&quot;^(ia64w?|itanium64)$&quot;)) {</span>
<span class="nc" id="L181">      return &quot;itanium_64&quot;;</span>
    }
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">    if (&quot;ia64n&quot;.equals(osArch)) {</span>
<span class="nc" id="L184">      return &quot;itanium_32&quot;;</span>
    }
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">    if (osArch.matches(&quot;^(sparc|sparc32)$&quot;)) {</span>
<span class="nc" id="L187">      return &quot;sparc_32&quot;;</span>
    }
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">    if (osArch.matches(&quot;^(sparcv9|sparc64)$&quot;)) {</span>
<span class="nc" id="L190">      return &quot;sparc_64&quot;;</span>
    }
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">    if (osArch.matches(&quot;^(arm|arm32)$&quot;)) {</span>
<span class="nc" id="L193">      return &quot;arm_32&quot;;</span>
    }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">    if (&quot;aarch64&quot;.equals(osArch)) {</span>
<span class="fc" id="L196">      return &quot;aarch_64&quot;;</span>
    }
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (osArch.matches(&quot;^(mips|mips32)$&quot;)) {</span>
<span class="nc" id="L199">      return &quot;mips_32&quot;;</span>
    }
<span class="nc bnc" id="L201" title="All 2 branches missed.">    if (osArch.matches(&quot;^(mipsel|mips32el)$&quot;)) {</span>
<span class="nc" id="L202">      return &quot;mipsel_32&quot;;</span>
    }
<span class="nc bnc" id="L204" title="All 2 branches missed.">    if (&quot;mips64&quot;.equals(osArch)) {</span>
<span class="nc" id="L205">      return &quot;mips_64&quot;;</span>
    }
<span class="nc bnc" id="L207" title="All 2 branches missed.">    if (&quot;mips64el&quot;.equals(osArch)) {</span>
<span class="nc" id="L208">      return &quot;mipsel_64&quot;;</span>
    }
<span class="nc bnc" id="L210" title="All 2 branches missed.">    if (osArch.matches(&quot;^(ppc|ppc32)$&quot;)) {</span>
<span class="nc" id="L211">      return &quot;ppc_32&quot;;</span>
    }
<span class="nc bnc" id="L213" title="All 2 branches missed.">    if (osArch.matches(&quot;^(ppcle|ppc32le)$&quot;)) {</span>
<span class="nc" id="L214">      return &quot;ppcle_32&quot;;</span>
    }
<span class="nc bnc" id="L216" title="All 2 branches missed.">    if (&quot;ppc64&quot;.equals(osArch)) {</span>
<span class="nc" id="L217">      return &quot;ppc_64&quot;;</span>
    }
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (&quot;ppc64le&quot;.equals(osArch)) {</span>
<span class="nc" id="L220">      return &quot;ppcle_64&quot;;</span>
    }
<span class="nc bnc" id="L222" title="All 2 branches missed.">    if (&quot;s390&quot;.equals(osArch)) {</span>
<span class="nc" id="L223">      return &quot;s390_32&quot;;</span>
    }
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (&quot;s390x&quot;.equals(osArch)) {</span>
<span class="nc" id="L226">      return &quot;s390_64&quot;;</span>
    }

<span class="nc" id="L229">    return UNKNOWN;</span>
  }

  /**
   * Normalize VM version string.
   *
   * @param javaVendor the java vendor
   * @param javaVmName the java vm name
   * @return the string
   */
  static String normalizeVM(final String javaVendor, final String javaVmName) {
<span class="pc bpc" id="L240" title="2 of 4 branches missed.">    if (javaVmName.contains(&quot;graalvm&quot;) || javaVendor.contains(&quot;graalvm&quot;)) {</span>
<span class="nc" id="L241">      return &quot;graalvm&quot;;</span>
    }
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">    if (javaVendor.contains(&quot;oracle&quot;)) {</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">      if (javaVmName.contains(&quot;openjdk&quot;)) {</span>
<span class="nc" id="L245">        return &quot;oracle_openjdk&quot;;</span>
      } else {
<span class="nc" id="L247">        return &quot;oracle&quot;;</span>
      }
    }
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">    if (javaVendor.contains(&quot;adoptopenjdk&quot;)) {</span>
<span class="nc" id="L251">      return &quot;adoptopenjdk&quot;;</span>
    }
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">    if (javaVendor.contains(&quot;openj9&quot;)) {</span>
<span class="nc" id="L254">      return &quot;openj9&quot;;</span>
    }
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">    if (javaVendor.contains(&quot;azul&quot;)) {</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">      if (javaVmName.contains(&quot;zing&quot;)) {</span>
<span class="nc" id="L258">        return &quot;zing&quot;;</span>
      } else {
<span class="nc" id="L260">        return &quot;zulu&quot;;</span>
      }
    }
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">    if (javaVendor.contains(&quot;amazoncominc&quot;)) {</span>
<span class="nc" id="L264">      return &quot;corretto&quot;;</span>
    }
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">    if (javaVmName.contains(&quot;openjdk&quot;)) {</span>
<span class="fc" id="L267">      return &quot;openjdk&quot;;</span>
    }

<span class="nc" id="L270">    return &quot;-&quot; + javaVendor + &quot;-&quot; + javaVmName;</span>
  }

  /**
   * Normalize java version string.
   *
   * @param javaVersion the java version
   * @return the string
   */
  static String normalizeJavaVersion(final String javaVersion) {
    // These are already normalized.
<span class="fc" id="L281">    return System.getProperty(javaVersion);</span>
  }

  private static String normalize(final String value) {
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L286">      return &quot;&quot;;</span>
    }
<span class="fc" id="L288">    return System.getProperty(value).toLowerCase(Locale.US).replaceAll(&quot;[^a-z0-9]+&quot;, &quot;&quot;);</span>
  }

  private static void detectGlibc() {
<span class="nc" id="L292">    final ProcessBuilder processBuilder =</span>
<span class="nc" id="L293">        new ProcessBuilder(&quot;/bin/bash&quot;).command(&quot;/usr/bin/ldd&quot;, &quot;--version&quot;);</span>
<span class="nc" id="L294">    processBuilder.redirectErrorStream(true);</span>

    final StringBuilder rawGlibcVersionBuilder;
    try {
<span class="nc" id="L298">      final Process process = processBuilder.start();</span>
<span class="nc" id="L299">      rawGlibcVersionBuilder = readGlibcVersionStream(process.getInputStream());</span>
<span class="nc" id="L300">    } catch (IOException e) {</span>
<span class="nc" id="L301">      return;</span>
<span class="nc" id="L302">    }</span>

<span class="nc" id="L304">    _glibc = normalizeGLibcVersion(rawGlibcVersionBuilder.toString());</span>
<span class="nc" id="L305">  }</span>

  private static StringBuilder readGlibcVersionStream(final InputStream iStream)
      throws IOException {
<span class="nc" id="L309">    final StringBuilder builder = new StringBuilder();</span>
    String line;

<span class="nc" id="L312">    try (BufferedReader bufferedReader =</span>
<span class="nc" id="L313">        new BufferedReader(new InputStreamReader(iStream, Charset.defaultCharset()))) {</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">      while ((line = bufferedReader.readLine()) != null) {</span>
<span class="nc" id="L315">        builder.append(line);</span>
<span class="nc" id="L316">        builder.append(System.getProperty(&quot;line.separator&quot;));</span>
      }
    }

<span class="nc" id="L320">    return builder;</span>
  }

  private static String normalizeGLibcVersion(final String rawGlibcVersion) {
<span class="nc" id="L324">    final Pattern pattern = Pattern.compile(&quot;[-+]?[0-9]*\\.?[0-9]+&quot;);</span>
<span class="nc" id="L325">    final Matcher matcher = pattern.matcher(rawGlibcVersion);</span>

<span class="nc bnc" id="L327" title="All 2 branches missed.">    return matcher.find() ? matcher.group() : null;</span>
  }

  private static void detectJemalloc() {
    interface JemallocLib extends Library {
      int mallctl(
          String property,
          PointerByReference value,
          IntByReference len,
          String newValue,
          int newLen);
    }

<span class="nc" id="L340">    final JemallocLib jemallocLib = Native.load(&quot;jemalloc&quot;, JemallocLib.class);</span>

<span class="nc" id="L342">    PointerByReference pVersion = new PointerByReference();</span>
<span class="nc" id="L343">    IntByReference pSize = new IntByReference(Native.POINTER_SIZE);</span>
<span class="nc" id="L344">    jemallocLib.mallctl(&quot;version&quot;, pVersion, pSize, null, 0);</span>

<span class="nc" id="L346">    _jemalloc = pVersion.getValue().getString(0);</span>
<span class="nc" id="L347">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>