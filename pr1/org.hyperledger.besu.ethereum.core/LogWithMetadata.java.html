<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogWithMetadata.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.core</a> &gt; <span class="el_source">LogWithMetadata.java</span></div><h1>LogWithMetadata.java</h1><pre class="source lang-java linenums">/*
 *
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 */
package org.hyperledger.besu.ethereum.core;

import org.hyperledger.besu.datatypes.Address;
import org.hyperledger.besu.datatypes.Hash;
import org.hyperledger.besu.ethereum.privacy.PrivateTransactionReceipt;
import org.hyperledger.besu.evm.log.Log;
import org.hyperledger.besu.evm.log.LogTopic;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import com.google.common.base.MoreObjects;
import org.apache.tuweni.bytes.Bytes;

public class LogWithMetadata extends Log
    implements org.hyperledger.besu.plugin.data.LogWithMetadata {

  private final int logIndex;
  private final long blockNumber;
  private final Hash blockHash;
  private final Hash transactionHash;
  private final int transactionIndex;
  private final boolean removed;

  public LogWithMetadata(
      final int logIndex,
      final long blockNumber,
      final Hash blockHash,
      final Hash transactionHash,
      final int transactionIndex,
      final Address address,
      final Bytes data,
      final List&lt;LogTopic&gt; topics,
      final boolean removed) {
<span class="fc" id="L52">    super(address, data, topics);</span>
<span class="fc" id="L53">    this.logIndex = logIndex;</span>
<span class="fc" id="L54">    this.blockNumber = blockNumber;</span>
<span class="fc" id="L55">    this.blockHash = blockHash;</span>
<span class="fc" id="L56">    this.transactionHash = transactionHash;</span>
<span class="fc" id="L57">    this.transactionIndex = transactionIndex;</span>
<span class="fc" id="L58">    this.removed = removed;</span>
<span class="fc" id="L59">  }</span>

  public static List&lt;LogWithMetadata&gt; generate(
      final int logIndexOffset,
      final TransactionReceipt receipt,
      final long number,
      final Hash blockHash,
      final Hash transactionHash,
      final int transactionIndex,
      final boolean removed) {
<span class="fc" id="L69">    return generate(</span>
        logIndexOffset,
<span class="fc" id="L71">        receipt.getLogsList(),</span>
        number,
        blockHash,
        transactionHash,
        transactionIndex,
        removed);
  }

  public static List&lt;LogWithMetadata&gt; generate(
      final Block block, final List&lt;TransactionReceipt&gt; receipts, final boolean removed) {
<span class="fc" id="L81">    final List&lt;LogWithMetadata&gt; logsWithMetadata = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L82">    int logIndexOffset = 0;</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">    for (int txi = 0; txi &lt; receipts.size(); ++txi) {</span>
<span class="fc" id="L84">      final List&lt;LogWithMetadata&gt; logs =</span>
<span class="fc" id="L85">          generate(</span>
              logIndexOffset,
<span class="fc" id="L87">              receipts.get(txi),</span>
<span class="fc" id="L88">              block.getHeader().getNumber(),</span>
<span class="fc" id="L89">              block.getHash(),</span>
<span class="fc" id="L90">              block.getBody().getTransactions().get(txi).getHash(),</span>
              txi,
              removed);
<span class="fc" id="L93">      logIndexOffset += logs.size();</span>
<span class="fc" id="L94">      logsWithMetadata.addAll(logs);</span>
    }
<span class="fc" id="L96">    return logsWithMetadata;</span>
  }

  public static List&lt;LogWithMetadata&gt; generate(
      final int logIndexOffset,
      final PrivateTransactionReceipt receipt,
      final long number,
      final Hash blockHash,
      final Hash transactionHash,
      final int transactionIndex,
      final boolean removed) {
<span class="fc" id="L107">    return generate(</span>
        logIndexOffset,
<span class="fc" id="L109">        receipt.getLogs(),</span>
        number,
        blockHash,
        transactionHash,
        transactionIndex,
        removed);
  }

  private static List&lt;LogWithMetadata&gt; generate(
      final int logIndexOffset,
      final List&lt;Log&gt; receiptLogs,
      final long number,
      final Hash blockHash,
      final Hash transactionHash,
      final int transactionIndex,
      final boolean removed) {

<span class="fc" id="L126">    final List&lt;LogWithMetadata&gt; logs = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">    for (int logIndex = 0; logIndex &lt; receiptLogs.size(); ++logIndex) {</span>
<span class="fc" id="L128">      logs.add(</span>
          new LogWithMetadata(
              logIndexOffset + logIndex,
              number,
              blockHash,
              transactionHash,
              transactionIndex,
<span class="fc" id="L135">              receiptLogs.get(logIndex).getLogger(),</span>
<span class="fc" id="L136">              receiptLogs.get(logIndex).getData(),</span>
<span class="fc" id="L137">              receiptLogs.get(logIndex).getTopics(),</span>
              removed));
    }

<span class="fc" id="L141">    return logs;</span>
  }

  // The index of this log within the entire ordered list of logs associated with the block this log
  // belongs to.
  @Override
  public int getLogIndex() {
<span class="fc" id="L148">    return logIndex;</span>
  }

  @Override
  public long getBlockNumber() {
<span class="fc" id="L153">    return blockNumber;</span>
  }

  @Override
  public Hash getBlockHash() {
<span class="fc" id="L158">    return blockHash;</span>
  }

  @Override
  public Hash getTransactionHash() {
<span class="fc" id="L163">    return transactionHash;</span>
  }

  @Override
  public int getTransactionIndex() {
<span class="fc" id="L168">    return transactionIndex;</span>
  }

  @Override
  public boolean isRemoved() {
<span class="fc" id="L173">    return removed;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L178">    return MoreObjects.toStringHelper(this)</span>
<span class="nc" id="L179">        .add(&quot;logIndex&quot;, logIndex)</span>
<span class="nc" id="L180">        .add(&quot;blockNumber&quot;, blockNumber)</span>
<span class="nc" id="L181">        .add(&quot;blockHash&quot;, blockHash)</span>
<span class="nc" id="L182">        .add(&quot;transactionHash&quot;, transactionHash)</span>
<span class="nc" id="L183">        .add(&quot;transactionIndex&quot;, transactionIndex)</span>
<span class="nc" id="L184">        .add(&quot;address&quot;, getLogger())</span>
<span class="nc" id="L185">        .add(&quot;data&quot;, getData())</span>
<span class="nc" id="L186">        .add(&quot;topics&quot;, getTopics())</span>
<span class="nc" id="L187">        .add(&quot;removed&quot;, removed)</span>
<span class="nc" id="L188">        .toString();</span>
  }

  public static LogWithMetadata fromPlugin(
      final org.hyperledger.besu.plugin.data.LogWithMetadata pluginObject) {
<span class="nc" id="L193">    return new LogWithMetadata(</span>
<span class="nc" id="L194">        pluginObject.getLogIndex(),</span>
<span class="nc" id="L195">        pluginObject.getBlockNumber(),</span>
<span class="nc" id="L196">        pluginObject.getBlockHash(),</span>
<span class="nc" id="L197">        pluginObject.getTransactionHash(),</span>
<span class="nc" id="L198">        pluginObject.getTransactionIndex(),</span>
<span class="nc" id="L199">        pluginObject.getLogger(),</span>
<span class="nc" id="L200">        pluginObject.getData(),</span>
<span class="nc" id="L201">        pluginObject.getTopics().stream().map(LogTopic::create).collect(Collectors.toList()),</span>
<span class="nc" id="L202">        pluginObject.isRemoved());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>