<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FlatTrace.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.flat</a> &gt; <span class="el_source">FlatTrace.java</span></div><h1>FlatTrace.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.flat;

import static com.fasterxml.jackson.annotation.JsonInclude.Include.NON_NULL;

import org.hyperledger.besu.ethereum.api.jsonrpc.internal.processor.TransactionTrace;
import org.hyperledger.besu.ethereum.api.jsonrpc.internal.results.tracing.Trace;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicReference;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonPropertyOrder;

@JsonPropertyOrder({
  &quot;action&quot;,
  &quot;blockHash&quot;,
  &quot;blockNumber&quot;,
  &quot;result&quot;,
  &quot;error&quot;,
  &quot;revertReason&quot;,
  &quot;subtraces&quot;,
  &quot;traceAddress&quot;,
  &quot;transactionHash&quot;,
  &quot;transactionPosition&quot;,
  &quot;type&quot;
})
public class FlatTrace implements Trace {
  private final Action action;
  private final Result result;
  private final Long blockNumber;
  private final String blockHash;
  private final Integer transactionPosition;
  private final String transactionHash;
  private final Optional&lt;String&gt; error;
  private final String revertReason;
  private final int subtraces;
  private final List&lt;Integer&gt; traceAddress;
  private final String type;

  protected FlatTrace(
      final Action.Builder actionBuilder,
      final Result.Builder resultBuilder,
      final int subtraces,
      final List&lt;Integer&gt; traceAddress,
      final String type,
      final Long blockNumber,
      final String blockHash,
      final Integer transactionPosition,
      final String transactionHash,
      final Optional&lt;String&gt; error) {
<span class="fc" id="L67">    this(</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        actionBuilder != null ? actionBuilder.build() : null,</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        resultBuilder != null ? resultBuilder.build() : null,</span>
        subtraces,
        traceAddress,
        type,
        blockNumber,
        blockHash,
        transactionPosition,
        transactionHash,
        error,
        null);
<span class="fc" id="L79">  }</span>

  protected FlatTrace(
      final Action.Builder actionBuilder,
      final Result.Builder resultBuilder,
      final int subtraces,
      final List&lt;Integer&gt; traceAddress,
      final String type,
      final Long blockNumber,
      final String blockHash,
      final Integer transactionPosition,
      final String transactionHash,
      final Optional&lt;String&gt; error,
      final String revertReason) {
<span class="fc" id="L93">    this(</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        actionBuilder != null ? actionBuilder.build() : null,</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        resultBuilder != null ? resultBuilder.build() : null,</span>
        subtraces,
        traceAddress,
        type,
        blockNumber,
        blockHash,
        transactionPosition,
        transactionHash,
        error,
        revertReason);
<span class="fc" id="L105">  }</span>

  protected FlatTrace(
      final Action action,
      final Result result,
      final int subtraces,
      final List&lt;Integer&gt; traceAddress,
      final String type,
      final Long blockNumber,
      final String blockHash,
      final Integer transactionPosition,
      final String transactionHash,
      final Optional&lt;String&gt; error,
<span class="fc" id="L118">      final String revertReason) {</span>
<span class="fc" id="L119">    this.action = action;</span>
<span class="fc" id="L120">    this.result = result;</span>
<span class="fc" id="L121">    this.subtraces = subtraces;</span>
<span class="fc" id="L122">    this.traceAddress = traceAddress;</span>
<span class="fc" id="L123">    this.type = type;</span>
<span class="fc" id="L124">    this.blockNumber = blockNumber;</span>
<span class="fc" id="L125">    this.blockHash = blockHash;</span>
<span class="fc" id="L126">    this.transactionPosition = transactionPosition;</span>
<span class="fc" id="L127">    this.transactionHash = transactionHash;</span>
<span class="fc" id="L128">    this.error = error;</span>
<span class="fc" id="L129">    this.revertReason = revertReason;</span>
<span class="fc" id="L130">  }</span>

  static Builder freshBuilder(final TransactionTrace transactionTrace) {
<span class="fc" id="L133">    return FlatTrace.builder()</span>
<span class="fc" id="L134">        .resultBuilder(Result.builder())</span>
<span class="fc" id="L135">        .actionBuilder(Action.Builder.from(transactionTrace));</span>
  }

  public Action getAction() {
<span class="fc" id="L139">    return action;</span>
  }

  @JsonInclude(NON_NULL)
  public Long getBlockNumber() {
<span class="fc" id="L144">    return blockNumber;</span>
  }

  @JsonInclude(NON_NULL)
  public String getBlockHash() {
<span class="fc" id="L149">    return blockHash;</span>
  }

  @JsonInclude(NON_NULL)
  public String getTransactionHash() {
<span class="fc" id="L154">    return transactionHash;</span>
  }

  @JsonInclude(NON_NULL)
  public Integer getTransactionPosition() {
<span class="fc" id="L159">    return transactionPosition;</span>
  }

  @JsonInclude(NON_NULL)
  public String getError() {
<span class="fc" id="L164">    return error.orElse(null);</span>
  }

  @JsonInclude(NON_NULL)
  public String getRevertReason() {
<span class="fc" id="L169">    return revertReason;</span>
  }

  /**
   * This ridiculous construction returns a true &quot;null&quot; when we have a value in error, resulting in
   * jackson not serializing it, or a wrapped reference of either null or the value, resulting in
   * jackson serializing a null if we don't have an error.
   *
   * &lt;p&gt;This is done for binary compatibility: we need either an absent value, a present null value,
   * or a real value. And since Java Optionals refuse to hold nulls (by design) an atomic reference
   * is used instead.
   *
   * @return the jackson optimized result
   */
  @JsonInclude(NON_NULL)
  public AtomicReference&lt;Result&gt; getResult() {
<span class="fc bfc" id="L185" title="All 2 branches covered.">    return (error.isPresent()) ? null : new AtomicReference&lt;&gt;(result);</span>
  }

  public int getSubtraces() {
<span class="fc" id="L189">    return subtraces;</span>
  }

  public List&lt;Integer&gt; getTraceAddress() {
<span class="fc" id="L193">    return traceAddress;</span>
  }

  public String getType() {
<span class="fc" id="L197">    return type;</span>
  }

  public static Builder builder() {
<span class="fc" id="L201">    return new Builder();</span>
  }

  public static class Context {

    private final Builder builder;
<span class="fc" id="L207">    private long gasUsed = 0;</span>
    private boolean createOp;

<span class="fc" id="L210">    Context(final Builder builder) {</span>
<span class="fc" id="L211">      this.builder = builder;</span>
<span class="fc" id="L212">    }</span>

    public Builder getBuilder() {
<span class="fc" id="L215">      return builder;</span>
    }

    void incGasUsed(final long gas) {
<span class="fc" id="L219">      setGasUsed(gasUsed + gas);</span>
<span class="fc" id="L220">    }</span>

    void decGasUsed(final long gas) {
<span class="fc" id="L223">      setGasUsed(gasUsed - gas);</span>
<span class="fc" id="L224">    }</span>

    public long getGasUsed() {
<span class="nc" id="L227">      return gasUsed;</span>
    }

    public void setGasUsed(final long gasUsed) {
<span class="fc" id="L231">      this.gasUsed = gasUsed;</span>
<span class="fc" id="L232">      builder.getResultBuilder().gasUsed(&quot;0x&quot; + Long.toHexString(gasUsed));</span>
<span class="fc" id="L233">    }</span>

    boolean isCreateOp() {
<span class="fc" id="L236">      return createOp;</span>
    }

    void setCreateOp(final boolean createOp) {
<span class="fc" id="L240">      this.createOp = createOp;</span>
<span class="fc" id="L241">    }</span>
  }

  public static class Builder {

    private Action.Builder actionBuilder;
    private Result.Builder resultBuilder;
    private int subtraces;
<span class="fc" id="L249">    private List&lt;Integer&gt; traceAddress = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L250">    private String type = &quot;call&quot;;</span>
    private Long blockNumber;
    private String blockHash;
    private String transactionHash;
    private Integer transactionPosition;
<span class="fc" id="L255">    private Optional&lt;String&gt; error = Optional.empty();</span>
    private String revertReason;

<span class="fc" id="L258">    protected Builder() {}</span>

    Builder resultBuilder(final Result.Builder resultBuilder) {
<span class="fc" id="L261">      this.resultBuilder = resultBuilder;</span>
<span class="fc" id="L262">      return this;</span>
    }

    Builder actionBuilder(final Action.Builder actionBuilder) {
<span class="fc" id="L266">      this.actionBuilder = actionBuilder;</span>
<span class="fc" id="L267">      return this;</span>
    }

    public Builder traceAddress(final List&lt;Integer&gt; traceAddress) {
<span class="fc" id="L271">      this.traceAddress = traceAddress;</span>
<span class="fc" id="L272">      return this;</span>
    }

    public Builder type(final String type) {
<span class="fc" id="L276">      this.type = type;</span>
<span class="fc" id="L277">      return this;</span>
    }

    public Builder blockNumber(final Long blockNumber) {
<span class="fc" id="L281">      this.blockNumber = blockNumber;</span>
<span class="fc" id="L282">      return this;</span>
    }

    public Builder blockHash(final String blockHash) {
<span class="fc" id="L286">      this.blockHash = blockHash;</span>
<span class="fc" id="L287">      return this;</span>
    }

    public Builder transactionHash(final String transactionHash) {
<span class="fc" id="L291">      this.transactionHash = transactionHash;</span>
<span class="fc" id="L292">      return this;</span>
    }

    public Builder transactionPosition(final Integer transactionPosition) {
<span class="fc" id="L296">      this.transactionPosition = transactionPosition;</span>
<span class="fc" id="L297">      return this;</span>
    }

    public Builder error(final Optional&lt;String&gt; error) {
<span class="fc" id="L301">      this.error = error;</span>
<span class="fc" id="L302">      return this;</span>
    }

    public Builder revertReason(final String revertReason) {
<span class="fc" id="L306">      this.revertReason = revertReason;</span>
<span class="fc" id="L307">      return this;</span>
    }

    public String getType() {
<span class="fc" id="L311">      return type;</span>
    }

    public int getSubtraces() {
<span class="fc" id="L315">      return subtraces;</span>
    }

    public List&lt;Integer&gt; getTraceAddress() {
<span class="fc" id="L319">      return traceAddress;</span>
    }

    public Long getBlockNumber() {
<span class="fc" id="L323">      return blockNumber;</span>
    }

    public String getBlockHash() {
<span class="fc" id="L327">      return blockHash;</span>
    }

    public String getTransactionHash() {
<span class="fc" id="L331">      return transactionHash;</span>
    }

    public Integer getTransactionPosition() {
<span class="fc" id="L335">      return transactionPosition;</span>
    }

    public Optional&lt;String&gt; getError() {
<span class="fc" id="L339">      return error;</span>
    }

    public String getRevertReason() {
<span class="nc" id="L343">      return revertReason;</span>
    }

    void incSubTraces() {
<span class="fc" id="L347">      this.subtraces++;</span>
<span class="fc" id="L348">    }</span>

    public FlatTrace build() {
<span class="fc" id="L351">      return new FlatTrace(</span>
          actionBuilder,
          resultBuilder,
          subtraces,
          traceAddress,
          type,
          blockNumber,
          blockHash,
          transactionPosition,
          transactionHash,
          error,
          revertReason);
    }

    public Result.Builder getResultBuilder() {
<span class="fc" id="L366">      return resultBuilder;</span>
    }

    public Action.Builder getActionBuilder() {
<span class="fc" id="L370">      return actionBuilder;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>