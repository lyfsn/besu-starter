<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BesuUpnpServiceConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.nat.upnp</a> &gt; <span class="el_source">BesuUpnpServiceConfiguration.java</span></div><h1>BesuUpnpServiceConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.nat.upnp;

import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.Executor;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

import org.jupnp.DefaultUpnpServiceConfiguration;
import org.jupnp.UpnpServiceConfiguration;
import org.jupnp.binding.xml.DeviceDescriptorBinder;
import org.jupnp.binding.xml.ServiceDescriptorBinder;
import org.jupnp.binding.xml.UDA10DeviceDescriptorBinderImpl;
import org.jupnp.binding.xml.UDA10ServiceDescriptorBinderImpl;
import org.jupnp.model.Namespace;
import org.jupnp.model.message.UpnpHeaders;
import org.jupnp.model.meta.RemoteDeviceIdentity;
import org.jupnp.model.meta.RemoteService;
import org.jupnp.model.types.ServiceType;
import org.jupnp.transport.impl.DatagramIOConfigurationImpl;
import org.jupnp.transport.impl.DatagramIOImpl;
import org.jupnp.transport.impl.DatagramProcessorImpl;
import org.jupnp.transport.impl.GENAEventProcessorImpl;
import org.jupnp.transport.impl.MulticastReceiverConfigurationImpl;
import org.jupnp.transport.impl.MulticastReceiverImpl;
import org.jupnp.transport.impl.NetworkAddressFactoryImpl;
import org.jupnp.transport.impl.SOAPActionProcessorImpl;
import org.jupnp.transport.impl.jetty.StreamClientConfigurationImpl;
import org.jupnp.transport.spi.DatagramIO;
import org.jupnp.transport.spi.DatagramProcessor;
import org.jupnp.transport.spi.GENAEventProcessor;
import org.jupnp.transport.spi.MulticastReceiver;
import org.jupnp.transport.spi.NetworkAddressFactory;
import org.jupnp.transport.spi.SOAPActionProcessor;
import org.jupnp.transport.spi.StreamClient;
import org.jupnp.transport.spi.StreamServer;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

class BesuUpnpServiceConfiguration implements UpnpServiceConfiguration {
<span class="fc" id="L55">  private static final Logger LOG = LoggerFactory.getLogger(BesuUpnpServiceConfiguration.class);</span>

  private final ThreadPoolExecutor executorService;
  private final DeviceDescriptorBinder deviceDescriptorBinderUDA10;
  private final ServiceDescriptorBinder serviceDescriptorBinderUDA10;
  private final int streamListenPort;
  private final int multicastResponsePort;
  private final Namespace namespace;

  BesuUpnpServiceConfiguration() {
<span class="fc" id="L65">    this(</span>
        NetworkAddressFactoryImpl.DEFAULT_TCP_HTTP_LISTEN_PORT,
        NetworkAddressFactoryImpl.DEFAULT_MULTICAST_RESPONSE_LISTEN_PORT);
<span class="fc" id="L68">  }</span>

  private BesuUpnpServiceConfiguration(
<span class="fc" id="L71">      final int streamListenPort, final int multicastResponsePort) {</span>
<span class="fc" id="L72">    executorService =</span>
        new ThreadPoolExecutor(
            16,
            200,
            10,
            TimeUnit.SECONDS,
            new ArrayBlockingQueue&lt;&gt;(2000),
            new DefaultUpnpServiceConfiguration.JUPnPThreadFactory(),
<span class="fc" id="L80">            new ThreadPoolExecutor.DiscardPolicy() {</span>
              // The pool is bounded and rejections will happen during shutdown
              @Override
              public void rejectedExecution(
                  final Runnable runnable, final ThreadPoolExecutor threadPoolExecutor) {
                // Log and discard
<span class="nc" id="L86">                LOG.warn(&quot;Thread pool rejected execution of &quot; + runnable.getClass());</span>
<span class="nc" id="L87">                super.rejectedExecution(runnable, threadPoolExecutor);</span>
<span class="nc" id="L88">              }</span>
            });
<span class="fc" id="L90">    executorService.allowCoreThreadTimeOut(true);</span>

<span class="fc" id="L92">    deviceDescriptorBinderUDA10 = new UDA10DeviceDescriptorBinderImpl();</span>
<span class="fc" id="L93">    serviceDescriptorBinderUDA10 = new UDA10ServiceDescriptorBinderImpl();</span>
<span class="fc" id="L94">    namespace = new Namespace();</span>

<span class="fc" id="L96">    this.streamListenPort = streamListenPort;</span>
<span class="fc" id="L97">    this.multicastResponsePort = multicastResponsePort;</span>
<span class="fc" id="L98">  }</span>

  @Override
  public NetworkAddressFactory createNetworkAddressFactory() {
<span class="nc" id="L102">    return new NetworkAddressFactoryImpl(streamListenPort, multicastResponsePort);</span>
  }

  @Override
  public DatagramProcessor getDatagramProcessor() {
<span class="nc" id="L107">    return new DatagramProcessorImpl();</span>
  }

  @Override
  public SOAPActionProcessor getSoapActionProcessor() {
<span class="nc" id="L112">    return new SOAPActionProcessorImpl();</span>
  }

  @Override
  public GENAEventProcessor getGenaEventProcessor() {
<span class="nc" id="L117">    return new GENAEventProcessorImpl();</span>
  }

  @SuppressWarnings(&quot;rawtypes&quot;) // superclass uses raw types
  @Override
  public StreamClient createStreamClient() {
<span class="nc" id="L123">    return new OkHttpStreamClient(new StreamClientConfigurationImpl(executorService));</span>
  }

  @SuppressWarnings(&quot;rawtypes&quot;) // superclass uses raw types
  @Override
  public MulticastReceiver createMulticastReceiver(
      final NetworkAddressFactory networkAddressFactory) {
<span class="nc" id="L130">    return new MulticastReceiverImpl(</span>
        new MulticastReceiverConfigurationImpl(
<span class="nc" id="L132">            networkAddressFactory.getMulticastGroup(), networkAddressFactory.getMulticastPort()));</span>
  }

  @SuppressWarnings(&quot;rawtypes&quot;) // superclass uses raw types
  @Override
  public DatagramIO createDatagramIO(final NetworkAddressFactory networkAddressFactory) {
<span class="nc" id="L138">    return new DatagramIOImpl(new DatagramIOConfigurationImpl());</span>
  }

  @SuppressWarnings(&quot;rawtypes&quot;) // superclass uses raw types
  @Override
  public StreamServer createStreamServer(final NetworkAddressFactory networkAddressFactory) {
<span class="nc" id="L144">    return null;</span>
  }

  @Override
  public Executor getMulticastReceiverExecutor() {
<span class="nc" id="L149">    return executorService;</span>
  }

  @Override
  public Executor getDatagramIOExecutor() {
<span class="nc" id="L154">    return executorService;</span>
  }

  @Override
  public ExecutorService getStreamServerExecutorService() {
<span class="nc" id="L159">    return executorService;</span>
  }

  @Override
  public DeviceDescriptorBinder getDeviceDescriptorBinderUDA10() {
<span class="nc" id="L164">    return deviceDescriptorBinderUDA10;</span>
  }

  @Override
  public ServiceDescriptorBinder getServiceDescriptorBinderUDA10() {
<span class="nc" id="L169">    return serviceDescriptorBinderUDA10;</span>
  }

  @Override
  public ServiceType[] getExclusiveServiceTypes() {
<span class="nc" id="L174">    return new ServiceType[0];</span>
  }

  @Override
  public int getRegistryMaintenanceIntervalMillis() {
<span class="nc" id="L179">    return 1000;</span>
  }

  @Override
  public int getAliveIntervalMillis() {
<span class="nc" id="L184">    return 0;</span>
  }

  @Override
  public boolean isReceivedSubscriptionTimeoutIgnored() {
<span class="nc" id="L189">    return false;</span>
  }

  @Override
  public Integer getRemoteDeviceMaxAgeSeconds() {
<span class="nc" id="L194">    return null;</span>
  }

  @Override
  public UpnpHeaders getDescriptorRetrievalHeaders(final RemoteDeviceIdentity identity) {
<span class="nc" id="L199">    return null;</span>
  }

  @Override
  public UpnpHeaders getEventSubscriptionHeaders(final RemoteService service) {
<span class="nc" id="L204">    return null;</span>
  }

  @Override
  public Executor getAsyncProtocolExecutor() {
<span class="nc" id="L209">    return executorService;</span>
  }

  @Override
  public ExecutorService getSyncProtocolExecutorService() {
<span class="nc" id="L214">    return executorService;</span>
  }

  @Override
  public Namespace getNamespace() {
<span class="nc" id="L219">    return namespace;</span>
  }

  @Override
  public Executor getRegistryMaintainerExecutor() {
<span class="nc" id="L224">    return executorService;</span>
  }

  @Override
  public Executor getRegistryListenerExecutor() {
<span class="nc" id="L229">    return executorService;</span>
  }

  @Override
  public Executor getRemoteListenerExecutor() {
<span class="nc" id="L234">    return executorService;</span>
  }

  @Override
  public void shutdown() {
<span class="nc" id="L239">    executorService.shutdown();</span>
<span class="nc" id="L240">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>