<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClassicProtocolSpecs.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.mainnet</a> &gt; <span class="el_source">ClassicProtocolSpecs.java</span></div><h1>ClassicProtocolSpecs.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.mainnet;

import static org.hyperledger.besu.ethereum.mainnet.MainnetProtocolSpecs.powHasher;

import org.hyperledger.besu.config.PowAlgorithm;
import org.hyperledger.besu.datatypes.TransactionType;
import org.hyperledger.besu.datatypes.Wei;
import org.hyperledger.besu.ethereum.core.TransactionReceipt;
import org.hyperledger.besu.ethereum.core.feemarket.CoinbaseFeePriceCalculator;
import org.hyperledger.besu.ethereum.processing.TransactionProcessingResult;
import org.hyperledger.besu.evm.ClassicEVMs;
import org.hyperledger.besu.evm.MainnetEVMs;
import org.hyperledger.besu.evm.contractvalidation.MaxCodeSizeRule;
import org.hyperledger.besu.evm.contractvalidation.PrefixCodeRule;
import org.hyperledger.besu.evm.frame.MessageFrame;
import org.hyperledger.besu.evm.gascalculator.BerlinGasCalculator;
import org.hyperledger.besu.evm.gascalculator.DieHardGasCalculator;
import org.hyperledger.besu.evm.gascalculator.IstanbulGasCalculator;
import org.hyperledger.besu.evm.gascalculator.LondonGasCalculator;
import org.hyperledger.besu.evm.gascalculator.PetersburgGasCalculator;
import org.hyperledger.besu.evm.gascalculator.ShanghaiGasCalculator;
import org.hyperledger.besu.evm.gascalculator.SpuriousDragonGasCalculator;
import org.hyperledger.besu.evm.gascalculator.TangerineWhistleGasCalculator;
import org.hyperledger.besu.evm.internal.EvmConfiguration;
import org.hyperledger.besu.evm.processor.ContractCreationProcessor;
import org.hyperledger.besu.evm.processor.MessageCallProcessor;
import org.hyperledger.besu.evm.worldstate.WorldState;

import java.math.BigInteger;
import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.OptionalLong;
import java.util.Set;

public class ClassicProtocolSpecs {
<span class="fc" id="L52">  private static final Wei MAX_BLOCK_REWARD = Wei.fromEth(5);</span>

  private ClassicProtocolSpecs() {
    // utility class
  }

  public static ProtocolSpecBuilder classicRecoveryInitDefinition(
      final OptionalInt contractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L62">    return MainnetProtocolSpecs.homesteadDefinition(</span>
            contractSizeLimit, configStackSizeLimit, evmConfiguration)
<span class="fc" id="L64">        .blockHeaderValidatorBuilder(</span>
<span class="fc" id="L65">            feeMarket -&gt; MainnetBlockHeaderValidator.createClassicValidator())</span>
<span class="fc" id="L66">        .name(&quot;ClassicRecoveryInit&quot;);</span>
  }

  public static ProtocolSpecBuilder tangerineWhistleDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt contractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L74">    return MainnetProtocolSpecs.homesteadDefinition(</span>
            contractSizeLimit, configStackSizeLimit, evmConfiguration)
<span class="fc" id="L76">        .isReplayProtectionSupported(true)</span>
<span class="fc" id="L77">        .gasCalculator(TangerineWhistleGasCalculator::new)</span>
<span class="fc" id="L78">        .transactionValidatorFactoryBuilder(</span>
            (gasCalculator, gasLimitCalculator, feeMarket) -&gt;
<span class="fc" id="L80">                new TransactionValidatorFactory(gasCalculator, gasLimitCalculator, true, chainId))</span>
<span class="fc" id="L81">        .name(&quot;ClassicTangerineWhistle&quot;);</span>
  }

  public static ProtocolSpecBuilder dieHardDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt ignoredConfigContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L89">    return tangerineWhistleDefinition(</span>
<span class="fc" id="L90">            chainId, OptionalInt.empty(), configStackSizeLimit, evmConfiguration)</span>
<span class="fc" id="L91">        .gasCalculator(DieHardGasCalculator::new)</span>
<span class="fc" id="L92">        .difficultyCalculator(ClassicDifficultyCalculators.DIFFICULTY_BOMB_PAUSED)</span>
<span class="fc" id="L93">        .name(&quot;DieHard&quot;);</span>
  }

  public static ProtocolSpecBuilder gothamDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt contractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L102">    return dieHardDefinition(chainId, contractSizeLimit, configStackSizeLimit, evmConfiguration)</span>
<span class="fc" id="L103">        .blockReward(MAX_BLOCK_REWARD)</span>
<span class="fc" id="L104">        .difficultyCalculator(ClassicDifficultyCalculators.DIFFICULTY_BOMB_DELAYED)</span>
<span class="fc" id="L105">        .blockProcessorBuilder(</span>
            (transactionProcessor,
                transactionReceiptFactory,
                blockReward,
                miningBeneficiaryCalculator,
                skipZeroBlockRewards,
                protocolSchedule) -&gt;
<span class="fc" id="L112">                new ClassicBlockProcessor(</span>
                    transactionProcessor,
                    transactionReceiptFactory,
                    blockReward,
                    miningBeneficiaryCalculator,
                    skipZeroBlockRewards,
                    ecip1017EraRounds,
                    protocolSchedule))
<span class="fc" id="L120">        .name(&quot;Gotham&quot;);</span>
  }

  public static ProtocolSpecBuilder defuseDifficultyBombDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt contractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L129">    return gothamDefinition(</span>
            chainId, contractSizeLimit, configStackSizeLimit, ecip1017EraRounds, evmConfiguration)
<span class="fc" id="L131">        .difficultyCalculator(ClassicDifficultyCalculators.DIFFICULTY_BOMB_REMOVED)</span>
<span class="fc" id="L132">        .transactionValidatorFactoryBuilder(</span>
            (gasCalculator, gasLimitCalculator, feeMarket) -&gt;
<span class="fc" id="L134">                new TransactionValidatorFactory(gasCalculator, gasLimitCalculator, true, chainId))</span>
<span class="fc" id="L135">        .name(&quot;DefuseDifficultyBomb&quot;);</span>
  }

  public static ProtocolSpecBuilder atlantisDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L145">    final int contractSizeLimit =</span>
<span class="fc" id="L146">        configContractSizeLimit.orElse(MainnetProtocolSpecs.SPURIOUS_DRAGON_CONTRACT_SIZE_LIMIT);</span>
<span class="fc" id="L147">    final int stackSizeLimit = configStackSizeLimit.orElse(MessageFrame.DEFAULT_MAX_STACK_SIZE);</span>
<span class="fc" id="L148">    return gothamDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            ecip1017EraRounds,
            evmConfiguration)
<span class="fc" id="L154">        .evmBuilder(MainnetEVMs::byzantium)</span>
<span class="fc" id="L155">        .evmConfiguration(evmConfiguration)</span>
<span class="fc" id="L156">        .gasCalculator(SpuriousDragonGasCalculator::new)</span>
<span class="fc" id="L157">        .skipZeroBlockRewards(true)</span>
<span class="fc" id="L158">        .messageCallProcessorBuilder(MessageCallProcessor::new)</span>
<span class="fc" id="L159">        .precompileContractRegistryBuilder(MainnetPrecompiledContractRegistries::byzantium)</span>
<span class="fc" id="L160">        .difficultyCalculator(ClassicDifficultyCalculators.EIP100)</span>
<span class="fc" id="L161">        .transactionReceiptFactory(</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">            enableRevertReason</span>
<span class="nc" id="L163">                ? ClassicProtocolSpecs::byzantiumTransactionReceiptFactoryWithReasonEnabled</span>
<span class="fc" id="L164">                : ClassicProtocolSpecs::byzantiumTransactionReceiptFactory)</span>
<span class="fc" id="L165">        .contractCreationProcessorBuilder(</span>
            (gasCalculator, evm) -&gt;
<span class="fc" id="L167">                new ContractCreationProcessor(</span>
                    gasCalculator,
                    evm,
                    true,
<span class="fc" id="L171">                    Collections.singletonList(MaxCodeSizeRule.of(contractSizeLimit)),</span>
                    1))
<span class="fc" id="L173">        .transactionProcessorBuilder(</span>
            (gasCalculator,
                feeMarket,
                transactionValidatorFactory,
                contractCreationProcessor,
                messageCallProcessor) -&gt;
<span class="fc" id="L179">                new MainnetTransactionProcessor(</span>
                    gasCalculator,
                    transactionValidatorFactory,
                    contractCreationProcessor,
                    messageCallProcessor,
                    true,
                    false,
                    stackSizeLimit,
                    feeMarket,
<span class="fc" id="L188">                    CoinbaseFeePriceCalculator.frontier()))</span>
<span class="fc" id="L189">        .name(&quot;Atlantis&quot;);</span>
  }

  public static ProtocolSpecBuilder aghartaDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L199">    return atlantisDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            enableRevertReason,
            ecip1017EraRounds,
            evmConfiguration)
<span class="fc" id="L206">        .evmBuilder(MainnetEVMs::constantinople)</span>
<span class="fc" id="L207">        .gasCalculator(PetersburgGasCalculator::new)</span>
<span class="fc" id="L208">        .evmBuilder(MainnetEVMs::constantinople)</span>
<span class="fc" id="L209">        .precompileContractRegistryBuilder(MainnetPrecompiledContractRegistries::istanbul)</span>
<span class="fc" id="L210">        .name(&quot;Agharta&quot;);</span>
  }

  public static ProtocolSpecBuilder phoenixDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L220">    return aghartaDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            enableRevertReason,
            ecip1017EraRounds,
            evmConfiguration)
<span class="fc" id="L227">        .gasCalculator(IstanbulGasCalculator::new)</span>
<span class="fc" id="L228">        .evmBuilder(</span>
            (gasCalculator, evmConfig) -&gt;
<span class="fc" id="L230">                MainnetEVMs.istanbul(</span>
<span class="fc" id="L231">                    gasCalculator, chainId.orElse(BigInteger.ZERO), evmConfiguration))</span>
<span class="fc" id="L232">        .precompileContractRegistryBuilder(MainnetPrecompiledContractRegistries::istanbul)</span>
<span class="fc" id="L233">        .name(&quot;Phoenix&quot;);</span>
  }

  public static ProtocolSpecBuilder thanosDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L243">    return phoenixDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            enableRevertReason,
            ecip1017EraRounds,
            evmConfiguration)
<span class="fc" id="L250">        .blockHeaderValidatorBuilder(</span>
            feeMarket -&gt;
<span class="fc" id="L252">                MainnetBlockHeaderValidator.createPgaBlockHeaderValidator(</span>
<span class="fc" id="L253">                    new EpochCalculator.Ecip1099EpochCalculator(), powHasher(PowAlgorithm.ETHASH)))</span>
<span class="fc" id="L254">        .ommerHeaderValidatorBuilder(</span>
            feeMarket -&gt;
<span class="fc" id="L256">                MainnetBlockHeaderValidator.createLegacyFeeMarketOmmerValidator(</span>
<span class="fc" id="L257">                    new EpochCalculator.Ecip1099EpochCalculator(), powHasher(PowAlgorithm.ETHASH)))</span>
<span class="fc" id="L258">        .name(&quot;Thanos&quot;);</span>
  }

  private static TransactionReceipt byzantiumTransactionReceiptFactory(
      // ignored because it's always FRONTIER for byzantium
      final TransactionType __,
      final TransactionProcessingResult result,
      final WorldState worldState,
      final long gasUsed) {
<span class="nc" id="L267">    return new TransactionReceipt(</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        result.isSuccessful() ? 1 : 0, gasUsed, result.getLogs(), Optional.empty());</span>
  }

  private static TransactionReceipt byzantiumTransactionReceiptFactoryWithReasonEnabled(
      // ignored because it's always FRONTIER for byzantium
      final TransactionType __,
      final TransactionProcessingResult result,
      final WorldState worldState,
      final long gasUsed) {
<span class="nc" id="L277">    return new TransactionReceipt(</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        result.isSuccessful() ? 1 : 0, gasUsed, result.getLogs(), result.getRevertReason());</span>
  }

  public static ProtocolSpecBuilder magnetoDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L288">    return thanosDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            enableRevertReason,
            ecip1017EraRounds,
            evmConfiguration)
<span class="fc" id="L295">        .gasCalculator(BerlinGasCalculator::new)</span>
<span class="fc" id="L296">        .transactionValidatorFactoryBuilder(</span>
            (gasCalculator, gasLimitCalculator, feeMarket) -&gt;
<span class="fc" id="L298">                new TransactionValidatorFactory(</span>
                    gasCalculator,
                    gasLimitCalculator,
                    true,
                    chainId,
<span class="fc" id="L303">                    Set.of(TransactionType.FRONTIER, TransactionType.ACCESS_LIST)))</span>
<span class="fc" id="L304">        .transactionReceiptFactory(</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">            enableRevertReason</span>
<span class="nc" id="L306">                ? MainnetProtocolSpecs::berlinTransactionReceiptFactoryWithReasonEnabled</span>
<span class="fc" id="L307">                : MainnetProtocolSpecs::berlinTransactionReceiptFactory)</span>
<span class="fc" id="L308">        .name(&quot;Magneto&quot;);</span>
  }

  public static ProtocolSpecBuilder mystiqueDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L318">    final int contractSizeLimit =</span>
<span class="fc" id="L319">        configContractSizeLimit.orElse(MainnetProtocolSpecs.SPURIOUS_DRAGON_CONTRACT_SIZE_LIMIT);</span>
<span class="fc" id="L320">    return magnetoDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            enableRevertReason,
            ecip1017EraRounds,
            evmConfiguration)
<span class="fc" id="L327">        .gasCalculator(LondonGasCalculator::new)</span>
<span class="fc" id="L328">        .contractCreationProcessorBuilder(</span>
            (gasCalculator, evm) -&gt;
<span class="fc" id="L330">                new ContractCreationProcessor(</span>
                    gasCalculator,
                    evm,
                    true,
<span class="fc" id="L334">                    List.of(MaxCodeSizeRule.of(contractSizeLimit), PrefixCodeRule.of()),</span>
                    1))
<span class="fc" id="L336">        .name(&quot;Mystique&quot;);</span>
  }

  public static ProtocolSpecBuilder spiralDefinition(
      final Optional&lt;BigInteger&gt; chainId,
      final OptionalInt configContractSizeLimit,
      final OptionalInt configStackSizeLimit,
      final boolean enableRevertReason,
      final OptionalLong ecip1017EraRounds,
      final EvmConfiguration evmConfiguration) {
<span class="fc" id="L346">    final int stackSizeLimit = configStackSizeLimit.orElse(MessageFrame.DEFAULT_MAX_STACK_SIZE);</span>
<span class="fc" id="L347">    return mystiqueDefinition(</span>
            chainId,
            configContractSizeLimit,
            configStackSizeLimit,
            enableRevertReason,
            ecip1017EraRounds,
            evmConfiguration)
        // EIP-3860
<span class="fc" id="L355">        .gasCalculator(ShanghaiGasCalculator::new)</span>
        // EIP-3855
<span class="fc" id="L357">        .evmBuilder(</span>
            (gasCalculator, jdCacheConfig) -&gt;
<span class="fc" id="L359">                ClassicEVMs.spiral(</span>
<span class="fc" id="L360">                    gasCalculator, chainId.orElse(BigInteger.ZERO), evmConfiguration))</span>
        // EIP-3651
<span class="fc" id="L362">        .transactionProcessorBuilder(</span>
            (gasCalculator,
                feeMarket,
                transactionValidatorFactory,
                contractCreationProcessor,
                messageCallProcessor) -&gt;
<span class="fc" id="L368">                new MainnetTransactionProcessor(</span>
                    gasCalculator,
                    transactionValidatorFactory,
                    contractCreationProcessor,
                    messageCallProcessor,
                    true,
                    true,
                    stackSizeLimit,
                    feeMarket,
<span class="fc" id="L377">                    CoinbaseFeePriceCalculator.frontier()))</span>
<span class="fc" id="L378">        .name(&quot;Spiral&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>