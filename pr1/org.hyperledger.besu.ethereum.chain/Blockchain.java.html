<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Blockchain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.ethereum.chain</a> &gt; <span class="el_source">Blockchain.java</span></div><h1>Blockchain.java</h1><pre class="source lang-java linenums">/*
 * Copyright Hyperledger Besu Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.ethereum.chain;

import org.hyperledger.besu.datatypes.Hash;
import org.hyperledger.besu.ethereum.core.Block;
import org.hyperledger.besu.ethereum.core.BlockBody;
import org.hyperledger.besu.ethereum.core.BlockHeader;
import org.hyperledger.besu.ethereum.core.Difficulty;
import org.hyperledger.besu.ethereum.core.LogWithMetadata;
import org.hyperledger.besu.ethereum.core.Transaction;
import org.hyperledger.besu.ethereum.core.TransactionReceipt;

import java.util.Comparator;
import java.util.List;
import java.util.Optional;
import java.util.function.Consumer;

/** An interface for reading data from the blockchain. */
public interface Blockchain {
  /**
   * Return the head (latest block hash and total difficulty) of the local canonical blockchain.
   *
   * @return The head of the blockchain.
   */
  ChainHead getChainHead();

  /**
   * Return the last finalized block hash if present.
   *
   * @return The hash of the last finalized block
   */
  Optional&lt;Hash&gt; getFinalized();

  /**
   * Return the last safe block hash if present.
   *
   * @return The hash of the last safe block
   */
  Optional&lt;Hash&gt; getSafeBlock();

  /**
   * Return the block number of the head of the canonical chain.
   *
   * @return The block number of the head of the chain.
   */
  long getChainHeadBlockNumber();

  /**
   * Return the hash of the head of the canonical chain.
   *
   * @return The hash of the head of the chain.
   */
  Hash getChainHeadHash();

  /**
   * Returns the header for the current chain head.
   *
   * @return the header for the current chain head
   */
  default BlockHeader getChainHeadHeader() {
<span class="nc" id="L74">    return getBlockHeader(getChainHeadHash())</span>
<span class="nc" id="L75">        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing chain head header.&quot;));</span>
  }

  default Block getChainHeadBlock() {
<span class="nc" id="L79">    final Hash chainHeadHash = getChainHeadHash();</span>
<span class="nc" id="L80">    final BlockHeader header =</span>
<span class="nc" id="L81">        getBlockHeader(chainHeadHash)</span>
<span class="nc" id="L82">            .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing chain head header.&quot;));</span>
<span class="nc" id="L83">    final BlockBody body =</span>
<span class="nc" id="L84">        getBlockBody(chainHeadHash)</span>
<span class="nc" id="L85">            .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing chain head body.&quot;));</span>
<span class="nc" id="L86">    return new Block(header, body);</span>
  }

  default Block getGenesisBlock() {
<span class="fc" id="L90">    final Hash genesisHash =</span>
<span class="fc" id="L91">        getBlockHashByNumber(BlockHeader.GENESIS_BLOCK_NUMBER)</span>
<span class="pc" id="L92">            .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing genesis block.&quot;));</span>
<span class="fc" id="L93">    return getBlockByHash(genesisHash)</span>
<span class="pc" id="L94">        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing genesis block.&quot;));</span>
  }

  default BlockHeader getGenesisBlockHeader() {
<span class="fc" id="L98">    return getBlockHeader(BlockHeader.GENESIS_BLOCK_NUMBER)</span>
<span class="pc" id="L99">        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing genesis block header.&quot;));</span>
  }

  default Optional&lt;Block&gt; getBlockByHash(final Hash blockHash) {
<span class="fc" id="L103">    return getBlockHeader(blockHash)</span>
<span class="fc" id="L104">        .flatMap(header -&gt; getBlockBody(blockHash).map(body -&gt; new Block(header, body)));</span>
  }

  default Optional&lt;Block&gt; getBlockByNumber(final long number) {
<span class="fc" id="L108">    return getBlockHashByNumber(number).flatMap(this::getBlockByHash);</span>
  }

  /**
   * Checks whether the block corresponding to the given hash is on the canonical chain.
   *
   * @param blockHeaderHash The hash of the block to check.
   * @return true if the block corresponding to the hash is on the canonical chain.
   */
  default boolean blockIsOnCanonicalChain(final Hash blockHeaderHash) {
<span class="fc" id="L118">    return getBlockHeader(blockHeaderHash)</span>
<span class="fc" id="L119">        .flatMap(h -&gt; getBlockHashByNumber(h.getNumber()))</span>
<span class="fc" id="L120">        .filter(h -&gt; h.equals(blockHeaderHash))</span>
<span class="fc" id="L121">        .isPresent();</span>
  }

  /**
   * Returns the block header corresponding to the given block number on the canonical chain.
   *
   * @param blockNumber The reference block number whose header we want to retrieve.
   * @return The block header corresponding to this block number.
   */
  Optional&lt;BlockHeader&gt; getBlockHeader(long blockNumber);

  /**
   * Return true if the block corresponding the hash is present.
   *
   * @param blockHash The hash of the block to check.
   * @return true if the block is tracked.
   */
  default boolean contains(final Hash blockHash) {
<span class="fc" id="L139">    return getBlockHeader(blockHash).isPresent();</span>
  }

  /**
   * Returns the block header corresponding to the given block hash. Associated block is not
   * necessarily on the canonical chain.
   *
   * @param blockHeaderHash The hash of the block whose header we want to retrieve.
   * @return The block header corresponding to this block hash.
   */
  Optional&lt;BlockHeader&gt; getBlockHeader(Hash blockHeaderHash);

  /**
   * Safe version of {@code getBlockHeader} (it should take any locks necessary to ensure any block
   * updates that might be taking place have been completed first)
   *
   * @param blockHeaderHash The hash of the block whose header we want to retrieve.
   * @return The block header corresponding to this block hash.
   */
  Optional&lt;BlockHeader&gt; getBlockHeaderSafe(Hash blockHeaderHash);

  /**
   * Returns the block body corresponding to the given block header hash. Associated block is not
   * necessarily on the canonical chain.
   *
   * @param blockHeaderHash The block header hash identifying the block whose body should be
   *     returned.
   * @return The block body corresponding to the target block.
   */
  Optional&lt;BlockBody&gt; getBlockBody(Hash blockHeaderHash);

  /**
   * Given a block's hash, returns the list of transaction receipts associated with this block's
   * transactions. Associated block is not necessarily on the canonical chain.
   *
   * @param blockHeaderHash The header hash of the block we're querying.
   * @return The transaction receipts corresponding to block hash.
   */
  Optional&lt;List&lt;TransactionReceipt&gt;&gt; getTxReceipts(Hash blockHeaderHash);

  /**
   * Retrieves the header hash of the block at the given height in the canonical chain.
   *
   * @param number The height of the block whose hash should be retrieved.
   * @return The hash of the block at the given height.
   */
  Optional&lt;Hash&gt; getBlockHashByNumber(long number);

  /**
   * Returns the total difficulty (cumulative difficulty up to and including the target block) of
   * the block corresponding to the given hash. Associated block is not necessarily on the canonical
   * chain.
   *
   * @param blockHeaderHash The hash of the block header being queried.
   * @return The total difficulty of the corresponding block.
   */
  Optional&lt;Difficulty&gt; getTotalDifficultyByHash(Hash blockHeaderHash);

  /**
   * Given a transaction hash, returns the location (block number and transaction index) of the
   * hashed transaction on the canonical chain.
   *
   * @param transactionHash A transaction hash.
   * @return The location of the hashed transaction.
   */
  Optional&lt;Transaction&gt; getTransactionByHash(Hash transactionHash);

  /**
   * Returns the transaction location associated with the corresponding hash.
   *
   * @param transactionHash A transaction hash.
   * @return The transaction location associated with the corresponding hash.
   */
  Optional&lt;TransactionLocation&gt; getTransactionLocation(Hash transactionHash);

  /**
   * Adds an observer that will get called when a new block is added.
   *
   * &lt;p&gt;&lt;i&gt;No guarantees are made about the order in which observers are invoked.&lt;/i&gt;
   *
   * @param observer the observer to call
   * @return the observer ID that can be used to remove it later.
   */
  long observeBlockAdded(BlockAddedObserver observer);

  /**
   * Adds an observer that will get called on for every added and removed log when a new block is
   * added.
   *
   * &lt;p&gt;&lt;i&gt;No guarantees are made about the order in which the observers are invoked.&lt;/i&gt;
   *
   * @param logObserver the observer to call
   * @return the observer ID that can be used to remove it later.
   */
  default long observeLogs(final Consumer&lt;LogWithMetadata&gt; logObserver) {
<span class="fc" id="L234">    return observeBlockAdded((event -&gt; event.getLogsWithMetadata().forEach(logObserver)));</span>
  }

  /**
   * Removes a previously added observer of any type.
   *
   * @param observerId the ID of the observer to remove
   * @return {@code true} if the observer was removed; otherwise {@code false}
   */
  boolean removeObserver(long observerId);

  /**
   * Adds an observer that will get called when a new block is added after reorg.
   *
   * &lt;p&gt;&lt;i&gt;No guarantees are made about the order in which observers are invoked.&lt;/i&gt;
   *
   * @param observer the observer to call
   * @return the observer ID that can be used to remove it later.
   */
  long observeChainReorg(ChainReorgObserver observer);

  /**
   * Removes a previously added {@link ChainReorgObserver}.
   *
   * @param observerId the ID of the observer to remove
   * @return {@code true} if the observer was removed; otherwise {@code false}
   */
  boolean removeChainReorgObserver(long observerId);

  /**
   * Gets the current block choice rule. When presented with two block headers indicate which chain
   * is preferred. greater than zero: the first chain is preferred, less than zero: the second chain
   * is preferred, or zero: no preference.
   *
   * @return The preferred block header
   */
  Comparator&lt;BlockHeader&gt; getBlockChoiceRule();

  /**
   * Sets the current fork choice rule. When presented with two block headers indicate which chain
   * is more preferred. greater than zero: the first chain is more preferred, less than zero: the
   * second chain is more preferred, or zero: no preference.
   *
   * @param blockChoiceRule The new fork choice rule.
   */
  void setBlockChoiceRule(Comparator&lt;BlockHeader&gt; blockChoiceRule);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>