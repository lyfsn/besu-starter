<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FutureUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">besu</a> &gt; <a href="index.source.html" class="el_package">org.hyperledger.besu.util</a> &gt; <span class="el_source">FutureUtils.java</span></div><h1>FutureUtils.java</h1><pre class="source lang-java linenums">/*
 * Copyright ConsenSys AG.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */
package org.hyperledger.besu.util;

import static java.util.concurrent.CompletableFuture.completedFuture;

import java.util.concurrent.CancellationException;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import java.util.function.Function;
import java.util.function.Supplier;

/** The Future utils. */
<span class="nc" id="L26">public class FutureUtils {</span>

  /**
   * Returns a new CompletionStage that, when the provided stage completes exceptionally, is
   * executed with the provided stage's exception as the argument to the supplied function.
   * Otherwise the returned stage completes successfully with the same value as the provided stage.
   *
   * &lt;p&gt;This is the exceptional equivalent to {@link CompletionStage#thenCompose(Function)}
   *
   * @param &lt;T&gt; the type of the CompletionStage's result
   * @param future the future to handle results or exceptions from
   * @param errorHandler the function returning a new CompletionStage
   * @return the CompletionStage
   */
  public static &lt;T&gt; CompletableFuture&lt;T&gt; exceptionallyCompose(
      final CompletableFuture&lt;T&gt; future,
      final Function&lt;Throwable, CompletionStage&lt;T&gt;&gt; errorHandler) {
<span class="fc" id="L43">    final CompletableFuture&lt;T&gt; result = new CompletableFuture&lt;&gt;();</span>
<span class="fc" id="L44">    future.whenComplete(</span>
        (value, error) -&gt; {
          try {
            final CompletionStage&lt;T&gt; nextStep =
<span class="fc bfc" id="L48" title="All 2 branches covered.">                error != null ? errorHandler.apply(error) : completedFuture(value);</span>
<span class="fc" id="L49">            propagateResult(nextStep, result);</span>
<span class="fc" id="L50">          } catch (final Throwable t) {</span>
<span class="fc" id="L51">            result.completeExceptionally(t);</span>
<span class="fc" id="L52">          }</span>
<span class="fc" id="L53">        });</span>
<span class="fc" id="L54">    return result;</span>
  }

  /**
   * Propagates the result of one {@link CompletionStage} to a different {@link CompletableFuture}.
   *
   * &lt;p&gt;When &lt;code&gt;from&lt;/code&gt; completes successfully, &lt;code&gt;to&lt;/code&gt; will be completed
   * successfully with the same value. When &lt;code&gt;from&lt;/code&gt; completes exceptionally, &lt;code&gt;to
   * &lt;/code&gt; will be completed exceptionally with the same exception.
   *
   * @param &lt;T&gt; the type of the success value
   * @param from the CompletionStage to take results and exceptions from
   * @param to the CompletableFuture to propagate results and exceptions to
   */
  public static &lt;T&gt; void propagateResult(
      final CompletionStage&lt;T&gt; from, final CompletableFuture&lt;T&gt; to) {
<span class="fc" id="L70">    from.whenComplete(</span>
        (value, error) -&gt; {
<span class="fc bfc" id="L72" title="All 2 branches covered.">          if (error != null) {</span>
<span class="fc" id="L73">            to.completeExceptionally(error);</span>
          } else {
<span class="fc" id="L75">            to.complete(value);</span>
          }
<span class="fc" id="L77">        });</span>
<span class="fc" id="L78">  }</span>

  /**
   * Propagates the result of the {@link CompletableFuture} returned from a {@link Supplier} to a
   * different {@link CompletableFuture}.
   *
   * &lt;p&gt;When &lt;code&gt;from&lt;/code&gt; completes successfully, &lt;code&gt;to&lt;/code&gt; will be completed
   * successfully with the same value. When &lt;code&gt;from&lt;/code&gt; completes exceptionally, &lt;code&gt;to
   * &lt;/code&gt; will be completed exceptionally with the same exception.
   *
   * &lt;p&gt;If the Supplier throws an exception, the target CompletableFuture will be completed
   * exceptionally with the thrown exception.
   *
   * @param &lt;T&gt; the type of the success value
   * @param from the Supplier to get the CompletableFuture to take results and exceptions from
   * @param to the CompletableFuture to propagate results and exceptions to
   */
  public static &lt;T&gt; void propagateResult(
      final Supplier&lt;CompletableFuture&lt;T&gt;&gt; from, final CompletableFuture&lt;T&gt; to) {
    try {
<span class="fc" id="L98">      propagateResult(from.get(), to);</span>
<span class="nc" id="L99">    } catch (final Throwable t) {</span>
<span class="nc" id="L100">      to.completeExceptionally(t);</span>
<span class="fc" id="L101">    }</span>
<span class="fc" id="L102">  }</span>

  /**
   * Propagates cancellation, and only cancellation, from one future to another.
   *
   * &lt;p&gt;When &lt;code&gt;from&lt;/code&gt; is completed with a {@link
   * java.util.concurrent.CancellationException}* {@link
   * java.util.concurrent.Future#cancel(boolean)} will be called on &lt;code&gt;to&lt;/code&gt;, allowing
   * interruption if the future is currently running.
   *
   * @param from the CompletableFuture to take cancellation from
   * @param to the CompletableFuture to propagate cancellation to
   */
  public static void propagateCancellation(
      final CompletableFuture&lt;?&gt; from, final CompletableFuture&lt;?&gt; to) {
<span class="fc" id="L117">    from.exceptionally(</span>
        error -&gt; {
<span class="fc bfc" id="L119" title="All 2 branches covered.">          if (error instanceof CancellationException) {</span>
<span class="fc" id="L120">            to.cancel(true);</span>
          }
<span class="fc" id="L122">          return null;</span>
        });
<span class="fc" id="L124">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>